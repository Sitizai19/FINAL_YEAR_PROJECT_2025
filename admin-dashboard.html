<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Pet Care Management</title>
    <!-- Cache bust: Updated chat interface with sticky input and hover effects -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Poppins", sans-serif;
            background-color: #f8f9fa;
            color: #2d3748;
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }
        
        /* Admin Dashboard Container */
        .admin-dashboard-container {
            display: flex;
            min-height: 100vh;
            background-color: #f8f9fa;
        }
        
        /* Enhanced Left Sidebar */
        .admin-sidebar {
            width: 280px;
            background-color: #1a1a1a;
            border-right: 1px solid #333;
            padding: 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .enhanced-sidebar {
            background: linear-gradient(180deg, #1a1a1a 0%, #2d2d2d 100%);
        }
        
        .enhanced-header {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .admin-logo {
            display: flex;
            align-items: center;
        }

        .logo-image {
            max-width: 120px;
            max-height: 60px;
            width: auto;
            height: auto;
            object-fit: contain;
        }

        .admin-title {
            flex: 1;
            text-align: center;
        }

        .admin-title h1 {
            font-size: 1.2rem;
            font-weight: 700;
            color: #ffffff;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .admin-subtitle {
            color: #a0aec0;
            font-size: 0.85rem;
            margin: 0;
            font-weight: 400;
            text-align: center;
        }
        
        .enhanced-nav {
            flex: 1;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }
        
        .nav-list {
            list-style: none;
            margin: 0;
            padding: 0;
            flex: 1;
        }
        
        .nav-item {
            margin-bottom: 0.5rem;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            text-decoration: none;
            color: #ffffff;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.95rem;
            position: relative;
        }
        
        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }
        
        .nav-item.active .nav-link {
            background-color: #ffffff;
            color: #1a1a1a;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .nav-link i {
            margin-right: 1rem;
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }
        
        .nav-indicator {
            width: 8px;
            height: 8px;
            background-color: #1a1a1a;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .nav-item.active .nav-indicator {
            opacity: 1;
        }
        
        /* Sidebar Footer */
        .sidebar-footer {
            margin-top: auto;
            padding: 1rem;
            border-top: 1px solid #333;
        }

        .enhanced-signout {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1rem;
            text-decoration: none;
            color: #ffffff;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.9rem;
            background: transparent;
            border: 1px solid #444;
            width: 100%;
            cursor: pointer;
            margin-bottom: 1rem;
        }
        
        .enhanced-signout:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: #666;
        }
        
        .enhanced-signout i {
            margin-right: 0.5rem;
            width: 16px;
            text-align: center;
            font-size: 0.9rem;
        }

        .admin-account {
            text-align: center;
        }

        .account-label {
            color: #a0aec0;
            font-size: 0.8rem;
            margin: 0 0 0.5rem 0;
            font-weight: 400;
        }

        .account-email {
            background-color: #2d2d2d;
            color: #ffffff;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            border: 1px solid #444;
        }
        
        /* Right Content Area */
        .admin-main-content {
            flex: 1;
            margin-left: 280px;
            padding: 0;
            background-color: #f8f9fa;
            overflow-x: auto;
            min-width: 0;
        }
        
        /* Header Section */
        .main-header {
            background: #ffffff;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Standardized Search Bar Styling */
        .standard-search-container {
            position: relative;
            flex: 1;
            min-width: 200px;
            max-width: 400px;
        }

        .standard-search-input {
            width: 100%;
            padding: 0.75rem 3rem 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9rem;
            background: #ffffff;
            transition: all 0.3s ease;
            line-height: 1.4;
            box-sizing: border-box;
        }

        .standard-search-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .standard-search-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #a0aec0;
            font-size: 0.9rem;
            pointer-events: none;
        }

        .standard-clear-icon {
            position: absolute;
            right: 2.5rem;
            top: 50%;
            transform: translateY(-50%);
            color: #a0aec0;
            cursor: pointer;
            font-size: 0.8rem;
            transition: color 0.2s ease;
            display: none;
        }

        .standard-clear-icon:hover {
            color: #374151;
        }
        
        .header-icons {
            display: flex;
            gap: 0.75rem;
        }
        
        .header-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .header-icon:hover {
            background: #e5e7eb;
            color: #374151;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.25rem;
            background: #3b82f6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.3), 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        
        .user-profile:hover {
            background: #2563eb;
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.4), 0 0 0 2px rgba(37, 99, 235, 0.2);
        }
        
        .user-profile i {
            color: #ffffff;
            font-size: 1rem;
        }
        
        .user-profile span {
            color: #ffffff;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        /* Content Area */
        .content-area {
            padding: 2rem;
            overflow-x: auto;
            min-width: 0;
        }
        
        /* Content Sections */
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        
        .enhanced-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
            padding: 0;
        }

        .header-content {
            flex: 1;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .header-title i {
            color: #3b82f6;
            font-size: 1.5rem;
        }
        
        .header-title h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
            margin: 0;
        }
        
        .header-subtitle {
            color: #718096;
            font-size: 0.9rem;
            margin: 0;
            font-weight: 400;
        }
        
        .enhanced-add-btn {
            background-color: #1a1a1a;
            color: #ffffff;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .enhanced-add-btn:hover {
            background-color: #2d2d2d;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .enhanced-add-btn i {
            font-size: 0.8rem;
        }
        
        /* Services List */
        .services-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .service-card {
            background-color: #ffffff;
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.5rem;
        }
        
        .service-image {
            width: 80px;
            height: 80px;
            margin-right: 1rem;
            flex-shrink: 0;
            border-radius: 6px;
            overflow: hidden;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .service-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .service-image .no-image {
            color: #a0aec0;
            font-size: 1.5rem;
        }
        
        .service-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
            transform: translateY(-2px);
        }
        
        .service-info {
            flex: 1;
        }
        
        .service-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2d3748;
            margin: 0 0 0.5rem 0;
        }
        
        .service-description {
            color: #718096;
            margin: 0 0 0.75rem 0;
            line-height: 1.4;
            font-size: 0.9rem;
        }
        
        .service-categories {
            margin: 0.75rem 0;
        }

        .category-item {
            margin: 0.25rem 0;
            font-size: 0.85rem;
            color: #4a5568;
        }

        .service-notes {
            margin: 0.5rem 0;
            font-size: 0.85rem;
            color: #4a5568;
            line-height: 1.4;
        }
        
        .service-details {
            display: flex;
            gap: 1.5rem;
            font-size: 0.9rem;
            color: #4a5568;
            margin-top: 1rem;
        }
        
        /* Service Pricing Styles */
        .service-pricing {
            margin: 1rem 0;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }

        .pricing-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            color: #2d3748;
            font-size: 0.9rem;
        }

        .pricing-content {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .price-item-single,
        .price-item-multiple {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background-color: #ffffff;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .price-item-single {
            border-left: 3px solid #10b981;
        }

        .price-item-multiple {
            border-left: 3px solid #f59e0b;
        }

        .price-amount {
            font-weight: 600;
            color: #1f2937;
            font-size: 1rem;
        }

        .price-category {
            color: #6b7280;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .price-item-more {
            text-align: center;
            padding: 0.5rem;
            background-color: #f3f4f6;
            border-radius: 6px;
            border: 1px dashed #d1d5db;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .price-item-more:hover {
            background-color: #e5e7eb;
        }

        .more-count {
            color: #6b7280;
            font-size: 0.85rem;
            font-style: italic;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .more-count:hover {
            color: #3b82f6;
        }

        .more-prices-details {
            margin-top: 0.5rem;
            padding-left: 1rem;
            border-left: 2px solid #e5e7eb;
        }

        .no-price {
            color: #ef4444;
            font-style: italic;
        }
        
        .price, .duration {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .detail-icon {
            width: 32px;
            height: 32px;
            background-color: #1a1a1a;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            font-size: 0.8rem;
        }
        
        .service-actions {
            display: flex;
            gap: 0.5rem;
            margin-left: 1rem;
        }
        
        .action-btn {
            background: none;
            border: none;
            padding: 0.4rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #718096;
            font-size: 0.9rem;
        }
        
        .action-btn:hover {
            background-color: #f8f9fa;
            color: #2d3748;
        }
        
        .edit-btn:hover {
            color: #2b6cb0;
        }
        
        .delete-btn:hover {
            color: #e53e3e;
        }
        
        .receipt-btn {
            color: #38a169;
        }
        
        .receipt-btn:hover {
            color: #2f855a;
        }
        
        .notes-btn {
            color: #d69e2e;
        }
        
        .notes-btn:hover {
            color: #b7791f;
        }
        
        /* Notes Modal Styles */
        .image-upload-container {
            position: relative;
        }
        
        .image-preview {
            margin-top: 1rem;
            position: relative;
            display: inline-block;
        }
        
        .image-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }
        
        .remove-image-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .remove-image-btn:hover {
            background: #dc2626;
        }
        
        .existing-images-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 0.5rem;
        }
        
        .existing-image-item {
            position: relative;
            display: inline-block;
        }
        
        .existing-image-item img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }
        
        .existing-image-item .delete-image-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.7rem;
        }
        
        .existing-image-item .delete-image-btn:hover {
            background: #dc2626;
        }
        
        /* Search Container Fix */
        .booking-filters {
            overflow: hidden;
        }
        
        .booking-filters .search-container {
            overflow: hidden;
            min-width: 0;
        }
        
        .booking-filters input[type="text"] {
            max-width: 100%;
            box-sizing: border-box;
        }
        
        /* Bookings Table */
        .bookings-table-container {
            background: #ffffff;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            overflow-x: auto;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .bookings-table {
            width: 100%;
            min-width: 1200px;
            border-collapse: collapse;
        }
        
        .bookings-table th {
            background-color: #f8fafc;
            padding: 1.25rem 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .bookings-table td {
            padding: 1.25rem 1rem;
            border-bottom: 1px solid #f3f4f6;
            color: #4b5563;
            font-size: 0.9rem;
        }
        
        .bookings-table tr:hover {
            background-color: #f8fafc;
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-badge.confirmed {
            background-color: #f0f9ff;
            color: #0369a1;
        }
        
        .status-badge.pending {
            background-color: #fef3c7;
            color: #d97706;
        }
        
        .status-badge.failed {
            background-color: #fee2e2;
            color: #dc2626;
        }

        .status-badge.completed {
            background-color: #f0f9ff;
            color: #0369a1;
        }

        .status-badge.cancelled {
            background-color: #fee2e2;
            color: #dc2626;
        }

        /* Payment Method Badges */
        .payment-method-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .payment-method-badge.online_banking {
            background-color: #f0f9ff;
            color: #0369a1;
        }

        .payment-method-badge.card {
            background-color: #fef3c7;
            color: #d97706;
        }

        .payment-method-badge.ewallet {
            background-color: #f0fdf4;
            color: #16a34a;
        }

        .payment-method-badge.fpx {
            background-color: #fef3c7;
            color: #d97706;
        }
        
        /* Live Chat */
        .chat-container {
            display: flex;
            height: calc(100vh - 200px);
            max-height: 700px;
            border: 1px solid #f0f0f0;
            border-radius: 8px;
            overflow: hidden;
            background-color: #ffffff;
        }
        
        .chat-sidebar {
            width: 300px;
            background-color: #f8f9fa;
            border-right: 1px solid #f0f0f0;
            display: flex;
            flex-direction: column;
        }
        
        .chat-search {
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 0.5rem 2rem 0.5rem 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9rem;
            background-color: #ffffff;
        }
        
        .search-icon {
            position: absolute;
            right: 1.5rem;
            top: 50%;
            transform: translateY(-50%);
            color: #a0aec0;
            font-size: 0.8rem;
        }
        
        .conversations-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .conversation-item {
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .conversation-item:hover {
            background-color: #ffffff;
        }
        
        .conversation-item.active {
            background-color: #ffffff;
            border-right: 3px solid #2d3748;
        }
        
        .conversation-info h4 {
            font-size: 0.9rem;
            font-weight: 600;
            color: #2d3748;
            margin: 0 0 0.25rem 0;
        }
        
        .conversation-info p {
            font-size: 0.8rem;
            color: #718096;
            margin: 0;
            line-height: 1.3;
        }
        
        .conversation-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.5rem;
        }
        
        .time {
            font-size: 0.75rem;
            color: #a0aec0;
        }
        
        .unread-badge {
            background-color: #2d3748;
            color: #ffffff;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            height: 100%;
            position: relative;
        }
        
        .chat-header {
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
            flex-shrink: 0;
            background-color: #ffffff;
        }
        
        .chat-header h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #2d3748;
            margin: 0;
        }
        
        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            height: calc(100% - 120px);
            padding-bottom: 80px; /* Space for sticky input */
        }
        
        .message {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.4;
            position: relative;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .message:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .message:hover::after {
            content: "Click to reply";
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2d3748;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            white-space: nowrap;
            z-index: 20;
            opacity: 0.9;
        }
        
        .user-message:hover::after {
            background-color: #4a5568;
        }
        
        .user-message {
            background-color: #f8f9fa;
            color: #2d3748;
            align-self: flex-start;
        }
        
        .admin-message {
            background-color: #2d3748;
            color: #ffffff;
            align-self: flex-end;
        }
        
        .message-time {
            font-size: 0.7rem;
            color: #a0aec0;
            margin-top: 0.25rem;
            display: block;
        }
        
        .chat-input {
            padding: 1rem;
            border-top: 2px solid #4299e1;
            display: flex;
            gap: 0.5rem;
            background-color: #f8fafc;
            position: sticky;
            bottom: 0;
            z-index: 10;
            flex-shrink: 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .message-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        .message-input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        
        .message-input:disabled {
            background-color: #f7fafc;
            color: #a0aec0;
            cursor: not-allowed;
        }
        
        .send-btn {
            background-color: #4299e1;
            color: #ffffff;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(66, 153, 225, 0.3);
        }
        
        .send-btn:hover {
            background-color: #3182ce;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(66, 153, 225, 0.4);
        }
        
        .send-btn:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Cat Hotel Rooms UI */
        .hotel-legend {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 0.5rem 0 1rem 0;
            color: #4a5568;
            font-size: 0.85rem;
        }
        .legend-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 0.35rem;
        }
        .legend-available { background-color: #10b981; }
        .legend-occupied { background-color: #ef4444; }
        .legend-maintenance { background-color: #f59e0b; }

        .room-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
        }
        .room-card {
            height: 120px;
            border-radius: 12px;
            border: 2px solid #a7f3d0; /* default green border */
            background: #ecfdf5; /* default light green */
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.2s ease;
        }
        .room-card:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
        .room-id { color: #065f46; font-weight: 600; font-size: 0.95rem; }
        .room-badge { position: absolute; top: 8px; right: 8px; font-size: 0.7rem; padding: 2px 6px; border-radius: 999px; color: #111827; background: #f3f4f6; }
        .room-card.available { border-color: #34d399; background: #ecfdf5; }
        .room-card.occupied { border-color: #fecaca; background: #fef2f2; }
        .room-card.maintenance { border-color: #fde68a; background: #fffbeb; }
        .room-capacity { position: absolute; bottom: 8px; left: 8px; font-size: 0.7rem; color: #6b7280; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; padding: 2px 6px; }
        .room-note { position: absolute; bottom: 8px; right: 8px; max-width: 60%; font-size: 0.7rem; color: #374151; background: #fff; border: 1px solid #e5e7eb; border-radius: 6px; padding: 2px 6px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        
        .summary-card {
            background-color: #ffffff;
            border: 1px solid #f0f0f0;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
        }
        
        .summary-card h3 {
            font-size: 0.9rem;
            font-weight: 500;
            color: #718096;
            margin: 0 0 0.5rem 0;
        }
        
        .summary-card .amount {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
            margin: 0;
        }
        
        .payment-controls {
            margin-bottom: 2rem;
        }
        
        .search-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .search-box {
            position: relative;
            flex: 1;
        }
        
        .search-box .search-input {
            width: 100%;
            padding: 0.75rem 2.5rem 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .search-box .search-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #a0aec0;
        }
        
        .status-filter {
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9rem;
            background-color: #ffffff;
        }
        
        .export-btn {
            background-color: #2d3748;
            color: #ffffff;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .export-btn:hover {
            background-color: #1a202c;
        }
        
        /* Body scroll lock when modal is open */
        body.modal-open {
            overflow: hidden !important;
            /* Remove position: fixed to prevent scroll jump */
            /* position: fixed !important; */
            /* width: 100% !important; */
        }
        
        /* Modal Styles - Updated for wider forms - Cache Bust: 2024-01-17 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            position: relative;
            background: #ffffff;
            border-radius: 12px;
            padding: 0;
            max-width: 720px;
            width: 95%;
            min-width: auto;
            max-height: 95vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            display: flex;
            flex-direction: column;
        }
        
        /* Force wider modal - Override any conflicting styles */
        #addServiceModal .modal-content,
        #editServiceModal .modal-content {
            max-width: 750px !important;
            width: 95% !important;
            min-width: 600px !important;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        #addServiceModal .form-content,
        #editServiceModal .form-content {
            gap: 1rem !important;
            padding: 1rem !important;
            grid-template-columns: 1fr !important;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: #2d3748;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.25rem;
            color: #718096;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            background-color: #f8f9fa;
            color: #2d3748;
        }
        
        .modal form {
            padding: 1.5rem;
        }
        
        .modal .form-group {
            margin-bottom: 1.5rem;
        }
        
        .modal .form-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }
        
        .modal .form-group input,
        .modal .form-group textarea,
        .modal .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9rem;
            background-color: #ffffff;
            color: #2d3748;
            transition: all 0.2s ease;
        }
        
        .modal .form-group input:focus,
        .modal .form-group textarea:focus,
        .modal .form-group select:focus {
            outline: none;
            border-color: #2d3748;
            box-shadow: 0 0 0 3px rgba(45, 55, 72, 0.1);
        }
        
        .modal .form-group textarea {
            resize: vertical;
            min-height: 100px;
            max-height: 200px;
            font-family: inherit;
            line-height: 1.5;
        }
        
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #f0f0f0;
        }
        
        .btn-cancel {
            background-color: #f8f9fa;
            color: #718096;
            border: 1px solid #e2e8f0;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            height: auto;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-cancel:hover {
            background-color: #e2e8f0;
            color: #2d3748;
        }
        
        .btn-save {
            background-color: #2d3748;
            color: #ffffff;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            height: auto;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-save:hover {
            background-color: #1a202c;
        }
        
        .btn-delete {
            background-color: #dc2626;
            color: #ffffff;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            height: auto;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .btn-delete:hover {
            background-color: #b91c1c;
        }
        
        /* Enhanced Modal Styles */
        .enhanced-modal {
            max-width: 700px;
            width: 95%;
        }

        .modal-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-title i {
            color: #3b82f6;
            font-size: 1.2rem;
        }

        .enhanced-form {
            padding: 0;
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .form-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
            padding: 0.75rem;
            flex: 1;
            min-width: auto;
            width: 100%;
            box-sizing: border-box;
        }

        .form-left-column {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-right-column {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        .form-group label i {
            color: #3b82f6;
            width: 16px;
        }

        .required {
            color: #e53e3e;
            font-weight: bold;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
            background-color: #ffffff;
            color: #2d3748;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group input.error,
        .form-group textarea.error,
        .form-group select.error {
            border-color: #e53e3e;
            box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.1);
        }

        /* Time Slots Selection Styles */
        .time-slots-selection {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            margin-top: 0.5rem;
        }

        .time-slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .time-slot-option {
            position: relative;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 0.75rem;
            transition: all 0.3s ease;
        }

        .time-slot-option:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }

        .slot-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .time-slot-option input[type="checkbox"] {
            position: relative;
            opacity: 1;
            width: auto;
            height: auto;
            margin: 0;
        }

        .time-slot-option input[type="checkbox"]:checked + label {
            background: none;
            border: none;
            color: #3b82f6;
            font-weight: 600;
            transform: none;
            box-shadow: none;
        }

        .time-slot-option label {
            display: block;
            padding: 0;
            background: none;
            border: none;
            text-align: left;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0;
            font-size: 0.9rem;
            color: #374151;
        }

        .slot-capacity {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .slot-capacity label {
            font-size: 0.8rem;
            color: #6b7280;
            font-weight: 500;
            margin: 0;
        }

        .slot-capacity input[type="number"] {
            width: 60px;
            padding: 0.25rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.8rem;
            text-align: center;
        }

        .slot-capacity input[type="number"]:disabled {
            background: #f3f4f6;
            color: #9ca3af;
        }

        .slot-capacity input[type="number"]:enabled {
            background: white;
            color: #374151;
        }

        .time-slot-option input[type="checkbox"]:checked ~ .slot-capacity input[type="number"] {
            background: white;
            color: #374151;
        }

        .time-slots-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            padding-top: 0.5rem;
            border-top: 1px solid #e2e8f0;
        }

        .btn-select-all,
        .btn-clear-all {
            padding: 0.5rem 1rem;
            border: 1px solid #3b82f6;
            background: white;
            color: #3b82f6;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-select-all:hover,
        .btn-clear-all:hover {
            background: #3b82f6;
            color: white;
        }

        .btn-clear-all {
            border-color: #e53e3e;
            color: #e53e3e;
        }

        .btn-clear-all:hover {
            background: #e53e3e;
            color: white;
        }

        .field-error {
            color: #e53e3e;
            font-size: 0.8rem;
            margin-top: 0.25rem;
            display: none;
        }

        .field-error.show {
            display: block;
        }

        .checkbox-group {
            margin-top: 0.5rem;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .checkbox-group input[type="checkbox"] {
            margin: 0;
            margin-top: 0.2rem;
        }

        .checkbox-label {
            font-size: 0.85rem;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            align-items: flex-start;
            gap: 0.3rem;
            line-height: 1.4;
        }

        .checkbox-label i {
            color: #3b82f6;
            margin-top: 0.1rem;
        }

        .char-counter {
            text-align: right;
            font-size: 0.8rem;
            color: #718096;
            margin-top: 0.25rem;
        }

        .char-counter.warning {
            color: #f59e0b;
        }

        .char-counter.error {
            color: #e53e3e;
        }

        .input-with-icon {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-with-icon input {
            width: 100%;
        }

        .duration-input {
            display: flex;
            gap: 0.5rem;
        }

        .duration-input input {
            flex: 1;
        }

        .duration-input select {
            flex: 0 0 120px;
        }

        /* Multiple Price Styles */
        .price-item {
            background-color: #f8f9fa;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            position: relative;
            transition: all 0.3s ease;
        }

        .price-item:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }

        .price-row {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 1.25rem;
            align-items: end;
        }

        .price-category, .price-weight, .price-amount {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .price-category label, .price-weight label, .price-amount label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #4a5568;
            margin: 0;
        }

        .price-category select, .price-weight select, .price-amount input {
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9rem;
            background-color: #ffffff;
            transition: all 0.3s ease;
        }

        .price-category select:focus, .price-weight input:focus, .price-amount input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .optional {
            font-size: 0.7rem;
            color: #9ca3af;
            font-weight: 400;
        }

        .price-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .add-price-btn, .remove-price-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .add-price-btn {
            background-color: #3b82f6;
            color: white;
        }

        .add-price-btn:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
        }

        .remove-price-btn {
            background-color: #e53e3e;
            color: white;
        }

        .remove-price-btn:hover {
            background-color: #c53030;
            transform: translateY(-1px);
        }

        .custom-category {
            margin-top: 0.5rem;
        }

        .custom-category input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9rem;
            background-color: #ffffff;
            transition: all 0.3s ease;
        }

        .custom-category input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .price-item:first-child .remove-price-btn {
            display: none;
        }

        /* Enhanced Image Upload */
        .image-upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .image-upload-area:hover {
            border-color: #3b82f6;
            background-color: #f0f9ff;
        }

        .image-upload-area.dragover {
            border-color: #3b82f6;
            background-color: #f0f9ff;
            transform: scale(1.02);
        }

        .upload-content i {
            font-size: 2rem;
            color: #3b82f6;
            margin-bottom: 0.5rem;
        }

        .upload-content p {
            margin: 0.5rem 0;
            color: #4a5568;
        }

        .upload-link {
            color: #3b82f6;
            text-decoration: underline;
            cursor: pointer;
        }

        .upload-content small {
            color: #718096;
        }

        .enhanced-preview {
            margin-top: 1rem;
        }

        .preview-container {
            position: relative;
            display: inline-block;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .preview-container img {
            width: 200px;
            height: 150px;
            object-fit: cover;
            display: block;
        }

        .preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .preview-container:hover .preview-overlay {
            opacity: 1;
        }

        .remove-image-btn,
        .change-image-btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .remove-image-btn {
            color: #e53e3e;
        }

        .change-image-btn {
            color: #3b82f6;
        }

        .remove-image-btn:hover,
        .change-image-btn:hover {
            transform: scale(1.1);
            background: white;
        }

        .image-info {
            margin-top: 0.5rem;
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #718096;
        }

        /* Availability Checkboxes */
        .availability-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }

        .checkbox-label:hover {
            background-color: #f8f9fa;
        }

        .checkbox-label input[type="checkbox"] {
            display: none;
        }

        .checkmark {
            width: 20px;
            height: 20px;
            border: 2px solid #cbd5e0;
            border-radius: 4px;
            position: relative;
            transition: all 0.3s ease;
        }

        .checkbox-label input[type="checkbox"]:checked + .checkmark {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }

        .checkbox-label input[type="checkbox"]:checked + .checkmark::after {
            content: '';
            position: absolute;
            left: 6px;
            top: 2px;
            width: 6px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        /* Enhanced Actions */
        .enhanced-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e2e8f0;
        }

        .enhanced-cancel,
        .enhanced-save {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            min-width: 120px;
            justify-content: center;
        }

        .enhanced-cancel {
            background-color: #f8f9fa;
            color: #718096;
            border: 1px solid #e2e8f0;
        }

        .enhanced-cancel:hover {
            background-color: #e2e8f0;
            color: #2d3748;
        }

        .enhanced-save {
            background-color: #3b82f6;
            color: white;
            position: relative;
        }

        .enhanced-save:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .enhanced-save:disabled {
            background-color: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background-color: #3b82f6;
            border-radius: 8px;
        }
        
        /* Image Upload Styles */
        .image-preview, .current-image {
            margin-top: 1rem;
            position: relative;
            display: inline-block;
        }
        
        .image-preview img, .current-image img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        
        .remove-image-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #e53e3e;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.2s ease;
        }
        
        .remove-image-btn:hover {
            background-color: #c53030;
        }
        
        .current-image {
            background-color: #f8f9fa;
            padding: 0.75rem;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        
        .current-image span {
            display: block;
            font-size: 0.8rem;
            color: #718096;
            margin-bottom: 0.5rem;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .admin-sidebar {
                width: 250px;
            }
            
            .admin-main-content {
                margin-left: 250px;
            }
            
            .content-area {
                padding: 1rem;
            }
            
            .content-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .content-header h2 {
                font-size: 1.5rem;
            }
            
            .service-card {
                flex-direction: column;
                gap: 1rem;
            }
            
            .service-actions {
                margin-left: 0;
                justify-content: flex-end;
            }

            /* Modal responsive design */
            .modal-content {
                max-width: 95%;
                max-height: 90vh;
            }

            .form-content {
                grid-template-columns: 1fr;
                gap: 1rem;
                padding: 1rem;
            }

            .form-left-column,
            .form-right-column {
                gap: 1rem;
            }

            .price-row {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .price-actions {
                justify-content: center;
            }
        }
        
        @media (max-width: 480px) {
            .admin-sidebar {
                width: 100%;
                position: relative;
                height: auto;
                border-right: none;
                border-bottom: 1px solid #333;
            }
            
            .admin-main-content {
                margin-left: 0;
            }
            
            .main-header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }
            
            .search-container {
                width: 100%;
            }
            
            .header-right {
                width: 100%;
                justify-content: space-between;
            }
            
            .admin-header h1 {
                font-size: 1.25rem;
                padding: 0 1rem;
            }
            
            .nav-list {
                display: flex;
                overflow-x: auto;
                padding: 0 1rem;
            }
            
            .nav-item {
                margin-bottom: 0;
                margin-right: 0.5rem;
                flex-shrink: 0;
            }
            
            .nav-link {
                white-space: nowrap;
            }
        }

        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            min-width: 300px;
            max-width: 400px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10001;
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
            border-left: 4px solid #3b82f6;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left-color: #10b981;
        }

        .notification.error {
            border-left-color: #ef4444;
        }

        .notification.warning {
            border-left-color: #f59e0b;
        }

        .notification.info {
            border-left-color: #3b82f6;
        }

        .notification__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1rem 0.5rem 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .notification__title {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
        }

        .notification__close {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: color 0.2s;
        }

        .notification__close:hover {
            color: #374151;
        }

        .notification__message {
            margin: 0;
            padding: 0.5rem 1rem 1rem 1rem;
            color: #4b5563;
            font-size: 0.875rem;
            line-height: 1.4;
        }

        /* Notification System Styles */
        .notification-icon,
        .profile-icon {
            position: relative;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background-color 0.2s ease;
            font-size: 1.5rem;
            color: #4b5563;
        }

        .notification-icon:hover,
        .profile-icon:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }

        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .notification-dropdown {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 400px;
            max-width: 90vw;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            border: 1px solid #e5e7eb;
            z-index: 1000;
            max-height: 500px;
            overflow: hidden;
        }

        .notification-header {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
        }

        .notification-header h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #374151;
        }

        .notification-actions {
            display: flex;
            gap: 0.5rem;
        }

        .mark-all-read-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .mark-all-read-btn:hover {
            background: #2563eb;
        }

        .mark-all-read-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .clear-notifications-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .clear-notifications-btn:hover {
            background: #dc2626;
        }

        .clear-notifications-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .notification-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: background-color 0.2s ease;
            position: relative;
        }

        .notification-item:hover {
            background-color: #f8f9fa;
        }

        .notification-item.unread {
            background-color: #eff6ff;
            border-left: 4px solid #3b82f6;
        }

        .notification-item.unread::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 8px;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            background: #3b82f6;
            border-radius: 50%;
        }

        .notification-item.loading {
            text-align: center;
            color: #6b7280;
            font-style: italic;
        }

        .notification-item.empty {
            text-align: center;
            color: #6b7280;
            font-style: italic;
            padding: 2rem;
        }

        .notification-content {
            margin-left: 1rem;
        }

        .notification-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .notification-message {
            color: #6b7280;
            font-size: 0.8rem;
            line-height: 1.4;
            margin-bottom: 0.5rem;
        }

        .notification-time {
            color: #9ca3af;
            font-size: 0.75rem;
        }

        .notification-type {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .notification-type.service {
            background: #dbeafe;
            color: #1e40af;
        }

        .notification-type.hotel {
            background: #fef3c7;
            color: #92400e;
        }

        .notification-type.chat {
            background: #e0f2fe;
            color: #0369a1;
        }

        /* Chat Action Buttons */
        .conversation-actions {
            display: flex;
            gap: 0.25rem;
            margin-left: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .conversation-item:hover .conversation-actions {
            opacity: 1;
        }

        .action-btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            transform: scale(1.1);
        }

        .clear-btn {
            background: #f6ad55;
            color: white;
        }

        .clear-btn:hover {
            background: #ed8936;
        }

        .delete-btn {
            background: #fc8181;
            color: white;
        }

        .delete-btn:hover {
            background: #f56565;
        }

        /* Clear All Chats Button */
        .clear-all-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }

        .clear-all-btn:hover {
            background: #c53030;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(229, 62, 62, 0.3);
        }

        .clear-all-btn i {
            font-size: 0.875rem;
        }

        /* Enhanced Conversation Item Hover Effects */
        .conversation-item {
            transition: all 0.2s ease !important;
            position: relative;
        }

        /* Hover effects for non-active items */
        .conversation-item:not(.active):hover {
            background-color: #f7fafc !important;
            transform: translateX(2px) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
        }

        /* Active state - should always be visible and override hover */
        .conversation-item.active {
            background-color: #e6f3ff !important;
            border-right: 3px solid #3182ce !important;
            transform: translateX(2px) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
        }

        /* Active state on hover - slightly different shade */
        .conversation-item.active:hover {
            background-color: #dbeafe !important;
            transform: translateX(2px) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;
        }

        /* Ensure action buttons are visible for active items */
        .conversation-item.active .conversation-actions {
            opacity: 1 !important;
        }

        /* Admin Profile Sidebar Styles - Same as user sidebar */
        .sidebar-overlay {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0, 0, 0, 0.5) !important;
            z-index: 1000 !important;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .sidebar-panel {
            position: fixed !important;
            top: 0 !important;
            right: -500px !important;
            width: 450px !important;
            max-width: 90vw;
            height: 100% !important;
            background: #ffffff !important;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1) !important;
            z-index: 1001 !important;
            transition: all 0.3s ease;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar-panel.active {
            right: 0 !important;
        }

        .sidebar-header {
            padding: 10px 15px 8px 15px;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-header h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 700;
            color: #2d3748;
        }

        .sidebar-close {
            border: none;
            background: #f3f4f6;
            color: #6b7280;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .sidebar-close:hover {
            background: #e5e7eb;
            color: #374151;
        }

        .sidebar-body {
            padding: 0 15px 15px 15px;
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .profile-section {
            padding: 8px 0;
            display: grid;
            gap: 0.5rem;
        }

        .profile-field {
            margin-bottom: 6px;
            padding: 6px;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .profile-field label {
            display: block;
            font-weight: 600;
            font-size: 11px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 2px;
        }

        .profile-field span {
            display: block;
            font-size: 13px;
            color: #2d3748;
            font-weight: 500;
            word-break: break-word;
            line-height: 1.2;
        }

        .profile-actions {
            display: flex;
            flex-direction: row;
            gap: 0.5rem;
            margin-top: 0.4rem;
            flex-wrap: wrap;
        }

        .btn-logout,
        .btn-edit-profile,
        .btn-cancel-edit {
            padding: 0.35rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.3rem;
            font-size: 0.75rem;
            line-height: 1.2;
            flex: 1;
            min-width: 0;
        }

        .btn-logout {
            background: #ef4444;
            color: white;
        }

        .btn-logout:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-edit-profile {
            background: #3b82f6;
            color: white;
        }

        .btn-edit-profile:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-cancel-edit {
            background: #6b7280;
            color: white;
        }

        .btn-cancel-edit:hover {
            background: #4b5563;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
        }

        .profile-field input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            font-family: "Poppins", sans-serif;
        }

        .profile-field input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Profile Photo Section - Smaller */
        #admin-profile-sidebar .profile-photo-section {
            text-align: center;
            margin-bottom: 8px;
        }

        #admin-profile-sidebar .profile-photo-container {
            width: 56px !important;
            height: 56px !important;
            margin-bottom: 6px !important;
        }

        #admin-profile-sidebar .profile-photo-actions {
            gap: 4px !important;
        }

        #admin-profile-sidebar .profile-photo-actions button {
            padding: 3px 6px !important;
            font-size: 10px !important;
            border-radius: 4px !important;
        }
    </style>
</head>
<body>
    <div id="loading-screen" style="display: flex; align-items: center; justify-content: center; height: 100vh; background: white;">
        <div style="text-align: center;">
            <h2>Checking Admin Access...</h2>
            <p>Please wait while we verify your credentials.</p>
        </div>
    </div>

    <div class="admin-dashboard-container" id="dashboard-content" style="display: none;">
        <!-- Left Sidebar -->
        <div class="admin-sidebar enhanced-sidebar">
            <div class="admin-header enhanced-header">
                <div class="admin-logo">
                    <img src="assets/logo.png" alt="Pet Care Logo" class="logo-image">
                </div>
                <div class="admin-title">
                    <h1>ADMIN PORTAL</h1>
                </div>
            </div>
            
            <nav class="admin-nav enhanced-nav">
                <ul class="nav-list">
                    
                    <li class="nav-item active">
                        <a href="#" class="nav-link" data-section="bookings">
                            <i class="fas fa-calendar-alt"></i>
                            <span>Service Bookings</span>
                            <div class="nav-indicator"></div>
                        </a>
                    </li>
                    
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="hotel">
                            <i class="fas fa-bed"></i>
                            <span>Cat Hotel Slots</span>
                            <div class="nav-indicator"></div>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="services">
                            <i class="fas fa-box"></i>
                            <span>Pet Services</span>
                            <div class="nav-indicator"></div>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="chat">
                            <i class="fas fa-comments"></i>
                            <span>Live Chat</span>
                            <div class="nav-indicator"></div>
                        </a>
                    </li>
                </ul>
                
                <!-- Sign Out Button -->
                <div class="sidebar-footer">
                    <button class="signout-btn enhanced-signout" onclick="signOut()">
                    <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                </button>
                    <div class="admin-account">
                        <p class="account-label">Admin Account</p>
                        <div class="account-email" id="adminEmail">
                            <i class="fas fa-spinner fa-spin"></i> Loading...
                        </div>
                    </div>
                </div>
            </nav>
        </div>

        <!-- Right Content Area -->
        <div class="admin-main-content">
            <!-- Main Header -->
            <div class="main-header">
                <div class="header-left">
                    <!-- Search bar removed -->
                </div>
                <div class="header-right">
                    <div class="header-icons">
                        <div class="header-icon notification-icon" onclick="toggleNotificationDropdown()">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                        </div>
                        <div class="header-icon profile-icon" onclick="openAdminProfileSidebar()" title="Admin Profile">
                            <i class="fas fa-user-circle"></i>
                        </div>
                    </div>
                    
                </div>
            </div>
            
            <!-- Notification Dropdown -->
            <div id="notificationDropdown" class="notification-dropdown" style="display: none;">
                <div class="notification-header">
                    <h3>Notifications</h3>
                    <div class="notification-actions">
                        <button onclick="markAllAsRead()" class="mark-all-read-btn">Mark all as read</button>
                        <button onclick="clearAllNotifications()" class="clear-notifications-btn">Clear</button>
                    </div>
                </div>
                <div class="notification-list" id="notificationList">
                    <div class="notification-item loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Loading notifications...</span>
                    </div>
                </div>
            </div>
            
            <!-- Admin Profile Sidebar -->
            <div class="sidebar-overlay" id="admin-profile-sidebar-overlay" style="display: none;"></div>
            <aside class="sidebar-panel" id="admin-profile-sidebar" aria-hidden="true">
                <div class="sidebar-header">
                    <h3>Admin Profile</h3>
                    <button class="sidebar-close" id="admin-profile-sidebar-close" aria-label="Close Admin Profile Sidebar"><i class="fas fa-times"></i></button>
                </div>
                <div class="sidebar-body" id="admin-profile-sidebar-body">
                    <div class="profile-section">
                        <!-- Profile Photo Section -->
                        <div class="profile-photo-section" style="text-align: center; margin-bottom: 8px;">
                            <div class="profile-photo-container" style="width: 56px; height: 56px; border-radius: 50%; background: var(--card-background); display: inline-flex; align-items: center; justify-content: center; margin-bottom: 6px; overflow: hidden; box-shadow: var(--shadow-light);">
                                <img id="admin-profile-photo" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMzIiIGZpbGw9IiNGM0Y0RjYiLz4KPHBhdGggZD0iTTMyIDIwQzM2LjQxODMgMjAgNDAgMjMuNTgxNyA0MCAyOEM0MCAzMi40MTgzIDM2LjQxODMgMzYgMzIgMzZDMjcuNTgxNyAzNiAyNCAzMi40MTgzIDI0IDI4QzI0IDIzLjU4MTcgMjcuNTgxNyAyMCAzMiAyMFoiIGZpbGw9IiM5Q0EzQUYiLz4KPHBhdGggZD0iTTE2IDQ4QzE2IDQwLjI2ODcgMjIuMjY4NyAzNCAzMCAzNEgzNEM0MS43MzEzIDM0IDQ4IDQwLjI2ODcgNDggNDhWNDhIMTZaIiBmaWxsPSIjOUNBM0FGIi8+Cjwvc3ZnPgo=" alt="Admin Profile Photo" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                            <div class="profile-photo-actions" id="admin-profile-photo-actions" style="display: none; gap: 4px; justify-content: center;">
                                <button onclick="uploadAdminProfilePhoto()" style="background: #3b82f6; color: white; border: none; padding: 3px 6px; border-radius: 4px; font-size: 10px; cursor: pointer; transition: all 0.3s ease;">
                                    <i class="fas fa-upload"></i> Upload
                                </button>
                                <button onclick="deleteAdminProfilePhoto()" style="background: #ef4444; color: white; border: none; padding: 3px 6px; border-radius: 4px; font-size: 10px; cursor: pointer; transition: all 0.3s ease;">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                        
                        <div class="profile-field">
                            <label>Email Address</label>
                            <span id="admin-profile-email">Loading...</span>
                        </div>
                        <div class="profile-field">
                            <label>First Name</label>
                            <span id="admin-profile-firstname">Not provided</span>
                        </div>
                        <div class="profile-field">
                            <label>Last Name</label>
                            <span id="admin-profile-lastname">Not provided</span>
                        </div>
                        <div class="profile-field">
                            <label>Phone Number</label>
                            <span id="admin-profile-phone">Not provided</span>
                        </div>
                        <div class="profile-field">
                            <label>Address</label>
                            <span id="admin-profile-address">Not provided</span>
                        </div>
                        <div class="profile-field">
                            <label>Role</label>
                            <span id="admin-profile-role">Administrator</span>
                        </div>
                        <div class="profile-field">
                            <label>Account Status</label>
                            <span id="admin-profile-status" style="color: #10b981; font-weight: 600;">Active</span>
                        </div>
                    </div>
                    <div class="profile-actions">
                        <button class="btn-edit-profile" id="admin-btn-edit-profile" onclick="editAdminProfile()">
                            <i class="fas fa-edit"></i> Edit Profile
                        </button>
                        <button class="btn-cancel-edit" id="admin-btn-cancel-edit" onclick="cancelAdminEdit()" style="display: none;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button class="btn-logout" onclick="closeAdminProfileSidebar(); adminSignOut();">
                            <i class="fas fa-sign-out-alt"></i> Sign Out
                        </button>
                    </div>
                </div>
            </aside>
            
            <!-- Content Area -->
            <div class="content-area">
            <!-- Pet Services Section -->
            <div id="services-section" class="content-section">
                <div class="content-header enhanced-header">
                    <div class="header-content">
                        <div class="header-title">
                            
                            <h2>Catswell:  Pet Services Management</h2>
                        </div>
                        <p class="header-subtitle">Manage your pet care services and pricing</p>
                        <div id="searchResults" style="margin-top: 0.5rem; font-size: 0.85rem; color: #718096;"></div>
                    </div>
                    <button class="add-service-btn enhanced-add-btn" onclick="showAddServiceModal()">
                        <i class="fas fa-plus"></i>
                        Add Service
                    </button>
                </div>

                <!-- Services Filters -->
                <div class="booking-filters" style="margin-bottom: 2rem; padding: 1rem; background: white; border-radius: 8px; border: 1px solid #e5e7eb; overflow: hidden;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; min-width: 0;">
                        <div class="standard-search-container">
                            <input type="text" id="servicesSearchInput" placeholder="Search services by name, category, price..." class="standard-search-input">
                            <i class="fas fa-search standard-search-icon"></i>
                            <i class="fas fa-times standard-clear-icon" id="clearServicesSearchIcon" onclick="clearServicesSearch()"></i>
                        </div>
                        <select id="servicesCategoryFilter" style="padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.9rem; background: white;">
                            <option value="">All Categories</option>
                        </select>
                        <button onclick="clearServiceFilters()" style="padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: 6px; background: white; color: #718096; cursor: pointer;">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </div>

                <div class="services-list" id="servicesList">
                    <!-- Services will be loaded dynamically from database -->
                </div>
            </div>

            <!-- Bookings Section -->
            <div id="bookings-section" class="content-section active">
                <div class="content-header enhanced-header">
                    <div class="header-content">
                        <div class="header-title">
                            <i class="fas fa-calendar-alt"></i>
                            <h2>Booking Management</h2>
                        </div>
                        <p class="header-subtitle">Manage customer bookings and appointments</p>
                        <div id="bookingSearchResults" style="margin-top: 0.5rem; font-size: 0.85rem; color: #718096;"></div>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="enhanced-add-btn" onclick="refreshBookings()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                        <button class="enhanced-add-btn" onclick="exportBookings()">
                            <i class="fas fa-download"></i>
                            Export
                        </button>
                    </div>
                </div>

                <!-- Booking Filters -->
                <div class="booking-filters" style="margin-bottom: 2rem; padding: 1rem; background: white; border-radius: 8px; border: 1px solid #e5e7eb; overflow: hidden;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; min-width: 0;">
                        <div class="standard-search-container">
                            <input type="text" id="bookingSearchInput" placeholder="Search by customer name, pet name, or service..." class="standard-search-input">
                            <i class="fas fa-search standard-search-icon"></i>
                        </div>
                        <select id="bookingStatusFilter" style="padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.9rem; background: white;">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                        <input type="date" id="bookingDateFilter" style="padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.9rem;">
                        <button onclick="clearBookingFilters()" style="padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: 6px; background: white; color: #718096; cursor: pointer;">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </div>

                <!-- Bookings Table -->
                <div class="bookings-table-container">
                    <div id="bookingsLoading" style="text-align: center; padding: 2rem; color: #718096;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Loading bookings...</p>
                    </div>
                    <table class="bookings-table" id="bookingsTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Booking ID</th>
                                <th>Booking Reference</th>
                                <th>Customer</th>
                                <th>Pet</th>
                                <th>Service</th>
                                <th>Date & Time</th>
                                <th>Payment Method</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Created At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bookingsTableBody">
                            <!-- Bookings will be loaded dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Cat Hotel Slots Section -->
            <div id="hotel-section" class="content-section">
                <div class="content-header enhanced-header">
                    <div class="header-content">
                        <div class="header-title">
                            <i class="fas fa-bed"></i>
                            <h2>Cat Hotel Slots</h2>
                        </div>
                        <p class="header-subtitle">Manage room types, capacity and availability</p>
                        <div id="hotelSearchResults" style="margin-top: 0.5rem; font-size: 0.85rem; color: #718096;"></div>
                        <div class="hotel-legend">
                            <span><span class="legend-dot legend-available"></span>Available</span>
                            <span><span class="legend-dot legend-occupied"></span>Occupied</span>
                            <span><span class="legend-dot legend-maintenance"></span>Maintenance</span>
                        </div>
                    </div>
                    <div style="display:flex; gap:0.5rem;">
                        <button class="enhanced-add-btn" onclick="refreshHotelSlots()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                        <button class="enhanced-add-btn" onclick="showAddHotelRoomsModal()">
                            <i class="fas fa-plus"></i>
                            Add Rooms
                        </button>
                    </div>
                </div>

                <!-- Hotel Tabs -->
                <div class="hotel-tabs" style="margin-bottom: 2rem;">
                    <div class="tab-buttons" style="display: flex; background: white; border-radius: 8px 8px 0 0; border: 1px solid #e5e7eb; border-bottom: none;">
                        <button class="hotel-tab-btn active" onclick="switchHotelTab('rooms')" data-tab="rooms" style="flex: 1; padding: 1rem; border: none; background: #3b82f6; color: white; border-radius: 8px 0 0 0; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-bed"></i> Hotel Rooms
                        </button>
                        <button class="hotel-tab-btn" onclick="switchHotelTab('bookings')" data-tab="bookings" style="flex: 1; padding: 1rem; border: none; background: #f8f9fa; color: #6c757d; border-radius: 0 8px 0 0; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-calendar-check"></i> Hotel Bookings
                        </button>
                    </div>
                </div>

                <!-- Hotel Rooms Tab Content -->
                <div id="hotel-rooms-tab" class="hotel-tab-content active">
                    <div style="margin-bottom: 2rem; padding: 1rem; background: white; border-radius: 0 0 8px 8px; border: 1px solid #e5e7eb; border-top: none; display:flex; gap:1rem; align-items:center; flex-wrap:wrap;">
                    <div class="standard-search-container">
                        <input type="text" id="hotelSearchInput" placeholder="Search by room type or notes..." class="standard-search-input">
                        <i class="fas fa-search standard-search-icon"></i>
                    </div>
                    <select id="hotelTypeFilter" style="padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.9rem; background: white;">
                        <option value="">All Types</option>
                        <option value="classic_suite">Classic Suite</option>
                        <option value="deluxe_suite">Deluxe Suite</option>
                        <option value="executive_suite">Executive Suite</option>
                        <option value="day_care">Studio Suite</option>
                    </select>
                    <button onclick="clearHotelFilters()" style="padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: 6px; background: white; color: #718096; cursor: pointer;">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>

                <div class="bookings-table-container">
                    <div id="hotelLoading" style="text-align: center; padding: 2rem; color: #718096;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Loading cat hotel rooms...</p>
                    </div>
                    <div id="hotelRooms" style="display:none;">
                        <div id="hotelClassic" style="margin-bottom:2rem;"></div>
                        <div id="hotelDeluxe" style="margin-bottom:2rem;"></div>
                        <div id="hotelExecutive" style="margin-bottom:2rem;"></div>
                        <div id="hotelDayCare" style="margin-bottom:2rem;"></div>
                    </div>
                </div>
                </div>

                <!-- Hotel Bookings Tab Content -->
                <div id="hotel-bookings-tab" class="hotel-tab-content" style="display: none;">
                    <!-- Hotel Bookings Header -->
                    <div style="margin-bottom: 1rem; padding: 1rem; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="margin: 0; color: #2d3748; font-size: 1.2rem;">
                                    <i class="fas fa-calendar-check" style="margin-right: 0.5rem; color: #3b82f6;"></i>
                                    Hotel Bookings
                                </h3>
                                <p style="margin: 0.5rem 0 0 0; color: #718096; font-size: 0.9rem;">Manage hotel bookings and reservations</p>
                            </div>
                            <div style="display: flex; gap: 1rem;">
                                <button class="enhanced-add-btn" onclick="refreshHotelBookings()">
                                    <i class="fas fa-sync-alt"></i>
                                    Refresh
                                </button>
                                <button class="enhanced-add-btn" onclick="exportHotelBookings()">
                                    <i class="fas fa-download"></i>
                                    Export
                                </button>
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 2rem; padding: 1rem; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                            <div class="standard-search-container">
                                <input type="text" id="hotelBookingSearchInput" placeholder="Search by customer name, pet name, or room..." class="standard-search-input">
                                <i class="fas fa-search standard-search-icon"></i>
                            </div>
                            <select id="hotelBookingStatusFilter" style="padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.9rem; background: white;">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="confirmed">Confirmed</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                            <select id="hotelBookingRoomFilter" style="padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.9rem; background: white;">
                                <option value="">All Rooms</option>
                                <option value="classic_suite">Classic Suite</option>
                                <option value="deluxe_suite">Deluxe Suite</option>
                                <option value="executive_suite">Executive Suite</option>
                                <option value="day_care">Studio Suite</option>
                            </select>
                            <input type="date" id="hotelBookingDateFilter" style="padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.9rem;">
                            <button onclick="clearHotelBookingFilters()" style="padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: 6px; background: white; color: #718096; cursor: pointer;">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </div>

                    <!-- Hotel Bookings Table -->
                    <div class="bookings-table-container">
                        <div id="hotelBookingsLoading" style="text-align: center; padding: 2rem; color: #718096;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p>Loading hotel bookings...</p>
                        </div>
                        <table class="bookings-table" id="hotelBookingsTable" style="display: none;">
                            <thead>
                                <tr>
                                    <th style="width: 5%;">Booking ID</th>
                                    <th style="width: 7%;">Booking Reference</th>
                                    <th style="width: 11%;">Customer</th>
                                    <th style="width: 20%;">Pet</th>
                                    <th style="width: 5%;">Room</th>
                                    <th style="width: 6%;">Check-in</th>
                                    <th style="width: 6%;">Check-out</th>
                                    <th style="width: 4%;">Nights</th>
                                    <th style="width: 7%;">Payment Method</th>
                                    <th style="width: 6%;">Amount</th>
                                    <th style="width: 6%;">Status</th>
                                    <th style="width: 6%;">Created At</th>
                                    <th style="width: 7%;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="hotelBookingsTableBody">
                                <!-- Hotel bookings will be loaded dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Add Hotel Rooms Modal -->
            <div id="addHotelRoomsModal" class="modal" style="display:none;">
                <div class="modal-overlay" onclick="hideAddHotelRoomsModal()"></div>
                <div class="modal-content enhanced-modal" style="max-width: 420px; min-width:auto;">
                    <div class="modal-header">
                        <div class="modal-title">
                            <i class="fas fa-bed"></i>
                            <h3>Add Cat Hotel Rooms</h3>
                        </div>
                        <button class="modal-close" onclick="hideAddHotelRoomsModal()"><i class="fas fa-times"></i></button>
                    </div>
                    <form id="addHotelRoomsForm" class="enhanced-form">
                        <div class="form-content" style="grid-template-columns:1fr; min-width:auto; gap:0.5rem !important; padding:0.5rem !important; width:100%; box-sizing:border-box;">
                            <div class="form-group">
                                <label for="hotelCategorySelect" style="font-size:0.82rem;"><i class="fas fa-list"></i> CAT HOTEL CATEGORY <span class="required">*</span></label>
                                <select id="hotelCategorySelect" name="category" required style="padding:0.5rem; width:100%; max-width:100%;">
                                    <option value="">Loading...</option>
                                </select>
                                <div class="field-error" id="hotelCategoryError"></div>
                            </div>
                            <div class="form-group">
                                <label for="hotelRoomsCount" style="font-size:0.82rem;"><i class="fas fa-hashtag"></i> TOTAL ROOMS TO ADD <span class="required">*</span></label>
                                <input type="number" id="hotelRoomsCount" name="count" min="1" max="100" placeholder="e.g., 5" required style="padding:0.5rem; width:100%; max-width:100%;">
                                <div class="field-error" id="hotelRoomsCountError"></div>
                            </div>
                            <div class="form-group">
                                <label for="hotelRoomsNotes" style="font-size:0.82rem;"><i class="fas fa-sticky-note"></i> ROOM NOTES</label>
                                <textarea id="hotelRoomsNotes" name="notes" rows="3" placeholder="Optional notes for these rooms" style="padding:0.5rem; width:100%; max-width:100%;"></textarea>
                            </div>
                        </div>
                        <div class="modal-actions enhanced-actions" style="padding:0 0.5rem 0.5rem; gap:0.5rem; justify-content:flex-end;">
                            <button type="button" class="btn-cancel enhanced-cancel" onclick="hideAddHotelRoomsModal()">Cancel</button>
                            <button type="submit" class="btn-save enhanced-save">
                                <i class="fas fa-save"></i>
                                <span class="btn-text">Add</span>
                                <div class="btn-loading" style="display:none;">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    Saving...
                                </div>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Live Chat Section -->
            <div id="chat-section" class="content-section">
                <div class="content-header">
                    <h2>Live Chat</h2>
                </div>

                <div class="chat-container">
                    <div class="chat-sidebar">
                        <div class="chat-search">
                            <div class="standard-search-container">
                                <input type="text" placeholder="Search conversations..." class="standard-search-input">
                                <i class="fas fa-search standard-search-icon"></i>
                            </div>
                        </div>
                        <div class="conversations-list">
                            <!-- Conversations will be loaded dynamically from database -->
                            <div class="no-conversations" style="text-align: center; padding: 2rem; color: #718096;">
                                <i class="fas fa-comments" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                <p>No conversations yet</p>
                                <p style="font-size: 0.8rem;">Messages from users will appear here</p>
                            </div>
                        </div>
                    </div>

                    <div class="chat-main">
                        <div class="chat-header">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h3>Select a conversation</h3>
                                <button class="clear-all-btn" onclick="clearAllConversations()" title="Delete All Chats">
                                    <i class="fas fa-trash-alt"></i> Clear All Chats
                                </button>
                            </div>
                        </div>
                        <div class="chat-messages">
                            <!-- Messages will be loaded dynamically from database -->
                            <div class="no-messages" style="text-align: center; padding: 2rem; color: #718096;">
                                <i class="fas fa-comment" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                <p>Select a conversation to view messages</p>
                            </div>
                        </div>
                        <div class="chat-input">
                            <input type="text" placeholder="Type your message..." class="message-input" disabled>
                            <button class="send-btn" disabled>
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

    <!-- Add Service Modal -->
    <div id="addServiceModal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="hideAddServiceModal()"></div>
        <div class="modal-content enhanced-modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-plus-circle"></i>
                <h3>Add New Service</h3>
                </div>
                <button class="modal-close" onclick="hideAddServiceModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="addServiceForm" class="enhanced-form">
                <div class="form-content">
                    <!-- Basic Information -->
                    <div class="form-group">
                        <label for="serviceName">
                            <i class="fas fa-tag"></i>
                            Service Name
                            <span class="required">*</span>
                        </label>
                        <input type="text" id="serviceName" name="service_name" placeholder="e.g., Lion Cut" required>
                        <div class="field-error" id="serviceNameError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="serviceCategory">
                            <i class="fas fa-list"></i>
                            Service Category
                            <span class="required">*</span>
                        </label>
                        <select id="serviceCategory" name="service_category" required>
                            <option value="">Select Category</option>
                            <option value="GROOMING SERVICE">GROOMING SERVICE</option>
                            <option value="CAT HOTEL">CAT HOTEL</option>
                            <option value="A LA CARTE SERVICE">A LA CARTE SERVICE</option>
                        </select>
                        <div class="field-error" id="serviceCategoryError"></div>
                    </div>

                    <!-- Duration -->
                    <div class="form-group">
                        <label for="serviceDuration">
                            <i class="fas fa-clock"></i>
                            Duration
                        </label>
                        <div class="duration-input">
                            <input type="number" id="serviceDuration" name="duration_minutes" min="1" placeholder="60">
                            <select id="durationUnit" name="duration_unit">
                                <option value="minutes">Minutes</option>
                                <option value="hours">Hours</option>
                                <option value="days">Days</option>
                                <option value="nights">Nights</option>
                            </select>
                        </div>
                        <div class="field-error" id="serviceDurationError"></div>
                    </div>

                    <div class="form-group">
                        <label for="catHotelCategory">
                            <i class="fas fa-bed"></i>
                            CAT HOTEL CATEGORY
                        </label>
                        <select id="catHotelCategory" name="cat_hotel_category">
                            <option value="">Select Cat Hotel Category</option>
                            <option value="classic_suite">CLASSIC SUITE</option>
                            <option value="deluxe_suite">DELUXE SUITE</option>
                            <option value="executive_suite">EXECUTIVE SUITE</option>
                            <option value="day_care">STUDIO SUITE</option>
                        </select>
                        <div class="field-error" id="catHotelCategoryError"></div>
                    </div>

                    <!-- Service Prices -->
                    <div class="form-group">
                        <label for="servicePrices">
                            <i class="fas fa-dollar-sign"></i>
                            Service Prices (RM)
                            <span class="required">*</span>
                        </label>
                        <div id="priceContainer">
                            <div class="price-item" data-price-index="0">
                                <div class="price-row">
                                    <div class="price-category">
                                        <label>Pet Category</label>
                                        <select name="price_categories[]" required>
                                            <option value="">Select Category</option>
                                            <option value="GENERAL">General</option>
                                            <option value="KITTEN">Kitten</option>
                                            <option value="ADULT SHORT HAIR">Adult Short Hair</option>
                                            <option value="ADULT LONG HAIR">Adult Long Hair</option>
                                        </select>
                                    </div>
                                    <div class="price-weight">
                                        <label>Weight Range (KG) <span class="optional">(Optional)</span></label>
                                        <input type="text" name="price_weights[]" placeholder="e.g., 0-2, 2-4, 4-6, 6-8, 8-10, 10+" pattern="[0-9+\-\.\s]*" title="Only numbers, ranges (e.g., 0-2), and + symbol allowed">
                                    </div>
                                    <div class="price-amount">
                                        <label>Price (RM)</label>
                                        <input type="number" name="prices[]" step="0.01" min="0" placeholder="0.00" required>
                                    </div>
                                    <div class="price-actions">
                                        <button type="button" class="add-price-btn" onclick="addPriceRow()" title="Add Price">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="custom-category" style="display: none;">
                                    <input type="text" name="custom_categories[]" placeholder="Enter custom category name">
                                </div>
                            </div>
                        </div>
                        <div class="field-error" id="servicePricesError"></div>
                    </div>

                    <!-- Service Image -->
                    <div class="form-group">
                        <label for="serviceImage">
                            <i class="fas fa-image"></i>
                            Service Image
                        </label>
                        <div class="image-upload-area" id="imageUploadArea" style="padding: 1rem; min-height: 80px;">
                            <div class="upload-content">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Drag & drop an image here or <span class="upload-link">browse files</span></p>
                                <small>Supports: JPG, PNG, GIF (Max 5MB)</small>
                            </div>
                            <input type="file" id="serviceImage" name="image" accept="image/*" style="display: none;">
                        </div>
                        <div id="serviceImagePreview" class="image-preview enhanced-preview" style="display: none;">
                            <div class="preview-container">
                                <img id="servicePreviewImg" src="" alt="Preview">
                                <div class="preview-overlay">
                                    <button type="button" onclick="removeServiceImage()" class="remove-image-btn">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <button type="button" onclick="changeServiceImage()" class="change-image-btn">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="image-info">
                                <span id="imageFileName"></span>
                                <span id="imageFileSize"></span>
                            </div>
                        </div>
                        <div class="field-error" id="serviceImageError"></div>
                    </div>

                    <!-- Notes -->
                    <div class="form-group">
                        <label for="breedNotes">
                            <i class="fas fa-clipboard-list"></i>
                            Breed Notes
                        </label>
                        <textarea id="breedNotes" name="breed_notes" rows="2" placeholder="Special notes for specific breeds..."></textarea>
                        <div class="field-error" id="breedNotesError"></div>
                    </div>

                    <!-- Time Slot Availability -->
                    <div class="form-group">
                        <label for="timeSlotAvailability">
                            <i class="fas fa-clock"></i>
                            Available Time Slots & Capacity
                            <span class="required">*</span>
                        </label>
                        <div class="time-slots-selection">
                            <div class="time-slots-grid" id="timeSlotsGrid">
                                <div class="time-slot-option">
                                    <div class="slot-header">
                                        <input type="checkbox" id="slot_1030" name="available_time_slots[]" value="10:30 AM">
                                        <label for="slot_1030">10:30 AM</label>
                                    </div>
                                    <div class="slot-capacity">
                                        <label for="capacity_1030">Capacity:</label>
                                        <input type="number" id="capacity_1030" name="slot_capacity[10:30 AM]" min="1" max="10" value="2" disabled>
                                    </div>
                                </div>
                                <div class="time-slot-option">
                                    <div class="slot-header">
                                        <input type="checkbox" id="slot_1100" name="available_time_slots[]" value="11:00 AM">
                                        <label for="slot_1100">11:00 AM</label>
                                    </div>
                                    <div class="slot-capacity">
                                        <label for="capacity_1100">Capacity:</label>
                                        <input type="number" id="capacity_1100" name="slot_capacity[11:00 AM]" min="1" max="10" value="2" disabled>
                                    </div>
                                </div>
                                <div class="time-slot-option">
                                    <div class="slot-header">
                                        <input type="checkbox" id="slot_1200" name="available_time_slots[]" value="12:00 PM">
                                        <label for="slot_1200">12:00 PM</label>
                                    </div>
                                    <div class="slot-capacity">
                                        <label for="capacity_1200">Capacity:</label>
                                        <input type="number" id="capacity_1200" name="slot_capacity[12:00 PM]" min="1" max="10" value="2" disabled>
                                    </div>
                                </div>
                                <div class="time-slot-option">
                                    <div class="slot-header">
                                        <input type="checkbox" id="slot_100" name="available_time_slots[]" value="1:00 PM">
                                        <label for="slot_100">1:00 PM</label>
                                    </div>
                                    <div class="slot-capacity">
                                        <label for="capacity_100">Capacity:</label>
                                        <input type="number" id="capacity_100" name="slot_capacity[1:00 PM]" min="1" max="10" value="2" disabled>
                                    </div>
                                </div>
                                <div class="time-slot-option">
                                    <div class="slot-header">
                                        <input type="checkbox" id="slot_200" name="available_time_slots[]" value="2:00 PM">
                                        <label for="slot_200">2:00 PM</label>
                                    </div>
                                    <div class="slot-capacity">
                                        <label for="capacity_200">Capacity:</label>
                                        <input type="number" id="capacity_200" name="slot_capacity[2:00 PM]" min="1" max="10" value="2" disabled>
                                    </div>
                                </div>
                                <div class="time-slot-option">
                                    <div class="slot-header">
                                        <input type="checkbox" id="slot_230" name="available_time_slots[]" value="2:30 PM">
                                        <label for="slot_230">2:30 PM</label>
                                    </div>
                                    <div class="slot-capacity">
                                        <label for="capacity_230">Capacity:</label>
                                        <input type="number" id="capacity_230" name="slot_capacity[2:30 PM]" min="1" max="10" value="2" disabled>
                                    </div>
                                </div>
                                <div class="time-slot-option">
                                    <div class="slot-header">
                                        <input type="checkbox" id="slot_330" name="available_time_slots[]" value="3:30 PM">
                                        <label for="slot_330">3:30 PM</label>
                                    </div>
                                    <div class="slot-capacity">
                                        <label for="capacity_330">Capacity:</label>
                                        <input type="number" id="capacity_330" name="slot_capacity[3:30 PM]" min="1" max="10" value="2" disabled>
                                    </div>
                                </div>
                                <div class="time-slot-option">
                                    <div class="slot-header">
                                        <input type="checkbox" id="slot_400" name="available_time_slots[]" value="4:00 PM">
                                        <label for="slot_400">4:00 PM</label>
                                    </div>
                                    <div class="slot-capacity">
                                        <label for="capacity_400">Capacity:</label>
                                        <input type="number" id="capacity_400" name="slot_capacity[4:00 PM]" min="1" max="10" value="2" disabled>
                                    </div>
                                </div>
                            </div>
                            <div class="time-slots-actions">
                                <button type="button" class="btn-select-all" onclick="selectAllTimeSlots()">Select All</button>
                                <button type="button" class="btn-clear-all" onclick="clearAllTimeSlots()">Clear All</button>
                            </div>
                        </div>
                        <div class="field-error" id="timeSlotAvailabilityError"></div>
                    </div>

                    <div class="form-group">
                        <label for="serviceNotes">
                            <i class="fas fa-sticky-note"></i>
                            Additional Notes
                        </label>
                        <textarea id="serviceNotes" name="notes" rows="2" placeholder="Any additional information about this service..."></textarea>
                        <div class="field-error" id="serviceNotesError"></div>
                    </div>
                </div>

                <div class="modal-actions enhanced-actions">
                    <button type="button" class="btn-cancel enhanced-cancel" onclick="hideAddServiceModal()">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button type="submit" class="btn-save enhanced-save">
                        <i class="fas fa-save"></i>
                        <span class="btn-text">Save Service</span>
                        <div class="btn-loading" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i>
                            Saving...
                        </div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Service Modal -->
    <div id="editServiceModal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="hideEditServiceModal()"></div>
        <div class="modal-content enhanced-modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-edit"></i>
                <h3>Edit Service</h3>
                </div>
                <button class="modal-close" onclick="hideEditServiceModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="editServiceForm" class="enhanced-form">
                <input type="hidden" id="editServiceId" name="id">
                
                <div class="form-content">
                    <div class="form-left-column">
                        <div class="form-group">
                            <label for="editServiceName">
                                <i class="fas fa-tag"></i>
                                Service Name
                                <span class="required">*</span>
                            </label>
                            <input type="text" id="editServiceName" name="service_name" placeholder="e.g., Lion Cut" required>
                            <div class="field-error" id="editServiceNameError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="editServiceCategory">
                                <i class="fas fa-list"></i>
                                Service Category
                                <span class="required">*</span>
                            </label>
                            <select id="editServiceCategory" name="service_category" required>
                                <option value="">Select Category</option>
                                <option value="GROOMING SERVICE">GROOMING SERVICE</option>
                                <option value="CAT HOTEL">CAT HOTEL</option>
                                <option value="A LA CARTE SERVICE">A LA CARTE SERVICE</option>
                            </select>
                            <div class="field-error" id="editServiceCategoryError"></div>
                        </div>

                        <div class="form-group">
                            <label for="editServiceDuration">
                                <i class="fas fa-clock"></i>
                                Duration
                            </label>
                            <div class="duration-input">
                                <input type="number" id="editServiceDuration" name="duration_minutes" min="1" placeholder="60">
                                <select id="editDurationUnit" name="duration_unit">
                                    <option value="minutes">Minutes</option>
                                    <option value="hours">Hours</option>
                                    <option value="days">Days</option>
                                    <option value="nights">Nights</option>
                                </select>
                            </div>
                            <div class="field-error" id="editServiceDurationError"></div>
                        </div>


                        <div class="form-group">
                            <label for="editCatHotelCategory">
                                <i class="fas fa-bed"></i>
                                CAT HOTEL CATEGORY
                            </label>
                            <select id="editCatHotelCategory" name="cat_hotel_category">
                                <option value="">Select Cat Hotel Category</option>
                                <option value="classic_suite">CLASSIC SUITE</option>
                                <option value="deluxe_suite">DELUXE SUITE</option>
                                <option value="executive_suite">EXECUTIVE SUITE</option>
                                <option value="day_care">STUDIO SUITE</option>
                            </select>
                            <div class="field-error" id="editCatHotelCategoryError"></div>
                        </div>
                    </div>

                    <div class="form-right-column">
                        <div class="form-group">
                            <label for="editServicePrices">
                                <i class="fas fa-dollar-sign"></i>
                                Service Prices (RM)
                                <span class="required">*</span>
                            </label>
                            <div id="editPriceContainer">
                                <div class="price-item" data-price-index="0">
                                    <div class="price-row">
                                        <div class="price-category">
                                            <label>Pet Category</label>
                                            <select name="price_categories[]" required>
                                                <option value="">Select Category</option>
                                                <option value="GENERAL">General</option>
                                                <option value="KITTEN ">Kitten</option>
                                                <option value="ADULT SHORT HAIR">Adult Short Hair</option>
                                                <option value="ADULT LONG HAIR">Adult Long Hair</option>
                                            </select>
                                        </div>
                                        <div class="price-weight">
                                            <label>Weight Range (KG) <span class="optional">(Optional)</span></label>
                                            <input type="text" name="price_weights[]" placeholder="e.g., 0-2, 2-4, 4-6, 6-8, 8-10, 10+" pattern="[0-9+\-\.\s]*" title="Only numbers, ranges (e.g., 0-2), and + symbol allowed">
                                        </div>
                                        <div class="price-amount">
                                            <label>Price (RM)</label>
                                            <input type="number" name="prices[]" step="0.01" min="0" placeholder="0.00" required>
                                        </div>
                                        <div class="price-actions">
                                            <button type="button" class="add-price-btn" onclick="addEditPriceRow()" title="Add Price">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="custom-category" style="display: none;">
                                        <input type="text" name="custom_categories[]" placeholder="Enter custom category name">
                                    </div>
                                </div>
                            </div>
                            <div class="field-error" id="editServicePricesError"></div>
                        </div>

                        <div class="form-group">
                            <label for="editServiceImage">
                                <i class="fas fa-image"></i>
                                Service Image
                            </label>
                            <div class="image-upload-area" id="editImageUploadArea">
                                <div class="upload-content">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <p>Drag & drop an image here or <span class="upload-link">browse files</span></p>
                                    <small>Supports: JPG, PNG, GIF (Max 5MB)</small>
                                </div>
                                <input type="file" id="editServiceImage" name="image" accept="image/*" style="display: none;">
                            </div>
                            <div id="editServiceImagePreview" class="image-preview enhanced-preview" style="display: none;">
                                <div class="preview-container">
                                    <img id="editServicePreviewImg" src="" alt="Preview">
                                    <div class="preview-overlay">
                                        <button type="button" onclick="removeEditServiceImage()" class="remove-image-btn">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        <button type="button" onclick="changeEditServiceImage()" class="change-image-btn">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="image-info">
                                    <span id="editImageFileName"></span>
                                    <span id="editImageFileSize"></span>
                                </div>
                            </div>
                            <div id="editServiceCurrentImage" class="current-image" style="display: none;">
                                <span>Current Image:</span>
                                <img id="editServiceCurrentImg" src="" alt="Current">
                                <button type="button" onclick="removeCurrentImage()" class="remove-image-btn">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="field-error" id="editServiceImageError"></div>
                        </div>

                        <div class="form-group">
                            <label for="editBreedNotes">
                                <i class="fas fa-clipboard-list"></i>
                                Breed Notes
                            </label>
                            <textarea id="editBreedNotes" name="breed_notes" rows="4" placeholder="Special notes for specific breeds..."></textarea>
                            <div class="field-error" id="editBreedNotesError"></div>
                        </div>

                        <!-- Time Slot Availability -->
                        <div class="form-group">
                            <label for="editTimeSlotAvailability">
                                <i class="fas fa-clock"></i>
                                Available Time Slots & Capacity
                                <span class="required">*</span>
                            </label>
                            <div class="time-slots-selection">
                                <div class="time-slots-grid" id="editTimeSlotsGrid">
                                    <div class="time-slot-option">
                                        <div class="slot-header">
                                            <input type="checkbox" id="edit_slot_1030" name="available_time_slots[]" value="10:30 AM">
                                            <label for="edit_slot_1030">10:30 AM</label>
                                        </div>
                                        <div class="slot-capacity">
                                            <label for="edit_capacity_1030">Capacity:</label>
                                            <input type="number" id="edit_capacity_1030" name="slot_capacity[10:30 AM]" min="1" max="10" value="2" disabled>
                                        </div>
                                    </div>
                                    <div class="time-slot-option">
                                        <div class="slot-header">
                                            <input type="checkbox" id="edit_slot_1100" name="available_time_slots[]" value="11:00 AM">
                                            <label for="edit_slot_1100">11:00 AM</label>
                                        </div>
                                        <div class="slot-capacity">
                                            <label for="edit_capacity_1100">Capacity:</label>
                                            <input type="number" id="edit_capacity_1100" name="slot_capacity[11:00 AM]" min="1" max="10" value="2" disabled>
                                        </div>
                                    </div>
                                    <div class="time-slot-option">
                                        <div class="slot-header">
                                            <input type="checkbox" id="edit_slot_1200" name="available_time_slots[]" value="12:00 PM">
                                            <label for="edit_slot_1200">12:00 PM</label>
                                        </div>
                                        <div class="slot-capacity">
                                            <label for="edit_capacity_1200">Capacity:</label>
                                            <input type="number" id="edit_capacity_1200" name="slot_capacity[12:00 PM]" min="1" max="10" value="2" disabled>
                                        </div>
                                    </div>
                                    <div class="time-slot-option">
                                        <div class="slot-header">
                                            <input type="checkbox" id="edit_slot_100" name="available_time_slots[]" value="1:00 PM">
                                            <label for="edit_slot_100">1:00 PM</label>
                                        </div>
                                        <div class="slot-capacity">
                                            <label for="edit_capacity_100">Capacity:</label>
                                            <input type="number" id="edit_capacity_100" name="slot_capacity[1:00 PM]" min="1" max="10" value="2" disabled>
                                        </div>
                                    </div>
                                    <div class="time-slot-option">
                                        <div class="slot-header">
                                            <input type="checkbox" id="edit_slot_200" name="available_time_slots[]" value="2:00 PM">
                                            <label for="edit_slot_200">2:00 PM</label>
                                        </div>
                                        <div class="slot-capacity">
                                            <label for="edit_capacity_200">Capacity:</label>
                                            <input type="number" id="edit_capacity_200" name="slot_capacity[2:00 PM]" min="1" max="10" value="2" disabled>
                                        </div>
                                    </div>
                                    <div class="time-slot-option">
                                        <div class="slot-header">
                                            <input type="checkbox" id="edit_slot_230" name="available_time_slots[]" value="2:30 PM">
                                            <label for="edit_slot_230">2:30 PM</label>
                                        </div>
                                        <div class="slot-capacity">
                                            <label for="edit_capacity_230">Capacity:</label>
                                            <input type="number" id="edit_capacity_230" name="slot_capacity[2:30 PM]" min="1" max="10" value="2" disabled>
                                        </div>
                                    </div>
                                    <div class="time-slot-option">
                                        <div class="slot-header">
                                            <input type="checkbox" id="edit_slot_330" name="available_time_slots[]" value="3:30 PM">
                                            <label for="edit_slot_330">3:30 PM</label>
                                        </div>
                                        <div class="slot-capacity">
                                            <label for="edit_capacity_330">Capacity:</label>
                                            <input type="number" id="edit_capacity_330" name="slot_capacity[3:30 PM]" min="1" max="10" value="2" disabled>
                                        </div>
                                    </div>
                                    <div class="time-slot-option">
                                        <div class="slot-header">
                                            <input type="checkbox" id="edit_slot_400" name="available_time_slots[]" value="4:00 PM">
                                            <label for="edit_slot_400">4:00 PM</label>
                                        </div>
                                        <div class="slot-capacity">
                                            <label for="edit_capacity_400">Capacity:</label>
                                            <input type="number" id="edit_capacity_400" name="slot_capacity[4:00 PM]" min="1" max="10" value="2" disabled>
                                        </div>
                                    </div>
                                </div>
                                <div class="time-slots-actions">
                                    <button type="button" class="btn-select-all" onclick="selectAllEditTimeSlots()">Select All</button>
                                    <button type="button" class="btn-clear-all" onclick="clearAllEditTimeSlots()">Clear All</button>
                                </div>
                            </div>
                            <div class="field-error" id="editTimeSlotAvailabilityError"></div>
                        </div>

                        <div class="form-group">
                            <label for="editServiceNotes">
                                <i class="fas fa-sticky-note"></i>
                                Additional Notes
                            </label>
                            <textarea id="editServiceNotes" name="notes" rows="4" placeholder="Any additional information about this service..."></textarea>
                            <div class="field-error" id="editServiceNotesError"></div>
                        </div>
                    </div>
                </div>

                <div class="modal-actions enhanced-actions">
                    <button type="button" class="btn-cancel enhanced-cancel" onclick="hideEditServiceModal()">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button type="submit" class="btn-save enhanced-save">
                        <i class="fas fa-save"></i>
                        <span class="btn-text">Update Service</span>
                        <div class="btn-loading" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i>
                            Updating...
                        </div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notes Modal -->
    <div id="notesModal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="hideNotesModal()"></div>
        <div class="modal-content enhanced-modal" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-sticky-note"></i>
                    Booking Notes
                </div>
                <button class="modal-close" onclick="hideNotesModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="notesForm" onsubmit="saveNotes(event)">
                <div class="form-content">
                    <div class="form-group">
                        <label for="bookingId">Booking ID</label>
                        <input type="text" id="bookingId" name="booking_id" readonly style="background-color: #f8f9fa;">
                    </div>
                    
                    <div class="form-group">
                        <label for="notesText">Notes</label>
                        <textarea id="notesText" name="notes" rows="6" placeholder="Add your notes about this booking..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="notesImage">Upload Image</label>
                        <div class="image-upload-container">
                            <input type="file" id="notesImage" name="image" accept="image/*" onchange="previewImage(event)">
                            <div class="image-preview" id="imagePreview" style="display: none;">
                                <img id="previewImg" src="" alt="Preview">
                                <button type="button" onclick="removeImage()" class="remove-image-btn">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Existing Images</label>
                        <div id="existingImages" class="existing-images-container">
                            <!-- Existing images will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <div class="modal-actions enhanced-actions">
                    <button type="button" class="btn-cancel enhanced-cancel" onclick="hideNotesModal()">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button type="submit" class="btn-save enhanced-save">
                        <i class="fas fa-save"></i>
                        <span class="btn-text">Save Notes</span>
                        <div class="btn-loading" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i>
                            Saving...
                        </div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Hotel Booking Notes Modal -->
    <div id="hotelNotesModal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="hideHotelNotesModal()"></div>
        <div class="modal-content enhanced-modal" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-sticky-note"></i>
                    Hotel Booking Notes
                </div>
                <button class="modal-close" onclick="hideHotelNotesModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="hotelNotesForm" onsubmit="saveHotelNotes(event)">
                <div class="form-content">
                    <div class="form-group">
                        <label for="hotelBookingId">Booking ID</label>
                        <input type="text" id="hotelBookingId" name="booking_id" readonly style="background-color: #f8f9fa;">
                    </div>
                    
                    <div class="form-group">
                        <label for="hotelNotesText">Notes</label>
                        <textarea id="hotelNotesText" name="notes" rows="6" placeholder="Add your notes about this hotel booking..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="hotelNotesImage">Upload Image</label>
                        <div class="image-upload-container">
                            <input type="file" id="hotelNotesImage" name="image" accept="image/*" onchange="previewHotelImage(event)">
                            <div class="image-preview" id="hotelImagePreview" style="display: none;">
                                <img id="hotelPreviewImg" src="" alt="Preview">
                                <button type="button" onclick="removeHotelImage()" class="remove-image-btn">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Existing Images</label>
                        <div id="hotelExistingImages" class="existing-images-container">
                            <!-- Existing images will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <div class="modal-actions enhanced-actions">
                    <button type="button" class="btn-cancel enhanced-cancel" onclick="hideHotelNotesModal()">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button type="submit" class="btn-save enhanced-save">
                        <i class="fas fa-save"></i>
                        <span class="btn-text">Save Notes</span>
                        <div class="btn-loading" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i>
                            Saving...
                        </div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Navigation functionality
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                const section = this.getAttribute('data-section');
                
                // Remove active class from all nav items
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // Add active class to clicked item
                this.parentElement.classList.add('active');
                
                // Hide all content sections
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });
                
                // Show selected section
                document.getElementById(section + '-section').classList.add('active');
            });
        });

        // Restore tab state after page reload
        document.addEventListener('DOMContentLoaded', function() {
            const savedTab = localStorage.getItem('adminActiveTab');
            if (savedTab) {
                const tabElement = document.querySelector(`[data-section="${savedTab}"]`);
                if (tabElement) {
                    // Clear the saved tab state
                    localStorage.removeItem('adminActiveTab');
                    // Click the tab to restore state
                    tabElement.click();
                }
            }
        });

        // Global variables for services functionality
        let allServices = [];
        let filteredServices = [];

        // Load bookings from database
        async function loadBookings() {
            try {
                const response = await fetch('bookings.php?action=admin_service_bookings');
                const result = await response.json();
                
                if (result.success) {
                    allBookings = result.data;
                    filteredBookings = [...allBookings];
                    displayBookings(filteredBookings);
                    updateBookingSearchResults('');
                } else {
                    console.error('Failed to load bookings:', result.message);
                    showBookingError('Failed to load bookings: ' + result.message);
                }
            } catch (error) {
                console.error('Error loading bookings:', error);
                showBookingError('Error loading bookings. Please check your connection.');
            }
        }

        // Display bookings in the table
        function displayBookings(bookings) {
            const bookingsTable = document.getElementById('bookingsTable');
            const bookingsTableBody = document.getElementById('bookingsTableBody');
            const bookingsLoading = document.getElementById('bookingsLoading');
            
            // Hide loading, show table
            bookingsLoading.style.display = 'none';
            bookingsTable.style.display = 'table';
            
            if (bookings.length === 0) {
                bookingsTableBody.innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 2rem; color: #718096;">
                            <i class="fas fa-calendar-times" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p style="margin: 0;">No bookings found</p>
                        </td>
                    </tr>
                `;
                return;
            }

            bookingsTableBody.innerHTML = '';
            
            bookings.forEach(booking => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>#${booking.id}</td>
                    <td>
                        <div>
                            <strong>${booking.booking_reference || 'N/A'}</strong>
                        </div>
                    </td>
                    <td>
                        <div>
                            <strong>${booking.owner_name}</strong><br>
                            <small style="color: #718096;">${booking.email || 'No email'}</small><br>
                            <small style="color: #718096;">${booking.owner_phone}</small>
                        </div>
                    </td>
                    <td>
                        <div>
                            ${booking.all_pets && booking.all_pets.length > 0 ? 
                                booking.all_pets.map((pet, idx) => 
                                    `<strong style="color: #2d3748; font-size: 0.9rem;">${pet.name}</strong> <span style="color: #718096; font-size: 0.85rem;">(${pet.breed || 'Unknown breed'})</span>${idx < booking.all_pets.length - 1 ? ', ' : ''}`
                                ).join('') : 
                                `<strong style="color: #2d3748; font-size: 0.9rem;">${booking.pet_name}</strong> <span style="color: #718096; font-size: 0.85rem;">(${booking.pet_breed || 'Unknown breed'})</span>`
                            }
                        </div>
                    </td>
                    <td>
                        <div>
                            <strong>${booking.service_name}</strong><br>
                            <small style="color: #718096;">${formatCategoryName(booking.service_category)}</small>
                        </div>
                    </td>
                    <td>
                        <div>
                            <strong>${formatDate(booking.booking_date)}</strong><br>
                            <small style="color: #718096;">${formatTime(booking.booking_time)}</small>
                        </div>
                    </td>
                    <td>
                        <span class="payment-method-badge ${booking.payment_method}">
                            ${formatPaymentMethod(booking.payment_method)}
                        </span>
                    </td>
                    <td>
                        <strong>RM${parseFloat(booking.total_amount || 0).toFixed(2)}</strong>
                    </td>
                    <td>
                        <span class="status-badge ${booking.booking_status}">${formatStatus(booking.booking_status)}</span>
                    </td>
                    <td>
                        <div>
                            <small style="color: #718096;">${formatDate(booking.created_at)}</small><br>
                            <small style="color: #718096;">${formatTime(booking.created_at)}</small>
                        </div>
                    </td>
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="action-btn edit-btn" onclick="viewBookingDetails(${booking.id})" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                        ${booking.receipt_file_path ? `
                        <button class="action-btn receipt-btn" onclick="downloadReceipt('${booking.receipt_file_path}', '${booking.booking_reference}')" title="Download Receipt">
                            <i class="fas fa-download"></i>
                        </button>
                        ` : ''}
                        <button class="action-btn notes-btn" onclick="openNotesModal(${booking.id})" title="Add Notes">
                            <i class="fas fa-sticky-note"></i>
                        </button>
                            <button class="action-btn edit-btn" onclick="updateBookingStatus(${booking.id})" title="Update Status">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteBooking(${booking.id})" title="Delete Booking">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                bookingsTableBody.appendChild(row);
            });
        }

        // Format date for display - STANDARDIZED FUNCTION (DD/MM/YYYY format)
        function formatDate(dateString) {
            if (!dateString || dateString === 'N/A' || dateString === 'null' || dateString === 'undefined') {
                return 'N/A';
            }
            
            try {
                // Parse the date string
                const date = new Date(dateString);
                
                // Check if date is valid
                if (isNaN(date.getTime())) {
                    return dateString; // Return original if invalid
                }
                
                // Format as DD/MM/YYYY
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                
                return `${day}/${month}/${year}`;
            } catch (e) {
                // If parsing fails, return original string
                return dateString;
            }
        }

        // Format time for display
        function formatTime(timeString) {
            if (!timeString) return 'N/A';
            
            // Normalize the string
            const timeStr = String(timeString).trim();
            
            // If the time already contains AM/PM, return it as is (times are now stored in 12-hour format)
            if (typeof timeString === 'string' && (timeStr.includes('AM') || timeStr.includes('PM') || timeStr.includes('am') || timeStr.includes('pm'))) {
                return timeStr;
            }
            
            // Handle legacy 24-hour format (HH:MM or HH:MM:SS) - convert to 12-hour
            if (typeof timeString === 'string' && timeStr.match(/^\d{1,2}:\d{2}(:\d{2})?$/)) {
                const [hours, minutes] = timeStr.split(':');
                const hour24 = parseInt(hours);
                const minute = parseInt(minutes);
                
                // Convert to 12-hour format
                let hour12 = hour24;
                let ampm = 'AM';
                
                if (hour24 === 0) {
                    hour12 = 12; // Midnight
                    ampm = 'AM';
                } else if (hour24 === 12) {
                    hour12 = 12; // Noon
                    ampm = 'PM';
                } else if (hour24 > 12) {
                    hour12 = hour24 - 12;
                    ampm = 'PM';
                } else {
                    // For hours 1-11, if it's 24-hour format, it should be AM
                    // BUT if the database column is VARCHAR and stores "2:00" when it should be "2:00 PM",
                    // we can't tell. However, since times are supposed to be stored with AM/PM,
                    // if we see "2:00" without AM/PM, it's likely a data issue.
                    // We'll assume it's 24-hour format and display accordingly (1-11 = AM, 12 = PM, 13-23 = PM)
                    // This is correct for 24-hour format interpretation
                }
                
                // Format as "H:MM AM/PM" (single digit hour without leading zero)
                return `${hour12}:${String(minute).padStart(2, '0')} ${ampm}`;
            }
            
            // If it's a full datetime string, extract and format the time part
            if (timeStr.includes('T') || (timeStr.includes(' ') && timeStr.includes(':'))) {
                try {
                    // Try to parse as a full datetime first
                    const time = new Date(timeStr);
                    if (!isNaN(time.getTime())) {
                        // Use a more reliable method: extract hours and minutes and convert manually
                        const hours = time.getHours();
                        const minutes = time.getMinutes();
                        
                        let hour12 = hours;
                        let ampm = 'AM';
                        
                        if (hours === 0) {
                            hour12 = 12;
                            ampm = 'AM';
                        } else if (hours === 12) {
                            hour12 = 12;
                            ampm = 'PM';
                        } else if (hours > 12) {
                            hour12 = hours - 12;
                            ampm = 'PM';
                        }
                        
                        return `${hour12}:${String(minutes).padStart(2, '0')} ${ampm}`;
                    }
                } catch (e) {
                    // If parsing fails, try to extract time part
                    const timeMatch = timeStr.match(/(\d{1,2}):(\d{2})(:\d{2})?/);
                    if (timeMatch) {
                        const hour24 = parseInt(timeMatch[1]);
                        const minute = parseInt(timeMatch[2]);
                        let hour12 = hour24;
                        let ampm = 'AM';
                        
                        if (hour24 === 0) {
                            hour12 = 12;
                        } else if (hour24 === 12) {
                            hour12 = 12;
                            ampm = 'PM';
                        } else if (hour24 > 12) {
                            hour12 = hour24 - 12;
                            ampm = 'PM';
                        }
                        
                        return `${hour12}:${String(minute).padStart(2, '0')} ${ampm}`;
                    }
                }
            }
            
            // Special handling: if time is like "2:00" (no AM/PM) and in 1-11 range,
            // it might be incorrectly stored. But we can't fix it here without context.
            // We'll assume it's 24-hour format, so 1-11 = AM (which is correct for 24-hour)
            
            // If all else fails, return the original string
            return timeStr;
        }

        // Format payment method
        function formatPaymentMethod(method) {
            switch(method) {
                case 'online_banking': return 'Online Banking';
                case 'card': return 'Card';
                case 'ewallet': return 'E-Wallet';
                case 'fpx': return 'FPX Online Banking';
                default: return method || 'N/A';
            }
        }

        // Format status
        function formatStatus(status) {
            switch(status) {
                case 'pending': return 'Pending';
                case 'confirmed': return 'Confirmed';
                case 'completed': return 'Completed';
                case 'cancelled': return 'Cancelled';
                default: return status || 'Unknown';
            }
        }

        // Search bookings
        function searchBookings(searchTerm) {
            if (!searchTerm || searchTerm.trim() === '') {
                filteredBookings = [...allBookings];
            } else {
                const term = searchTerm.toLowerCase().trim();
                filteredBookings = allBookings.filter(booking => {
                    return (
                        booking.owner_name.toLowerCase().includes(term) ||
                        booking.pet_name.toLowerCase().includes(term) ||
                        booking.service_name.toLowerCase().includes(term) ||
                        booking.email?.toLowerCase().includes(term) ||
                        booking.owner_phone.includes(term) ||
                        booking.id.toString().includes(term)
                    );
                });
            }
            displayBookings(filteredBookings);
            updateBookingSearchResults(searchTerm);
        }

        // Filter bookings by status
        function filterBookingsByStatus(status) {
            if (!status) {
                filteredBookings = [...allBookings];
            } else {
                filteredBookings = allBookings.filter(booking => booking.booking_status === status);
            }
            displayBookings(filteredBookings);
            updateBookingSearchResults('');
        }

        // Filter bookings by date
        function filterBookingsByDate(date) {
            if (!date) {
                filteredBookings = [...allBookings];
            } else {
                filteredBookings = allBookings.filter(booking => booking.booking_date === date);
            }
            displayBookings(filteredBookings);
            updateBookingSearchResults('');
        }

        // Update booking search results counter
        function updateBookingSearchResults(searchTerm) {
            const searchResults = document.getElementById('bookingSearchResults');
            if (searchResults) {
                if (searchTerm && searchTerm.trim() !== '') {
                    searchResults.innerHTML = `
                        <i class="fas fa-search"></i> 
                        Found ${filteredBookings.length} of ${allBookings.length} bookings
                        ${filteredBookings.length !== allBookings.length ? `for "${searchTerm}"` : ''}
                    `;
                } else {
                    searchResults.innerHTML = `
                        <i class="fas fa-calendar-alt"></i> 
                        Showing all ${allBookings.length} bookings
                    `;
                }
            }
        }

        // Clear booking filters
        function clearBookingFilters() {
            document.getElementById('bookingSearchInput').value = '';
            document.getElementById('bookingStatusFilter').value = '';
            document.getElementById('bookingDateFilter').value = '';
            filteredBookings = [...allBookings];
            displayBookings(filteredBookings);
            updateBookingSearchResults('');
        }

        // Refresh bookings
        function refreshBookings() {
            loadBookings();
        }

        // Export bookings
        function exportBookings() {
            // Simple CSV export
            const csvContent = generateBookingsCSV(filteredBookings);
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bookings_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Generate CSV content
        function generateBookingsCSV(bookings) {
            const headers = ['Booking ID', 'Booking Reference', 'Customer Name', 'Email', 'Phone', 'Pet Names', 'Pet Breeds', 'Service', 'Date', 'Time', 'Payment Method', 'Amount', 'Status', 'Created At', 'User Notes', 'Admin Notes'];
            const csvRows = [headers.join(',')];
            
            bookings.forEach(booking => {
                // Format dates for Excel compatibility
                const formattedDate = booking.booking_date ? formatDateForExcel(booking.booking_date) : '';
                const formattedCreatedAt = booking.created_at ? formatDateForExcel(booking.created_at) : '';
                
                // Format pets for export
                let petNames = '';
                let petBreeds = '';
                
                if (booking.all_pets && booking.all_pets.length > 0) {
                    petNames = booking.all_pets.map(pet => pet.name).join('; ');
                    petBreeds = booking.all_pets.map(pet => pet.breed || 'N/A').join('; ');
                } else {
                    petNames = booking.pet_name || 'N/A';
                    petBreeds = booking.pet_breed || 'N/A';
                }
                
                const row = [
                    booking.id,
                    `"${booking.booking_reference || 'N/A'}"`,
                    `"${booking.owner_name}"`,
                    `"${booking.email || ''}"`,
                    `"${booking.owner_phone}"`,
                    `"${petNames}"`,
                    `"${petBreeds}"`,
                    `"${booking.service_name}"`,
                    formattedDate,
                    `"${booking.booking_time || ''}"`,
                    formatPaymentMethod(booking.payment_method),
                    booking.total_amount || 0,
                    formatStatus(booking.booking_status),
                    formattedCreatedAt,
                    `"${booking.additional_notes || ''}"`,
                    `"${booking.admin_notes || ''}"`
                ];
                csvRows.push(row.join(','));
            });
            
            return csvRows.join('\n');
        }
        
        // Format date for Excel compatibility
        function formatDateForExcel(dateString) {
            if (!dateString) return '';
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                
                // Format as MM/DD/YYYY for Excel compatibility
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const year = date.getFullYear();
                
                return `${month}/${day}/${year}`;
            } catch (e) {
                return dateString;
            }
        }

        // View booking details
        async function viewBookingDetails(bookingId) {
            try {
                // Fetch booking details with complete customer and pet information
                const response = await fetch(`bookings.php?action=get_booking&booking_id=${bookingId}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const booking = result.data;
                    
                    // Fetch additional customer details
                    const customerResponse = await fetch(`users.php?action=get&id=${booking.user_id}`);
                    const customerResult = await customerResponse.json();
                    
                    // Fetch additional pet details
                    const petResponse = await fetch(`pets.php?action=get&id=${booking.pet_id}`);
                    const petResult = await petResponse.json();
                    
                    // Fetch admin notes
                    const notesResponse = await fetch('booking_notes.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `action=get_notes&booking_id=${bookingId}&booking_type=${booking.booking_type || 'service'}`
                    });
                    const notesResult = await notesResponse.json();
                    
                    // Combine all data
                    const enhancedBooking = {
                        ...booking,
                        customer_details: customerResult.success ? customerResult.data : null,
                        pet_details: petResult.success ? petResult.data : null,
                        admin_notes: notesResult.success ? notesResult.data.notes : null,
                        admin_images: notesResult.success ? notesResult.data.images : []
                    };
                    
                    showBookingDetailsModal(enhancedBooking);
                } else {
                    alert('Failed to load booking details: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error loading booking details:', error);
                alert('Error loading booking details: ' + error.message);
            }
        }

        // Show booking details modal
        function showBookingDetailsModal(booking) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            
            // Helper function to format vaccine information
            function formatVaccineInfo(vaccineData) {
                if (!vaccineData) return 'N/A';
                
                // Handle different vaccine data formats
                if (typeof vaccineData === 'string') {
                    // Single vaccine name
                    if (vaccineData.trim() === '' || vaccineData === 'NULL' || vaccineData === 'null') {
                        return 'N/A';
                    }
                    return vaccineData.trim();
                }
                
                // Handle array of vaccines
                if (Array.isArray(vaccineData) && vaccineData.length > 0) {
                    return vaccineData.map(v => {
                        if (typeof v === 'string') return v;
                        if (v.vaccine_name) return v.vaccine_name;
                        return 'Unknown';
                    }).join(', ');
                }
                
                // Handle object with vaccine_name property
                if (vaccineData.vaccine_name) {
                    return vaccineData.vaccine_name;
                }
                
                return 'N/A';
            }
            
            // Helper function to format vaccine information with dates
            function formatVaccineInfoWithDates(vaccineData, vaccineDateData) {
                if (!vaccineData) return 'N/A';
                
                // Handle different vaccine data formats
                if (typeof vaccineData === 'string') {
                    // Single vaccine name
                    if (vaccineData.trim() === '' || vaccineData === 'NULL' || vaccineData === 'null') {
                        return 'N/A';
                    }
                    
                    // Add date if available
                    if (vaccineDateData && vaccineDateData.trim() !== '' && vaccineDateData !== 'NULL' && vaccineDateData !== 'null') {
                        // Format date to DD/MM/YYYY
                        let formattedDate = vaccineDateData.trim();
                        try {
                            const date = new Date(vaccineDateData.trim());
                            if (!isNaN(date.getTime())) {
                                const day = String(date.getDate()).padStart(2, '0');
                                const month = String(date.getMonth() + 1).padStart(2, '0');
                                const year = date.getFullYear();
                                formattedDate = `${day}/${month}/${year}`;
                            }
                        } catch (e) {
                            // Keep original format if parsing fails
                        }
                        return `${vaccineData.trim()} (${formattedDate})`;
                    }
                    return vaccineData.trim();
                }
                
                // Handle array of vaccines
                if (Array.isArray(vaccineData) && vaccineData.length > 0) {
                    return vaccineData.map(v => {
                        if (typeof v === 'string') return v;
                        if (v.vaccine_name) {
                            let formattedDate = '';
                            if (v.vaccination_date) {
                                try {
                                    const date = new Date(v.vaccination_date);
                                    if (!isNaN(date.getTime())) {
                                        const day = String(date.getDate()).padStart(2, '0');
                                        const month = String(date.getMonth() + 1).padStart(2, '0');
                                        const year = date.getFullYear();
                                        formattedDate = ` (${day}/${month}/${year})`;
                                    }
                                } catch (e) {
                                    formattedDate = ` (${v.vaccination_date})`;
                                }
                            }
                            return `${v.vaccine_name}${formattedDate}`;
                        }
                        return 'Unknown';
                    }).join(', ');
                }
                
                // Handle object with vaccine_name property
                if (vaccineData.vaccine_name) {
                    let formattedDate = '';
                    if (vaccineDateData) {
                        try {
                            const date = new Date(vaccineDateData);
                            if (!isNaN(date.getTime())) {
                                const day = String(date.getDate()).padStart(2, '0');
                                const month = String(date.getMonth() + 1).padStart(2, '0');
                                const year = date.getFullYear();
                                formattedDate = ` (${day}/${month}/${year})`;
                            }
                        } catch (e) {
                            formattedDate = ` (${vaccineDateData})`;
                        }
                    }
                    return `${vaccineData.vaccine_name}${formattedDate}`;
                }
                
                return 'N/A';
            }
            
            // Add body scroll lock
            document.body.classList.add('modal-open');
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeBookingDetailsModal()"></div>
                <div class="modal-content" style="max-width: 1000px;">
                    <div class="modal-header">
                        <div class="modal-title">
                            <i class="fas fa-calendar-check"></i>
                            <h3>Booking Details #${booking.id}</h3>
                        </div>
                        <button class="modal-close" onclick="closeBookingDetailsModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div style="padding: 1.5rem;">
                        <!-- Booking References Section -->
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div>
                                    <strong>Booking ID:</strong> ${booking.id}
                                </div>
                                <div>
                                    <strong>Booking Reference:</strong> ${booking.booking_reference || 'N/A'}
                                </div>
                                <div>
                                    <strong>Created At:</strong> ${formatDate(booking.created_at)} ${formatTime(booking.created_at)}
                                </div>
                                <div>
                                    <strong>Last Updated:</strong> ${booking.updated_at ? formatDate(booking.updated_at) + ' ' + formatTime(booking.updated_at) : 'N/A'}
                                </div>
                            </div>
                        </div>

                        <!-- Customer & Pet Information Row -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                            <!-- Customer Information -->
                            <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem;">
                                <h3 style="margin: 0 0 1rem 0; color: #2d3748; font-size: 1.2rem; display: flex; align-items: center;">
                                    <i class="fas fa-user" style="margin-right: 0.5rem; color: #667eea;"></i>
                                    Customer Information
                                </h3>
                                <div style="space-y: 0.75rem;">
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Full Name</div>
                                        <div style="font-weight: 600; color: #2d3748;">${booking.first_name} ${booking.last_name}</div>
                                    </div>
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Email Address</div>
                                        <div style="font-weight: 600; color: #2d3748;">${booking.email || 'N/A'}</div>
                                    </div>
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Phone Number</div>
                                        <div style="font-weight: 600; color: #2d3748;">${booking.phone_number || 'N/A'}</div>
                                    </div>
                                    ${booking.customer_details ? `
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Address</div>
                                        <div style="font-weight: 600; color: #2d3748;">${booking.customer_details.address || 'N/A'}</div>
                                    </div>
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Account Created</div>
                                        <div style="font-weight: 600; color: #2d3748;">${booking.customer_details.created_at ? formatDate(booking.customer_details.created_at) : 'N/A'}</div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- Pet Information -->
                            <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem;">
                                <h3 style="margin: 0 0 1rem 0; color: #2d3748; font-size: 1.2rem; display: flex; align-items: center;">
                                    <i class="fas fa-paw" style="margin-right: 0.5rem; color: #667eea;"></i>
                                    Pet Information ${booking.all_pets && booking.all_pets.length > 1 ? `<span style="background: #667eea; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; margin-left: 0.5rem;">${booking.all_pets.length} Pets</span>` : ''}
                                </h3>
                                ${booking.all_pets && booking.all_pets.length > 0 ? 
                                    booking.all_pets.map((pet, index) => `
                                        <div style="${index > 0 ? 'margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #e2e8f0;' : ''}">
                                            ${pet.photo_path ? `
                                                <div style="text-align: center; margin-bottom: 1rem;">
                                                    <img src="${pet.photo_path}" alt="Pet Photo" style="width: 120px; height: 120px; object-fit: cover; border-radius: 12px; border: 3px solid #e2e8f0; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                                </div>
                                            ` : `
                                                <div style="text-align: center; margin-bottom: 1rem; background: #f1f5f9; border-radius: 12px; padding: 2rem; border: 2px dashed #cbd5e0;">
                                                    <i class="fas fa-image" style="font-size: 2rem; color: #a0aec0; margin-bottom: 0.5rem;"></i>
                                                    <div style="color: #718096; font-size: 0.875rem;">No Pet Image Available</div>
                                                </div>
                                            `}
                                            <div style="space-y: 0.75rem;">
                                                <div style="margin-bottom: 0.75rem;">
                                                    <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Name</div>
                                                    <div style="font-weight: 600; color: #2d3748;">${pet.name || 'N/A'}</div>
                                                </div>
                                                <div style="margin-bottom: 0.75rem;">
                                                    <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Breed</div>
                                                    <div style="font-weight: 600; color: #2d3748;">${pet.breed || 'N/A'}</div>
                                                </div>
                                                <div style="margin-bottom: 0.75rem;">
                                                    <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Age</div>
                                                    <div style="font-weight: 600; color: #2d3748;">${pet.age || 'N/A'} years</div>
                                                </div>
                                                <div style="margin-bottom: 0.75rem;">
                                                    <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Gender</div>
                                                    <div style="font-weight: 600; color: #2d3748;">${pet.gender || 'N/A'}</div>
                                                </div>
                                                <div style="margin-bottom: 0.75rem;">
                                                    <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Weight</div>
                                                    <div style="font-weight: 600; color: #2d3748;">${pet.weight || 'N/A'} kg</div>
                                                </div>
                                                <div style="margin-bottom: 0.75rem;">
                                                    <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Spayed/Neutered</div>
                                                    <div style="font-weight: 600; color: #2d3748;">${pet.spayed_neutered || 'N/A'}</div>
                                                </div>
                                                <div style="margin-bottom: 0.75rem;">
                                                    <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Medical Type</div>
                                                    <div style="font-weight: 600; color: #2d3748;">${pet.medical_type ? pet.medical_type.replace(/_/g, ' ') : 'None'}</div>
                                                </div>
                                                <div style="margin-bottom: 0.75rem;">
                                                    <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Medical Condition</div>
                                                    <div style="font-weight: 600; color: #2d3748;">${pet.medical_condition ? pet.medical_condition.replace(/_/g, ' ') : 'None'}</div>
                                                </div>
                                                <div style="margin-bottom: 0.75rem;">
                                                    <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Special Notes</div>
                                                    <div style="font-weight: 600; color: #2d3748;">${pet.special_notes || 'None'}</div>
                                                </div>
                                                <div style="margin-bottom: 0.75rem;">
                                                    <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Vaccine</div>
                                                    <div style="font-weight: 600; color: #2d3748;">${formatVaccineInfoWithDates(pet.vaccine_name, pet.vaccine_date)}</div>
                                                </div>
                                                <div style="margin-bottom: 0.75rem;">
                                                    <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Pet Category</div>
                                                    <div style="font-weight: 600; color: #2d3748;">${pet.pet_category || 'N/A'}</div>
                                                </div>
                                                <div style="margin-bottom: 0.75rem;">
                                                    <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Registration Date</div>
                                                    <div style="font-weight: 600; color: #2d3748;">${pet.created_at ? formatDate(pet.created_at) : 'N/A'}</div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('') : `
                                        ${booking.pet_details && booking.pet_details.photo_path ? `
                                            <div style="text-align: center; margin-bottom: 1rem;">
                                                <img src="${booking.pet_details.photo_path}" alt="Pet Photo" style="width: 120px; height: 120px; object-fit: cover; border-radius: 12px; border: 3px solid #e2e8f0; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                            </div>
                                        ` : `
                                            <div style="text-align: center; margin-bottom: 1rem; background: #f1f5f9; border-radius: 12px; padding: 2rem; border: 2px dashed #cbd5e0;">
                                                <i class="fas fa-image" style="font-size: 2rem; color: #a0aec0; margin-bottom: 0.5rem;"></i>
                                                <div style="color: #718096; font-size: 0.875rem;">No Pet Image Available</div>
                                            </div>
                                        `}
                                        <div style="space-y: 0.75rem;">
                                            <div style="margin-bottom: 0.75rem;">
                                                <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Name</div>
                                                <div style="font-weight: 600; color: #2d3748;">${booking.pet_name || 'N/A'}</div>
                                            </div>
                                            <div style="margin-bottom: 0.75rem;">
                                                <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Breed</div>
                                                <div style="font-weight: 600; color: #2d3748;">${booking.pet_breed || 'N/A'}</div>
                                            </div>
                                            ${booking.pet_details ? `
                                            <div style="margin-bottom: 0.75rem;">
                                                <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Age</div>
                                                <div style="font-weight: 600; color: #2d3748;">${booking.pet_details.age || 'N/A'} years</div>
                                            </div>
                                            <div style="margin-bottom: 0.75rem;">
                                                <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Gender</div>
                                                <div style="font-weight: 600; color: #2d3748;">${booking.pet_details.gender || 'N/A'}</div>
                                            </div>
                                            <div style="margin-bottom: 0.75rem;">
                                                <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Weight</div>
                                                <div style="font-weight: 600; color: #2d3748;">${booking.pet_details.weight || 'N/A'} kg</div>
                                            </div>
                                            <div style="margin-bottom: 0.75rem;">
                                                <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Spayed/Neutered</div>
                                                <div style="font-weight: 600; color: #2d3748;">${booking.pet_details.spayed_neutered || 'N/A'}</div>
                                            </div>
                                            <div style="margin-bottom: 0.75rem;">
                                                <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Medical Type</div>
                                                <div style="font-weight: 600; color: #2d3748;">${booking.pet_details.medical_type ? booking.pet_details.medical_type.replace(/_/g, ' ') : 'None'}</div>
                                            </div>
                                            <div style="margin-bottom: 0.75rem;">
                                                <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Medical Condition</div>
                                                <div style="font-weight: 600; color: #2d3748;">${booking.pet_details.medical_condition ? booking.pet_details.medical_condition.replace(/_/g, ' ') : 'None'}</div>
                                            </div>
                                            <div style="margin-bottom: 0.75rem;">
                                                <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Special Notes</div>
                                                <div style="font-weight: 600; color: #2d3748;">${booking.pet_details.special_notes || 'None'}</div>
                                            </div>
                                            <div style="margin-bottom: 0.75rem;">
                                                <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Vaccine</div>
                                                <div style="font-weight: 600; color: #2d3748;">${formatVaccineInfoWithDates(booking.pet_details.vaccine_name, booking.pet_details.vaccine_date)}</div>
                                            </div>
                                            <div style="margin-bottom: 0.75rem;">
                                                <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Pet Category</div>
                                                <div style="font-weight: 600; color: #2d3748;">${booking.pet_details.pet_category || 'N/A'}</div>
                                            </div>
                                            <div style="margin-bottom: 0.75rem;">
                                                <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Registration Date</div>
                                                <div style="font-weight: 600; color: #2d3748;">${booking.pet_details.created_at ? formatDate(booking.pet_details.created_at) : 'N/A'}</div>
                                            </div>
                                            ` : ''}
                                        </div>
                                    `}
                            </div>
                        </div>
                        
                        <!-- Service & Payment Information Row -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                            <!-- Service Information -->
                            <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem;">
                                <h3 style="margin: 0 0 1rem 0; color: #2d3748; font-size: 1.2rem; display: flex; align-items: center;">
                                    <i class="fas fa-concierge-bell" style="margin-right: 0.5rem; color: #667eea;"></i>
                                    Service Information
                                </h3>
                                <div style="space-y: 0.75rem;">
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Service</div>
                                        <div style="font-weight: 600; color: #2d3748;">${booking.service_name || 'N/A'}</div>
                                    </div>
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Category</div>
                                        <div style="font-weight: 600; color: #2d3748; background: #fef5e7; padding: 0.5rem; border-radius: 6px; display: inline-block;">${formatCategoryName(booking.service_category)}</div>
                                    </div>
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Price</div>
                                        <div style="font-weight: 600; color: #2d3748; background: #e6fffa; padding: 0.5rem; border-radius: 6px; display: inline-block; font-size: 1.1rem;">RM ${parseFloat(booking.total_amount || 0).toFixed(2)}</div>
                                    </div>
                                    ${booking.checkin_date ? `
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Check-in Date</div>
                                        <div style="font-weight: 600; color: #2d3748;">${formatDate(booking.checkin_date)}</div>
                                    </div>
                                    ` : ''}
                                    ${booking.checkout_date ? `
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Check-out Date</div>
                                        <div style="font-weight: 600; color: #2d3748;">${formatDate(booking.checkout_date)}</div>
                                    </div>
                                    ` : ''}
                                    ${booking.nights_count ? `
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Nights</div>
                                        <div style="font-weight: 600; color: #2d3748;">${booking.nights_count}</div>
                                    </div>
                                    ` : ''}
                                    ${booking.room_code ? `
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Room Code</div>
                                        <div style="font-weight: 600; color: #2d3748; background: #e6fffa; padding: 0.5rem; border-radius: 6px; display: inline-block;">${booking.room_code}</div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- Booking & Payment Information -->
                            <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem;">
                                <h3 style="margin: 0 0 1rem 0; color: #2d3748; font-size: 1.2rem; display: flex; align-items: center;">
                                    <i class="fas fa-calendar-alt" style="margin-right: 0.5rem; color: #667eea;"></i>
                                    Booking & Payment Details
                                </h3>
                                <div style="space-y: 0.75rem;">
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Date</div>
                                        <div style="font-weight: 600; color: #2d3748;">${formatDate(booking.booking_date)}</div>
                                    </div>
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Time</div>
                                        <div style="font-weight: 600; color: #2d3748;">${formatTime(booking.booking_time)}</div>
                                    </div>
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Status</div>
                                        <div style="font-weight: 600; color: #2d3748;"><span class="status-badge ${booking.booking_status}">${formatStatus(booking.booking_status)}</span></div>
                                    </div>
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Payment Method</div>
                                        <div style="font-weight: 600; color: #2d3748; background: #f0fff4; padding: 0.5rem; border-radius: 6px; display: inline-block;">${formatPaymentMethod(booking.payment_method)}</div>
                                    </div>
                                    ${booking.card_number ? `
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Card Number</div>
                                        <div style="font-weight: 600; color: #2d3748;">${booking.card_number}</div>
                                    </div>
                                    ` : ''}
                                    ${booking.card_name ? `
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Cardholder</div>
                                        <div style="font-weight: 600; color: #2d3748;">${booking.card_name}</div>
                                    </div>
                                    ` : ''}
                                    ${booking.card_expiry ? `
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Expiry</div>
                                        <div style="font-weight: 600; color: #2d3748;">${booking.card_expiry}</div>
                                    </div>
                                    ` : ''}
                                    ${booking.receipt_file_path ? `
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Receipt</div>
                                        <div style="font-weight: 600; color: #2d3748;"><a href="${booking.receipt_file_path}" target="_blank" style="color: #3b82f6;">View Receipt</a></div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                                
                        <!-- Notes Section -->
                        <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem;">
                            <h3 style="margin: 0 0 1rem 0; color: #2d3748; font-size: 1.2rem; display: flex; align-items: center;">
                                <i class="fas fa-sticky-note" style="margin-right: 0.5rem; color: #667eea;"></i>
                                Notes
                            </h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                                <div style="background: white; padding: 1rem; border-radius: 8px; border-left: 4px solid #48bb78;">
                                    <h4 style="margin: 0 0 0.75rem 0; color: #2d3748; font-size: 1rem;">Customer Notes</h4>
                                    <div style="color: #4a5568; line-height: 1.5;">${booking.additional_notes || 'No customer notes provided'}</div>
                                </div>
                                <div style="background: white; padding: 1rem; border-radius: 8px; border-left: 4px solid #ed8936;">
                                    <h4 style="margin: 0 0 0.75rem 0; color: #2d3748; font-size: 1rem;">Admin Notes</h4>
                                    <div style="color: #4a5568; line-height: 1.5;">${booking.admin_notes || 'No admin notes'}</div>
                                    ${booking.admin_images && booking.admin_images.length > 0 ? `
                                        <div style="margin-top: 1rem;">
                                            <h5 style="margin: 0 0 0.5rem 0; color: #2d3748; font-size: 0.9rem;">Admin Images:</h5>
                                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                                ${booking.admin_images.map(img => `
                                                    <img src="${img.image_path}" alt="Admin Note Image" 
                                                         style="max-width: 100px; max-height: 100px; border-radius: 4px; border: 1px solid #e2e8f0; cursor: pointer;"
                                                         onclick="window.open('${img.image_path}', '_blank')">
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- Footer -->
                    <div style="background: #f8fafc; border-top: 1px solid #e2e8f0; padding: 1.5rem 2rem; border-radius: 0 0 16px 16px;">
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button onclick="closeBookingDetailsModal()" style="padding: 0.75rem 2rem; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;">
                                Close
                            </button>
                        </div>
                    </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Close booking details modal
        function closeBookingDetailsModal() {
            const modals = document.querySelectorAll('.modal');
            // Find the booking details modal specifically
            modals.forEach(modal => {
                if (modal.innerHTML.includes('Booking Details #')) {
                    document.body.classList.remove('modal-open');
                    modal.remove();
                }
            });
        }

        // Update booking status with proper modal interface
        async function updateBookingStatus(bookingId) {
            // Find the booking to get its details
            const booking = allBookings.find(b => b.id == bookingId);
            if (!booking) {
                alert('Booking not found');
                return;
            }

            // Create status update modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeStatusUpdateModal()"></div>
                <div class="modal-content" style="max-width: 500px; background: #ffffff; color: #000000;">
                    <div class="modal-header">
                        <h3>Update Booking Status</h3>
                        <button class="modal-close" onclick="closeStatusUpdateModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div style="margin-bottom: 1.5rem;">
                            <p style="margin-bottom: 0.5rem; color: #4a5568;"><strong>Booking Reference:</strong> #${booking.booking_reference || booking.id}</p>
                            <p style="margin-bottom: 0.5rem; color: #4a5568;"><strong>Service:</strong> ${booking.service_name}</p>
                            <p style="margin-bottom: 0.5rem; color: #4a5568;"><strong>Pet${(booking.all_pets && booking.all_pets.length > 1) ? 's (' + booking.all_pets.length + ')' : ''}:</strong> ${(booking.all_pets && booking.all_pets.length > 0) ? booking.all_pets.map(pet => pet.name).join(', ') : (booking.pet_name || 'N/A')}</p>
                            <p style="margin-bottom: 1rem; color: #4a5568;"><strong>Current Status:</strong> <span class="status-badge ${booking.booking_status}">${formatStatus(booking.booking_status)}</span></p>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2d3748;">Select New Status:</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                                <button class="status-btn" data-status="pending" style="padding: 0.75rem; border: 2px solid #f59e0b; background: #fef3c7; color: #92400e; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                    <i class="fas fa-clock" style="margin-right: 0.5rem;"></i>
                                    Pending
                                </button>
                                <button class="status-btn" data-status="confirmed" style="padding: 0.75rem; border: 2px solid #10b981; background: #d1fae5; color: #065f46; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                    <i class="fas fa-check" style="margin-right: 0.5rem;"></i>
                                    Confirmed
                                </button>
                                <button class="status-btn" data-status="completed" style="padding: 0.75rem; border: 2px solid #8b5cf6; background: #ede9fe; color: #5b21b6; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                    <i class="fas fa-check-double" style="margin-right: 0.5rem;"></i>
                                    Completed
                                </button>
                                <button class="status-btn" data-status="cancelled" style="padding: 0.75rem; border: 2px solid #ef4444; background: #fee2e2; color: #991b1b; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                    <i class="fas fa-times" style="margin-right: 0.5rem;"></i>
                                    Cancelled
                                </button>
                            </div>
                        </div>
                        
                        <div style="padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                <button onclick="closeStatusUpdateModal()" style="padding: 0.75rem 1.5rem; background: #f8f9fa; color: #718096; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer;">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.body.classList.add('modal-open');
            
            // Add hover effects and click handlers for status buttons
            const statusButtons = modal.querySelectorAll('.status-btn');
            statusButtons.forEach(btn => {
                btn.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
                });
                
                btn.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = 'none';
                });
                
                btn.addEventListener('click', function() {
                    const newStatus = this.dataset.status;
                    updateBookingStatusConfirm(bookingId, newStatus, booking.booking_type || 'service');
                });
            });
        }

        // Confirm and execute status update
        async function updateBookingStatusConfirm(bookingId, newStatus, bookingType) {
            try {
                const formData = new FormData();
                formData.append('action', 'update_status');
                formData.append('booking_id', bookingId);
                formData.append('new_status', newStatus);
                formData.append('booking_type', bookingType);
                
                const response = await fetch('bookings.php', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Close modal
                    closeStatusUpdateModal();
                    
                    // Show success notification
                    showNotification('success', 'Status Updated', `Booking status updated to ${formatStatus(newStatus)} successfully!`);
                    
                    // Reload bookings
                    loadBookings();
                } else {
                    alert('Failed to update booking status: ' + result.message);
                }
            } catch (error) {
                console.error('Error updating booking status:', error);
                alert('Error updating booking status');
            }
        }

        // Close status update modal
        function closeStatusUpdateModal() {
            const modals = document.querySelectorAll('.modal');
            // Find the status update modal specifically
            modals.forEach(modal => {
                if (modal.innerHTML.includes('Update Booking Status')) {
                document.body.classList.remove('modal-open');
                modal.remove();
            }
            });
        }

        // Show notification function
        function showNotification(type, title, message, duration = 5000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification__header">
                    <h4 class="notification__title">${title}</h4>
                    <button class="notification__close" onclick="this.parentElement.parentElement.remove()">
                        <i class="ri-close-line"></i>
                    </button>
                </div>
                <p class="notification__message">${message}</p>
            `;
            
            document.body.appendChild(notification);
            
            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Auto remove after duration
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }, duration);
        }

        // Delete booking
        async function deleteBooking(bookingId) {
            if (!confirm('Are you sure you want to delete this booking? This will hide it from admin view but keep it visible to the customer.')) {
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('action', 'delete');
                formData.append('booking_id', bookingId);
                
                const response = await fetch('bookings.php', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('success', 'Booking Deleted', 'Booking hidden from admin view successfully');
                    loadBookings(); // Reload bookings
                } else {
                    showNotification('error', 'Delete Failed', 'Failed to delete booking: ' + result.message);
                }
            } catch (error) {
                console.error('Error deleting booking:', error);
                showNotification('error', 'Delete Error', 'Error deleting booking. Please try again.');
            }
        }

        // Notes functionality
        let currentBookingId = null;
        let currentBookingType = 'service'; // Default to service
        
        function openNotesModal(bookingId) {
            currentBookingId = bookingId;
            currentBookingType = 'service'; // Service bookings use this modal
            document.getElementById('bookingId').value = bookingId;
            document.getElementById('notesModal').style.display = 'flex';
            document.body.classList.add('modal-open');
            
            // Load existing notes and images
            loadBookingNotes(bookingId);
        }
        
        function hideNotesModal() {
            document.getElementById('notesModal').style.display = 'none';
            document.body.classList.remove('modal-open');
            
            // Clear form
            document.getElementById('notesForm').reset();
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('existingImages').innerHTML = '';
            currentBookingId = null;
            currentBookingType = 'service';
        }
        
        async function loadBookingNotes(bookingId) {
            try {
                const response = await fetch('booking_notes.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `action=get_notes&booking_id=${bookingId}&booking_type=${currentBookingType || 'service'}`
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Load notes text
                    if (result.data.notes) {
                        document.getElementById('notesText').value = result.data.notes;
                    }
                    
                    // Load existing images
                    displayExistingImages(result.data.images || []);
                } else {
                    console.error('Failed to load notes:', result.message);
                }
            } catch (error) {
                console.error('Error loading notes:', error);
            }
        }
        
        function displayExistingImages(images) {
            const container = document.getElementById('existingImages');
            
            if (images.length === 0) {
                container.innerHTML = '<p style="color: #718096; font-style: italic;">No images uploaded yet</p>';
                return;
            }
            
            container.innerHTML = images.map(image => `
                <div class="existing-image-item">
                    <img src="${image.image_path}" alt="Booking image" onclick="viewImage('${image.image_path}')">
                    <button type="button" class="delete-image-btn" onclick="deleteImage('${currentBookingId}', '${currentBookingType}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }
        
        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }
        
        function removeImage() {
            document.getElementById('notesImage').value = '';
            document.getElementById('imagePreview').style.display = 'none';
        }
        
        // Hotel booking image preview functions
        function previewHotelImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('hotelPreviewImg').src = e.target.result;
                    document.getElementById('hotelImagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }
        
        function removeHotelImage() {
            document.getElementById('hotelNotesImage').value = '';
            document.getElementById('hotelImagePreview').style.display = 'none';
        }
        
        async function deleteImage(bookingId, bookingType) {
            if (!confirm('Are you sure you want to delete this image?')) {
                return;
            }
            
            try {
                const response = await fetch('booking_notes.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `action=delete_image&booking_id=${bookingId}&booking_type=${bookingType || currentBookingType || 'service'}`
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Reload existing images
                    loadBookingNotes(bookingId);
                } else {
                    showNotification('error', 'Delete Failed', 'Failed to delete image: ' + result.message);
                }
            } catch (error) {
                console.error('Error deleting image:', error);
                showNotification('error', 'Delete Error', 'Error deleting image. Please try again.');
            }
        }
        
        function viewImage(imagePath) {
            // Open image in new tab
            window.open(imagePath, '_blank');
        }
        
        async function saveNotes(event) {
            event.preventDefault();
            
            const formData = new FormData();
            formData.append('action', 'save_notes');
            formData.append('booking_id', currentBookingId);
            formData.append('booking_type', currentBookingType || 'service');
            formData.append('notes', document.getElementById('notesText').value);
            
            // Add image if selected
            const imageFile = document.getElementById('notesImage').files[0];
            if (imageFile) {
                formData.append('image', imageFile);
            }
            
            // Show loading state
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoading = submitBtn.querySelector('.btn-loading');
            
            btnText.style.display = 'none';
            btnLoading.style.display = 'flex';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch('booking_notes.php', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Notes saved successfully');
                    hideNotesModal();
                } else {
                    alert('Failed to save notes: ' + result.message);
                }
            } catch (error) {
                console.error('Error saving notes:', error);
                alert('Error saving notes');
            } finally {
                // Reset button state
                btnText.style.display = 'flex';
                btnLoading.style.display = 'none';
                submitBtn.disabled = false;
            }
        }

        // Download receipt directly
        function downloadReceipt(receiptPath, bookingReference) {
            if (!receiptPath) {
                showNotification('error', 'No Receipt', 'No receipt file available for this booking');
                return;
            }
            
            try {
                // Create a temporary link element to trigger download
                const link = document.createElement('a');
                link.href = receiptPath;
                link.download = bookingReference ? `receipt_${bookingReference}.pdf` : (receiptPath.split('/').pop() || 'receipt');
                link.target = '_blank';
                
                // Append to body, click, and remove
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // No success message - silent download
            } catch (error) {
                console.error('Error downloading receipt:', error);
                showNotification('error', 'Download Failed', 'Failed to download receipt');
            }
        }

        // View receipt
        function viewReceipt(receiptPath) {
            if (!receiptPath) {
                alert('No receipt available for this booking');
                return;
            }
            
            // Determine file type
            const fileExtension = receiptPath.split('.').pop().toLowerCase();
            const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExtension);
            const isPDF = fileExtension === 'pdf';
            
            // Create a modal to display the receipt
            const modal = document.createElement('div');
            modal.className = 'modal receipt-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.1);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                /* Removed animation to prevent scroll jumping */
                /* animation: modalFadeIn 0.3s ease-out; */
                padding: 20px;
                box-sizing: border-box;
            `;
            
            // Create content based on file type
            let contentHTML = '';
            
            if (isImage) {
                contentHTML = `
                    <div class="modal__content" style="
                        background: rgba(255, 255, 255, 0.98);
                        border-radius: 12px;
                        padding: 1.5rem;
                        max-width: 80%;
                        max-height: 85vh;
                        width: 600px;
                        height: 70vh;
                        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                        border: 3px solid rgba(255, 255, 255, 0.8);
                        position: relative;
                        /* Removed animation to prevent scroll jumping */
                        /* animation: modalSlideIn 0.3s ease-out; */
                        display: flex;
                        flex-direction: column;
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0; color: #2d3748; font-size: 1.25rem;">Payment Receipt</h3>
                            <button onclick="closeReceiptModal()" style="
                                background: none;
                                border: none;
                                font-size: 1.25rem;
                                cursor: pointer;
                                color: #718096;
                                padding: 0.5rem;
                                border-radius: 50%;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.backgroundColor='#f8f9fa'; this.style.color='#2d3748'" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#718096'">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div style="flex: 1; text-align: center; min-height: 0; display: flex; align-items: center; justify-content: center; overflow: hidden; padding: 1rem;">
                            <img src="${receiptPath}" style="
                                max-width: 100%;
                                max-height: 100%;
                                width: auto;
                                height: auto;
                                border-radius: 8px;
                                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                                object-fit: contain;
                                display: block;
                            " alt="Payment Receipt">
                        </div>
                        
                        <div style="margin-top: 1rem; flex-shrink: 0;">
                            <a href="${receiptPath}" target="_blank" style="
                                display: inline-flex;
                                align-items: center;
                                gap: 0.5rem;
                                padding: 0.75rem 1.5rem;
                                background: #38a169;
                                color: white;
                                text-decoration: none;
                                border-radius: 8px;
                                font-weight: 500;
                                transition: all 0.2s ease;
                                font-size: 0.9rem;
                            " onmouseover="this.style.backgroundColor='#2f855a'" onmouseout="this.style.backgroundColor='#38a169'">
                                <i class="fas fa-external-link-alt"></i>
                                Open in New Tab
                            </a>
                        </div>
                    </div>
                `;
            } else if (isPDF) {
                contentHTML = `
                    <div class="modal__content" style="
                        background: rgba(255, 255, 255, 0.98);
                        border-radius: 12px;
                        padding: 1.5rem;
                        max-width: 80%;
                        max-height: 85vh;
                        width: 600px;
                        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                        border: 3px solid rgba(255, 255, 255, 0.8);
                        position: relative;
                        /* Removed animation to prevent scroll jumping */
                        /* animation: modalSlideIn 0.3s ease-out; */
                        display: flex;
                        flex-direction: column;
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0; color: #2d3748; font-size: 1.25rem;">Payment Receipt</h3>
                            <button onclick="closeReceiptModal()" style="
                                background: none;
                                border: none;
                                font-size: 1.25rem;
                                cursor: pointer;
                                color: #718096;
                                padding: 0.5rem;
                                border-radius: 50%;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.backgroundColor='#f8f9fa'; this.style.color='#2d3748'" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#718096'">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div style="flex: 1; text-align: center; min-height: 0;">
                            <iframe src="${receiptPath}#toolbar=0&navpanes=0&scrollbar=0&view=FitH" style="
                                width: 100%;
                                height: 100%;
                                min-height: 300px;
                                max-height: 400px;
                                border: none;
                                border-radius: 8px;
                                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                                background: white;
                            "></iframe>
                        </div>
                        
                        <div style="margin-top: 1rem; flex-shrink: 0;">
                            <a href="${receiptPath}" target="_blank" style="
                                display: inline-flex;
                                align-items: center;
                                gap: 0.5rem;
                                padding: 0.75rem 1.5rem;
                                background: #38a169;
                                color: white;
                                text-decoration: none;
                                border-radius: 8px;
                                font-weight: 500;
                                transition: all 0.2s ease;
                                font-size: 0.9rem;
                            " onmouseover="this.style.backgroundColor='#2f855a'" onmouseout="this.style.backgroundColor='#38a169'">
                                <i class="fas fa-external-link-alt"></i>
                                Open in New Tab
                            </a>
                        </div>
                    </div>
                `;
            } else {
                // Fallback for other file types
                contentHTML = `
                    <div class="modal__content" style="
                        background: rgba(255, 255, 255, 0.98);
                        border-radius: 12px;
                        padding: 1.5rem;
                        max-width: 80%;
                        max-height: 85vh;
                        width: 600px;
                        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                        border: 3px solid rgba(255, 255, 255, 0.8);
                        position: relative;
                        /* Removed animation to prevent scroll jumping */
                        /* animation: modalSlideIn 0.3s ease-out; */
                        display: flex;
                        flex-direction: column;
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0; color: #2d3748; font-size: 1.25rem;">Payment Receipt</h3>
                            <button onclick="closeReceiptModal()" style="
                                background: none;
                                border: none;
                                font-size: 1.25rem;
                                cursor: pointer;
                                color: #718096;
                                padding: 0.5rem;
                                border-radius: 50%;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.backgroundColor='#f8f9fa'; this.style.color='#2d3748'" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#718096'">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div style="flex: 1; text-align: center; min-height: 0; display: flex; align-items: center; justify-content: center;">
                            <div style="text-align: center; color: #718096;">
                                <i class="fas fa-file-alt" style="font-size: 3rem; margin-bottom: 1rem; color: #cbd5e0;"></i>
                                <p style="margin: 0; font-size: 1.1rem;">Receipt file preview not available</p>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">Click "Open in New Tab" to view the file</p>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1rem; flex-shrink: 0;">
                            <a href="${receiptPath}" target="_blank" style="
                                display: inline-flex;
                                align-items: center;
                                gap: 0.5rem;
                                padding: 0.75rem 1.5rem;
                                background: #38a169;
                                color: white;
                                text-decoration: none;
                                border-radius: 8px;
                                font-weight: 500;
                                transition: all 0.2s ease;
                                font-size: 0.9rem;
                            " onmouseover="this.style.backgroundColor='#2f855a'" onmouseout="this.style.backgroundColor='#38a169'">
                                <i class="fas fa-external-link-alt"></i>
                                Open in New Tab
                            </a>
                        </div>
                    </div>
                `;
            }
            
            modal.innerHTML = contentHTML;
            
            // Add modal styles if not already present
            if (!document.getElementById('receipt-modal-styles')) {
                const style = document.createElement('style');
                style.id = 'receipt-modal-styles';
                style.textContent = `
                    /* Removed animations to prevent scroll jumping */
                    /* @keyframes modalFadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    
                    @keyframes modalSlideIn {
                        from { 
                            opacity: 0; 
                            transform: scale(0.9) translateY(-20px); 
                        }
                        to { 
                            opacity: 1; 
                            transform: scale(1) translateY(0); 
                        }
                    } */
                    
                    body.modal-open {
                        overflow: hidden !important;
                        /* Remove position: fixed to prevent scroll jump */
                        /* position: fixed !important; */
                        /* width: 100% !important; */
                        /* height: 100% !important; */
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Add body scroll lock
            document.body.classList.add('modal-open');
            
            // Add click outside to close
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeReceiptModal();
                }
            });
            
            // Add escape key to close
            const escapeHandler = function(e) {
                if (e.key === 'Escape') {
                    closeReceiptModal();
                }
            };
            document.addEventListener('keydown', escapeHandler);
            
            // Store handlers for cleanup
            modal._escapeHandler = escapeHandler;
            
            document.body.appendChild(modal);
        }

        // Send confirmation email
        async function sendConfirmationEmail(bookingId) {
            if (!confirm('Send confirmation email for this booking?')) {
                return;
            }
            
            try {
                const response = await fetch('bookings.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `action=send_confirmation_email&booking_id=${bookingId}`
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Confirmation email sent successfully!');
                } else {
                    alert('Failed to send confirmation email: ' + result.message);
                }
            } catch (error) {
                console.error('Error sending confirmation email:', error);
                alert('Error sending confirmation email. Please try again.');
            }
        }
        
        // Close receipt modal
        function closeReceiptModal() {
            const modal = document.querySelector('.receipt-modal');
            if (modal) {
                // Remove event listeners
                if (modal._escapeHandler) {
                    document.removeEventListener('keydown', modal._escapeHandler);
                }
                
                // Remove body scroll lock
                document.body.classList.remove('modal-open');
                
                // Remove modal
                modal.remove();
            }
        }

        // Show booking error
        function showBookingError(message) {
            const bookingsTable = document.getElementById('bookingsTable');
            const bookingsTableBody = document.getElementById('bookingsTableBody');
            const bookingsLoading = document.getElementById('bookingsLoading');
            
            bookingsLoading.style.display = 'none';
            bookingsTable.style.display = 'table';
            
            bookingsTableBody.innerHTML = `
                <tr>
                    <td colspan="9" style="text-align: center; padding: 2rem; color: #e53e3e;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p style="margin: 0;">${message}</p>
                        <button onclick="loadBookings()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            <i class="fas fa-retry"></i> Try Again
                        </button>
                    </td>
                </tr>
            `;
        }

        // Format category names for display
        function formatCategoryName(category) {
            if (!category) return '';
            return category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        // Load services from database
        async function loadServices() {
            try {
                const response = await fetch('pet_services.php?action=list');
                const result = await response.json();
                
                if (result.success && Array.isArray(result.data)) {
                    allServices = result.data;
                    filteredServices = [...allServices];
                    
                    // Populate category filter dropdown
                    populateCategoryFilter();
                    
                    displayServices(filteredServices);
                    updateSearchResults('');
                } else {
                    console.error('Failed to load services:', result.message);
                    // Initialize empty arrays to prevent errors
                    allServices = [];
                    filteredServices = [];
                    displayServices([]);
                    updateSearchResults('');
                }
            } catch (error) {
                console.error('Error loading services:', error);
                // Initialize empty arrays to prevent errors
                allServices = [];
                filteredServices = [];
                displayServices([]);
                updateSearchResults('');
            }
        }
        
        // Populate category filter dropdown
        function populateCategoryFilter() {
            const categoryFilter = document.getElementById('servicesCategoryFilter');
            if (!categoryFilter) return;
            
            // Get unique categories from services
            const categories = [...new Set(allServices
                .map(service => service.service_category)
                .filter(category => category && category.trim() !== '')
            )].sort();
            
            // Clear existing options except "All Categories"
            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            
            // Add category options
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = formatCategoryName(category);
                categoryFilter.appendChild(option);
            });
        }

        // Cat Hotel Slots Data
        let allHotelSlots = [];
        let filteredHotelSlots = [];
        let hotelRoomsData = [];

        // Load cat hotel rooms (from backend)
        async function loadHotelSlots() {
            try {
                const res = await fetch('hotel_rooms.php?action=list');
                const result = await res.json();
                if (!result.success) throw new Error(result.message || 'Failed to load');
                hotelRoomsData = result.data || [];
                renderHotelRooms(hotelRoomsData);
            } catch (error) {
                console.error('Error loading hotel slots:', error);
                showHotelError('Error loading cat hotel rooms.');
            }
        }

        function renderHotelRooms(data) {
            const loading = document.getElementById('hotelLoading');
            const container = document.getElementById('hotelRooms');
            loading.style.display = 'none';
            container.style.display = 'block';

            renderHotelCategory('Classic Suite Rooms', 'hotelClassic', data.filter(r => r.category === 'classic'));
            renderHotelCategory('Deluxe Rooms', 'hotelDeluxe', data.filter(r => r.category === 'deluxe'));
            renderHotelCategory('Executive Rooms', 'hotelExecutive', data.filter(r => r.category === 'executive'));
            renderHotelCategory('Studio Suite', 'hotelDayCare', data.filter(r => r.category === 'day_care'));
            // If no rooms yet, show a friendly empty state
            if (!data || data.length === 0) {
                document.getElementById('hotelClassic').innerHTML = `
                    <div style=\"margin-bottom:0.5rem; font-weight:600; color:#2d3748;\">Classic Suite  Rooms (0 Total)</div>
                    <div style=\"text-align:center; color:#718096; padding: 1rem; border:1px dashed #e5e7eb; border-radius:8px;\">No rooms yet. Click \"Add Rooms\" to create rooms.</div>`;
                document.getElementById('hotelDeluxe').innerHTML = `
                    <div style=\"margin-bottom:0.5rem; font-weight:600; color:#2d3748;\">Deluxe Rooms (0 Total)</div>
                    <div style=\"text-align:center; color:#718096; padding: 1rem; border:1px dashed #e5e7eb; border-radius:8px;\">No rooms yet. Click \"Add Rooms\" to create rooms.</div>`;
                document.getElementById('hotelExecutive').innerHTML = `
                    <div style=\"margin-bottom:0.5rem; font-weight:600; color:#2d3748;\">Executive Rooms (0 Total)</div>
                    <div style=\"text-align:center; color:#718096; padding: 1rem; border:1px dashed #e5e7eb; border-radius:8px;\">No rooms yet. Click \"Add Rooms\" to create rooms.</div>`;
                document.getElementById('hotelDayCare').innerHTML = `
                    <div style=\"margin-bottom:0.5rem; font-weight:600; color:#2d3748;\">Studio Suite (0 Total)</div>
                    <div style=\"text-align:center; color:#718096; padding: 1rem; border:1px dashed #e5e7eb; border-radius:8px;\">No rooms yet. Click \"Add Rooms\" to create rooms.</div>`;
            }
        }

        function renderHotelCategory(title, targetId, rooms) {
            const target = document.getElementById(targetId);
            if (!target) return;
            const total = rooms.length;
            const html = `
                <div style="margin-bottom:0.5rem; font-weight:600; color:#2d3748;">${title} (${total} Total)</div>
                <div class="room-grid">
                    ${rooms.map(r => `
                        <div class="room-card ${r.status}" onclick="openRoomModal('${r.id}')">
                            <span class="room-id">${r.displayId}</span>
                            <span class="room-capacity">${r.occupants > 0 ? `${r.occupants} ${r.occupants === 1 ? 'cat' : 'cats'}` : ''}</span>
                            ${r.note ? `<span class=\"room-note\" title=\"${r.note}\">${r.note}</span>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
            target.innerHTML = html;
        }

        function generateSampleHotelRooms() {
            // Create C01..C20, D01..D15, E01..E10 with statuses
            const mk = (prefix, count, category) => Array.from({length: count}, (_, i) => {
                const num = (i+1).toString().padStart(2,'0');
                return {
                    id: `${prefix}${num}`,
                    displayId: `${prefix}${num}`,
                    category,
                    status: 'available',
                    occupants: 0,
                    name: category === 'deluxe' ? 'Friendly Cat Corner' : ''
                };
            });
            const classic = mk('C', 20, 'classic');
            const deluxe = mk('D', 15, 'deluxe');
            const executive = mk('E', 10, 'executive');
            // Sample occupied/maintenance
            setRoom(classic, 'C02', 'occupied', 2);
            setRoom(classic, 'C01', 'maintenance', 0);
            setRoom(deluxe, 'D05', 'occupied', 1);
            setRoom(deluxe, 'D01', 'maintenance', 0);
            setRoom(executive, 'E03', 'occupied', 3);
            setRoom(executive, 'E01', 'maintenance', 0);
            return [...classic, ...deluxe, ...executive];
        }

        function setRoom(list, id, status, occupants) {
            const r = list.find(x => x.id === id);
            if (r) { r.status = status; r.occupants = occupants || 0; }
        }

        function searchHotelSlots(term) {
            // Get the current filter value
            const typeFilter = document.getElementById('hotelTypeFilter');
            const selectedType = typeFilter ? typeFilter.value : '';
            
            let rooms = hotelRoomsData;
            
            // Apply type filter first
            if (selectedType && selectedType.trim() !== '') {
                const categoryMap = {
                    'classic_suite': 'classic',
                    'deluxe_suite': 'deluxe',
                    'executive_suite': 'executive',
                    'day_care': 'studio_suite'
                };
                const category = categoryMap[selectedType];
                if (category) {
                    rooms = rooms.filter(r => r.category === category);
                }
            }
            
            // Apply search term filter
            if (!term || term.trim() === '') {
                filteredHotelSlots = rooms;
            } else {
                const q = term.toLowerCase().trim();
                filteredHotelSlots = rooms.filter(s =>
                    (s.displayId && s.displayId.toLowerCase().includes(q)) ||
                    (s.id && s.id.toLowerCase().includes(q)) ||
                    (s.category && formatCategoryName(s.category).toLowerCase().includes(q)) ||
                    (s.note && s.note.toLowerCase().includes(q))
                );
            }
            displayHotelSlots(filteredHotelSlots);
            updateHotelSearchResults(term);
        }

        function filterHotelByType(type) {
            // Get the current search term
            const searchInput = document.getElementById('hotelSearchInput');
            const searchTerm = searchInput ? searchInput.value : '';
            
            // Reapply both filters
            searchHotelSlots(searchTerm);
        }
        
        // Display filtered hotel slots
        function displayHotelSlots(rooms) {
            if (!rooms || rooms.length === 0) {
                // Show empty state
                const hotelClassic = document.getElementById('hotelClassic');
                const hotelDeluxe = document.getElementById('hotelDeluxe');
                const hotelExecutive = document.getElementById('hotelExecutive');
                const hotelDayCare = document.getElementById('hotelDayCare');
                
                if (hotelClassic) hotelClassic.innerHTML = '<div style="text-align:center; color:#718096; padding: 1rem; border:1px dashed #e5e7eb; border-radius:8px;">No rooms found matching filters.</div>';
                if (hotelDeluxe) hotelDeluxe.innerHTML = '<div style="text-align:center; color:#718096; padding: 1rem; border:1px dashed #e5e7eb; border-radius:8px;">No rooms found matching filters.</div>';
                if (hotelExecutive) hotelExecutive.innerHTML = '<div style="text-align:center; color:#718096; padding: 1rem; border:1px dashed #e5e7eb; border-radius:8px;">No rooms found matching filters.</div>';
                if (hotelDayCare) hotelDayCare.innerHTML = '<div style="text-align:center; color:#718096; padding: 1rem; border:1px dashed #e5e7eb; border-radius:8px;">No rooms found matching filters.</div>';
                return;
            }
            
            // Render filtered rooms
            renderHotelRooms(rooms);
        }

        function updateHotelSearchResults(term) {
            const el = document.getElementById('hotelSearchResults');
            if (!el) return;
            
            const typeFilter = document.getElementById('hotelTypeFilter');
            const selectedType = typeFilter ? typeFilter.value : '';
            const hasFilter = (term && term.trim() !== '') || (selectedType && selectedType.trim() !== '');
            
            if (hasFilter) {
                let filterText = '';
                if (term && term.trim() !== '') {
                    filterText += `"${term}"`;
                }
                if (selectedType && selectedType.trim() !== '') {
                    if (filterText) filterText += ' + ';
                    const categoryMap = {
                        'classic_suite': 'Classic Suites',
                        'deluxe_suite': 'Deluxe Suites',
                        'executive_suite': 'Executive Suites',
                        'day_care': 'Studio Suite'
                    };
                    filterText += categoryMap[selectedType] || selectedType;
                }
                el.innerHTML = `
                    <i class="fas fa-filter"></i>
                    Found ${filteredHotelSlots.length} of ${hotelRoomsData.length} rooms
                    ${filterText ? `for ${filterText}` : ''}
                `;
            } else {
                el.innerHTML = `
                    <i class="fas fa-bed"></i>
                    Showing all ${hotelRoomsData.length} rooms
                `;
            }
        }

        function clearHotelFilters() {
            const input = document.getElementById('hotelSearchInput');
            const typeFilter = document.getElementById('hotelTypeFilter');
            if (input) input.value = '';
            if (typeFilter) typeFilter.value = '';
            filteredHotelSlots = [...hotelRoomsData];
            displayHotelSlots(filteredHotelSlots);
            updateHotelSearchResults('');
        }

        function refreshHotelSlots() {
            // Show loading placeholder again
            const hotelLoading = document.getElementById('hotelLoading');
            const hotelRooms = document.getElementById('hotelRooms');
            if (hotelLoading && hotelRooms) {
                hotelLoading.style.display = 'block';
                hotelRooms.style.display = 'none';
            }
            loadHotelSlots();
        }

        function showHotelError(message) {
            const hotelTable = document.getElementById('hotelTable');
            const hotelTableBody = document.getElementById('hotelTableBody');
            const hotelLoading = document.getElementById('hotelLoading');
            hotelLoading.style.display = 'none';
            const hotelRooms = document.getElementById('hotelRooms');
            hotelRooms.style.display = 'block';
            hotelTableBody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 2rem; color: #e53e3e;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p style="margin: 0;">${message}</p>
                        <button onclick="refreshHotelSlots()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Try Again
                        </button>
                    </td>
                </tr>
            `;
        }

        // Room Details Modal
        function openRoomModal(roomId) {
            const room = hotelRoomsData.find(r => r.id === roomId);
            if (!room) return;
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeRoomModal(this.closest('.modal'))"></div>
                <div class="modal-content enhanced-modal" style="max-width: 420px; min-width: auto;">
                    <div class="modal-header">
                        <div class="modal-title">
                            <i class="fas fa-door-closed"></i>
                            <h3>Room ${room.displayId} Details</h3>
                        </div>
                        <button class="modal-close" onclick="closeRoomModal(this.closest('.modal'))"><i class="fas fa-times"></i></button>
                    </div>
                    <form style="padding:0.6rem;">
                        <div class="form-group" style="margin-bottom:0.5rem;">
                            <label style="font-size:0.85rem;">Room Status</label>
                            <select id="roomStatusSelect" style="padding:0.5rem; font-size:0.95rem;">
                                <option value="available" ${room.status==='available'?'selected':''}>Available</option>
                                <option value="occupied" ${room.status==='occupied'?'selected':''}>Occupied</option>
                                <option value="maintenance" ${room.status==='maintenance'?'selected':''}>Maintenance</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom:0.5rem;">
                            <label style="font-size:0.85rem;">Current Occupants <small style="color:#718096;">(Auto-updated from bookings)</small></label>
                            <input type="text" id="roomOccupantsInput" value="${room.occupants} cat${room.occupants !== 1 ? 's' : ''}" readonly style="padding:0.5rem; font-size:0.95rem; background:#f7fafc; color:#4a5568; cursor:not-allowed;" />
                        </div>
                        <div class="form-group" style="margin-bottom:0.5rem;">
                            <label style="font-size:0.85rem;">Room Notes</label>
                            <textarea id="roomNoteInput" rows="3" style="padding:0.5rem; font-size:0.95rem; width:100%; box-sizing:border-box;">${(room.note || '').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</textarea>
                        </div>
                        <div class="modal-actions" style="justify-content:space-between; gap:0.5rem; align-items:center;">
                            <button type="button" class="btn-delete" onclick="deleteRoom('${room.id}', this)">
                                <i class="fas fa-trash"></i> Delete Room
                            </button>
                            <div style="display: flex; gap: 0.5rem; align-items:center;">
                                <button type="button" class="btn-cancel" onclick="closeRoomModal(this.closest('.modal'))">Cancel</button>
                                <button type="button" class="btn-save" onclick="saveRoomStatus('${room.id}', this)">Save</button>
                            </div>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            document.body.classList.add('modal-open');
        }

        function closeRoomModal(modal) {
            if (modal) {
                modal.remove();
            }
            document.body.classList.remove('modal-open');
        }

        async function saveRoomStatus(roomId, btnEl) {
            // Prefer the modal that contains the clicked button to avoid removing the wrong one
            let modal = btnEl ? btnEl.closest('.modal') : null;
            if (!modal) {
                const modals = Array.from(document.querySelectorAll('.modal'));
                modal = modals[modals.length - 1] || null;
            }
            const status = document.getElementById('roomStatusSelect').value;
            const note = (document.getElementById('roomNoteInput')?.value || '').trim();
            const room = hotelRoomsData.find(r => r.id === roomId);
            if (!room) return;
            try {
                const formData = new FormData();
                formData.append('action','update_room');
                formData.append('code', room.id);
                formData.append('status', status);
                // Note: occupants is removed - it's auto-updated from bookings
                formData.append('note', note);
                const res = await fetch('hotel_rooms.php', { method:'POST', body: formData });
                const result = await res.json();
                if(!result.success) throw new Error(result.message || 'Failed to update');
                room.status = status;
                // Note: occupants not updated - it's auto-managed from bookings
                room.note = note;
                renderHotelRooms(hotelRoomsData);
                if (modal) closeRoomModal(modal);
            } catch (e) {
                alert('Failed to save: ' + e.message);
            }
        }

        async function deleteRoom(roomId, btnEl) {
            const room = hotelRoomsData.find(r => r.id === roomId);
            if (!room) return;
            
            // Show confirmation dialog
            const confirmed = confirm(`Are you sure you want to delete room ${room.displayId}?\n\nThis action cannot be undone.`);
            if (!confirmed) return;
            
            // Show second confirmation for occupied rooms
            if (room.status === 'occupied' && room.occupants > 0) {
                const doubleConfirm = confirm(`WARNING: Room ${room.displayId} is currently occupied with ${room.occupants} cat(s).\n\nAre you absolutely sure you want to delete this room?`);
                if (!doubleConfirm) return;
            }
            
            try {
                const formData = new FormData();
                formData.append('action', 'delete_room');
                formData.append('code', room.id);
                
                const res = await fetch('hotel_rooms.php', { method: 'POST', body: formData });
                const result = await res.json();
                
                if (!result.success) {
                    throw new Error(result.message || 'Failed to delete room');
                }
                
                // Remove room from local data
                const roomIndex = hotelRoomsData.findIndex(r => r.id === roomId);
                if (roomIndex !== -1) {
                    hotelRoomsData.splice(roomIndex, 1);
                }
                
                // Refresh the display
                renderHotelRooms(hotelRoomsData);
                
                // Close the modal
                const modal = btnEl.closest('.modal');
                closeRoomModal(modal);
                
                // Show success message
                alert(`Room ${room.displayId} has been deleted successfully.`);
                
            } catch (e) {
                alert('Failed to delete room: ' + e.message);
            }
        }

        // Add Rooms Modal handlers
        function showAddHotelRoomsModal() {
            // Open modal and fetch categories
            const modal = document.getElementById('addHotelRoomsModal');
            if (modal) {
                modal.style.display = 'flex';
                document.body.classList.add('modal-open');
            }
            fetchHotelCategories();
        }

        function hideAddHotelRoomsModal() {
            const modal = document.getElementById('addHotelRoomsModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.classList.remove('modal-open');
            }
        }

        async function fetchHotelCategories() {
            const select = document.getElementById('hotelCategorySelect');
            try {
                const res = await fetch('hotel_rooms.php?action=list_categories');
                const result = await res.json();
                const categories = result.success ? result.data : [];
                select.innerHTML = '<option value="">Select Cat Hotel Category</option>' +
                    categories.map(c => `<option value="${c.key}">${c.label}</option>`).join('');
            } catch (e) {
                select.innerHTML = '<option value="">Failed to load categories</option>';
            }
        }

        document.getElementById('addHotelRoomsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const submitBtn = this.querySelector('.enhanced-save');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoading = submitBtn.querySelector('.btn-loading');
            const category = document.getElementById('hotelCategorySelect').value;
            const count = parseInt(document.getElementById('hotelRoomsCount').value || '0', 10);
            const notes = (document.getElementById('hotelRoomsNotes').value || '').trim();

            // Basic validation
            let valid = true;
            const catErr = document.getElementById('hotelCategoryError');
            const cntErr = document.getElementById('hotelRoomsCountError');
            catErr.classList.remove('show'); catErr.textContent = '';
            cntErr.classList.remove('show'); cntErr.textContent = '';
            if (!category) { catErr.textContent = 'Please select a category'; catErr.classList.add('show'); valid = false; }
            if (!count || count < 1) { cntErr.textContent = 'Enter a valid number of rooms'; cntErr.classList.add('show'); valid = false; }
            if (!valid) return;

            // Loading state
            submitBtn.disabled = true; btnText.style.display = 'none'; btnLoading.style.display = 'flex';
            try {
                const formData = new FormData();
                formData.append('action','add_rooms');
                formData.append('category', category);
                formData.append('count', String(count));
                if (notes) formData.append('notes', notes);
                const res = await fetch('hotel_rooms.php', { method:'POST', body: formData });
                const result = await res.json();
                if(!result.success) throw new Error(result.message || 'Failed to add rooms');
                const newRooms = result.data || [];
                // If backend doesn't echo notes back per room, apply it client-side for immediate UI feedback
                if (notes) {
                    newRooms.forEach(r => { if (!r.note) r.note = notes; });
                }
                hotelRoomsData = [...hotelRoomsData, ...newRooms];
                renderHotelRooms(hotelRoomsData);
                hideAddHotelRoomsModal();
            } catch (err) {
                alert('Failed to add rooms: ' + err.message);
            } finally {
                submitBtn.disabled = false; btnText.style.display = 'flex'; btnLoading.style.display = 'none';
            }
        });

        // Display services in the UI
        function displayServices(services) {
            const servicesList = document.getElementById('servicesList');
            servicesList.innerHTML = '';

            if (services.length === 0) {
                const searchInput = document.getElementById('servicesSearchInput');
                const searchTerm = searchInput ? searchInput.value.trim() : '';
                
                if (searchTerm !== '') {
                    servicesList.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #718096;">
                            <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <h3 style="margin: 0 0 0.5rem 0; color: #4a5568;">No services found</h3>
                            <p style="margin: 0; font-size: 0.9rem;">Try adjusting your search terms</p>
                            <button onclick="clearSearch()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-times"></i> Clear Search
                            </button>
                        </div>
                    `;
                } else {
                servicesList.innerHTML = '<p style="text-align: center; color: #718096; padding: 2rem;">No services found. Add your first service!</p>';
                }
                return;
            }

            services.forEach(service => {
                const serviceCard = document.createElement('div');
                serviceCard.className = 'service-card';
                serviceCard.innerHTML = `
                    <div class="service-image">
                        ${service.image_url ? `<img src="${service.image_url}" alt="${service.service_name}" onerror="this.style.display='none'">` : '<div class="no-image"><i class="fas fa-image"></i></div>'}
                    </div>
                    <div class="service-info">
                        <h3 class="service-title">${service.service_name}</h3>
                        ${service.description ? `<div class="service-description">${service.description}</div>` : ''}
                        
                        <div class="service-details">
                            ${service.duration_minutes ? `
                            <div class="duration">
                                <div class="detail-icon">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <span>Duration ${formatDuration(service.duration_minutes, service.duration_unit)}</span>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="service-pricing">
                            <div class="pricing-header">
                                <div class="detail-icon">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                                <strong>Pricing:</strong>
                            </div>
                            <div class="pricing-content">
                                ${formatDetailedPrices(service.price_data || [{ category: 'general', price: service.price || 0 }])}
                            </div>
                        </div>
                        
                        <div class="service-categories">
                            ${service.service_category ? `
                            <div class="category-item">
                                <strong>Service Category:</strong> ${formatCategoryName(service.service_category)}
                            </div>
                            ` : ''}
                            ${service.cat_hotel_category ? `
                            <div class="category-item">
                                <strong>Cat Hotel Category:</strong> ${formatCategoryName(service.cat_hotel_category)}
                            </div>
                            ` : ''}
                        </div>
                        
                        ${service.breed_notes ? `
                        <div class="service-notes">
                            <strong>Breed Notes:</strong> ${service.breed_notes}
                        </div>
                        ` : ''}
                        
                        ${service.notes ? `
                        <div class="service-notes">
                            <strong>Additional Notes:</strong> ${service.notes}
                        </div>
                        ` : ''}
                    </div>
                    <div class="service-actions">
                        <button class="action-btn edit-btn" onclick="editService(${service.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteService(${service.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                servicesList.appendChild(serviceCard);
            });
        }

        // Format detailed prices for service cards
        function formatDetailedPrices(priceData) {
            // Handle JSON string from database
            if (typeof priceData === 'string') {
                try {
                    priceData = JSON.parse(priceData);
                } catch (e) {
                    console.error('Error parsing price_data JSON:', e);
                    return '<span class="no-price">Price data error</span>';
                }
            }
            
            if (!priceData || !Array.isArray(priceData) || priceData.length === 0) {
                return '<span class="no-price">Price not set</span>';
            }
            
            if (priceData.length === 1) {
                const category = formatCategoryName(priceData[0].category);
                let weight = priceData[0].weight || '';
                // Add KG unit if weight exists and doesn't already contain it
                if (weight && !weight.toUpperCase().includes('KG')) {
                    weight = weight + ' KG';
                }
                const weightDisplay = weight ? ` (${weight})` : '';
                return `<div class="price-item-single">
                    <span class="price-amount">RM${priceData[0].price}</span>
                    <span class="price-category">${category}${weightDisplay}</span>
                </div>`;
            }
            
            // For multiple prices, show them in a structured format
            const maxDisplay = 3;
            const displayPrices = priceData.slice(0, maxDisplay);
            const remainingCount = priceData.length - maxDisplay;
            
            let priceHTML = displayPrices.map(p => {
                const category = formatCategoryName(p.category);
                let weight = p.weight || '';
                // Add KG unit if weight exists and doesn't already contain it
                if (weight && !weight.toUpperCase().includes('KG')) {
                    weight = weight + ' KG';
                }
                const weightDisplay = weight ? ` (${weight})` : '';
                return `<div class="price-item-multiple">
                    <span class="price-amount">RM${p.price}</span>
                    <span class="price-category">${category}${weightDisplay}</span>
                </div>`;
            }).join('');
            
            if (remainingCount > 0) {
                priceHTML += `<div class="price-item-more" onclick="toggleMorePrices(this)">
                    <span class="more-count">+${remainingCount} more prices</span>
                    <div class="more-prices-details" style="display: none;">
                        ${priceData.slice(maxDisplay).map(p => {
                            const category = formatCategoryName(p.category);
                            let weight = p.weight || '';
                            // Add KG unit if weight exists and doesn't already contain it
                            if (weight && !weight.toUpperCase().includes('KG')) {
                                weight = weight + ' KG';
                            }
                            const weightDisplay = weight ? ` (${weight})` : '';
                            return `<div class="price-item-multiple">
                                <span class="price-amount">RM${p.price}</span>
                                <span class="price-category">${category}${weightDisplay}</span>
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
            }
            
            return priceHTML;
        }

        // Toggle more prices display
        function toggleMorePrices(element) {
            const details = element.querySelector('.more-prices-details');
            const countSpan = element.querySelector('.more-count');
            
            if (details.style.display === 'none') {
                details.style.display = 'block';
                countSpan.textContent = countSpan.textContent.replace('+', '-');
            } else {
                details.style.display = 'none';
                countSpan.textContent = countSpan.textContent.replace('-', '+');
            }
        }

        // Format multiple prices for display
        function formatMultiplePrices(priceData) {
            // Handle JSON string from database
            if (typeof priceData === 'string') {
                try {
                    priceData = JSON.parse(priceData);
                } catch (e) {
                    console.error('Error parsing price_data JSON:', e);
                    return 'Price data error';
                }
            }
            
            if (!priceData || !Array.isArray(priceData) || priceData.length === 0) {
                return 'Price not set';
            }
            
            if (priceData.length === 1) {
                const category = formatCategoryName(priceData[0].category);
                return `RM${priceData[0].price} (${category})`;
            }
            
            // For multiple prices, show a more detailed format
            const maxDisplay = 2;
            const displayPrices = priceData.slice(0, maxDisplay);
            const remainingCount = priceData.length - maxDisplay;
            
            let priceText = displayPrices.map(p => {
                const category = formatCategoryName(p.category);
                return `RM${p.price} (${category})`;
            }).join(', ');
            
            if (remainingCount > 0) {
                priceText += ` +${remainingCount} more`;
            }
            
            return priceText;
        }

        // Format duration from minutes to readable format
        function formatDuration(minutes, unit = null) {
            if (!minutes || minutes <= 0) return '';
            
            // If unit is provided, use it for display
            if (unit) {
                switch(unit) {
                    case 'minutes':
                        return `${minutes} min`;
                    case 'hours':
                        const hours = Math.floor(minutes / 60);
                        return `${hours} hour${hours > 1 ? 's' : ''}`;
                    case 'days':
                        const days = Math.floor(minutes / 1440);
                        return `${days} day${days > 1 ? 's' : ''}`;
                    case 'nights':
                        const nights = Math.floor(minutes / 1440);
                        return `${nights} night${nights > 1 ? 's' : ''}`;
                }
            }
            
            // Fallback to automatic conversion
            if (minutes < 60) {
                return `${minutes} min`;
            } else if (minutes < 1440) {
                const hours = Math.floor(minutes / 60);
                const remainingMinutes = minutes % 60;
                return remainingMinutes > 0 ? `${hours}h ${remainingMinutes}min` : `${hours} hours`;
            } else {
                const days = Math.floor(minutes / 1440);
                const remainingMinutes = minutes % 1440;
                
                // If it's exactly divisible by 1440, show as days/nights
                if (remainingMinutes === 0) {
                return `${days} day${days > 1 ? 's' : ''}`;
                } else {
                    // Mixed duration
                    const hours = Math.floor(remainingMinutes / 60);
                    return `${days} day${days > 1 ? 's' : ''} ${hours}h`;
                }
            }
        }

        // Search functionality
        function searchServices(searchTerm) {
            if (!allServices || !Array.isArray(allServices)) {
                console.warn('allServices is not properly initialized');
                allServices = [];
                filteredServices = [];
                displayServices([]);
                return;
            }
            
            // Get category filter value
            const categoryFilter = document.getElementById('servicesCategoryFilter');
            const selectedCategory = categoryFilter ? categoryFilter.value : '';
            
            let services = allServices;
            
            // Apply category filter first
            if (selectedCategory && selectedCategory.trim() !== '') {
                services = services.filter(service => 
                    service.service_category === selectedCategory
                );
            }
            
            // Then apply search term filter
            if (!searchTerm || searchTerm.trim() === '') {
                filteredServices = services;
            } else {
                const term = searchTerm.toLowerCase().trim();
                filteredServices = services.filter(service => {
                    return (
                        service.service_name.toLowerCase().includes(term) ||
                        service.service_category.toLowerCase().includes(term) ||
                        service.cat_hotel_category?.toLowerCase().includes(term) ||
                        service.breed_notes?.toLowerCase().includes(term) ||
                        service.notes?.toLowerCase().includes(term) ||
                        service.price.toString().includes(term) ||
                        (service.service_category ? formatCategoryName(service.service_category).toLowerCase().includes(term) : false) ||
                        (service.cat_hotel_category ? formatCategoryName(service.cat_hotel_category).toLowerCase().includes(term) : false)
                    );
                });
            }
            displayServices(filteredServices);
            updateSearchResults(searchTerm);
        }
        
        // Clear all service filters
        function clearServiceFilters() {
            const searchInput = document.getElementById('servicesSearchInput');
            const categoryFilter = document.getElementById('servicesCategoryFilter');
            
            if (searchInput) {
                searchInput.value = '';
            }
            if (categoryFilter) {
                categoryFilter.value = '';
            }
            
            searchServices('');
        }

        // Update search results counter
        function updateSearchResults(searchTerm) {
            const searchResults = document.getElementById('searchResults');
            if (searchResults) {
                const categoryFilter = document.getElementById('servicesCategoryFilter');
                const selectedCategory = categoryFilter ? categoryFilter.value : '';
                const hasFilter = searchTerm && searchTerm.trim() !== '' || (selectedCategory && selectedCategory.trim() !== '');
                
                if (hasFilter) {
                    let filterText = '';
                    if (searchTerm && searchTerm.trim() !== '') {
                        filterText += `"${searchTerm}"`;
                    }
                    if (selectedCategory && selectedCategory.trim() !== '') {
                        if (filterText) filterText += ' + ';
                        filterText += formatCategoryName(selectedCategory);
                    }
                    searchResults.innerHTML = `
                        <i class="fas fa-filter"></i> 
                        Found ${filteredServices.length} of ${allServices.length} services
                        ${filterText ? `for ${filterText}` : ''}
                    `;
                } else {
                    searchResults.innerHTML = `
                        <i class="fas fa-list"></i> 
                        Showing all ${allServices.length} services
                    `;
                }
            }
        }

        // Clear services search
        function clearServicesSearch() {
            const searchInput = document.getElementById('servicesSearchInput');
            const clearIcon = document.getElementById('clearServicesSearchIcon');
            
            if (searchInput) {
                searchInput.value = '';
                filteredServices = [...allServices];
                displayServices(filteredServices);
                updateSearchResults('');
                
                // Hide clear button
                if (clearIcon) {
                    clearIcon.style.display = 'none';
                }
            }
        }

        // Update search UI
        function updateSearchUI(searchTerm) {
            const servicesList = document.getElementById('servicesList');
            
            if (filteredServices.length === 0 && searchTerm.trim() !== '') {
                servicesList.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #718096;">
                        <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <h3 style="margin: 0 0 0.5rem 0; color: #4a5568;">No services found</h3>
                        <p style="margin: 0; font-size: 0.9rem;">Try adjusting your search terms</p>
                    </div>
                `;
            }
        }

        // Global event listener for Escape key to close modals
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                // Check if any modal is open and close it
                const addModal = document.getElementById('addServiceModal');
                const editModal = document.getElementById('editServiceModal');
                
                if (addModal && addModal.style.display === 'flex') {
                    hideAddServiceModal();
                } else if (editModal && editModal.style.display === 'flex') {
                    hideEditServiceModal();
                }
            }
        });

        // Show Add Service Modal
        function showAddServiceModal() {
            // Add body scroll lock
            document.body.classList.add('modal-open');
            
            document.getElementById('addServiceModal').style.display = 'flex';
            document.getElementById('addServiceForm').reset();
            document.getElementById('serviceImagePreview').style.display = 'none';
            document.getElementById('imageUploadArea').style.display = 'block';
            
            // Clear all error states
            document.querySelectorAll('.field-error').forEach(error => {
                error.classList.remove('show');
                error.textContent = '';
            });
            document.querySelectorAll('.error').forEach(field => {
                field.classList.remove('error');
            });
            
            // Setup enhanced functionality
            setupImageUpload();
            setupPriceRowEvents();
        }

        // Hide Add Service Modal
        function hideAddServiceModal() {
            // Remove body scroll lock
            document.body.classList.remove('modal-open');
            
            document.getElementById('addServiceModal').style.display = 'none';
        }

        // Time Slot Selection Functions
        function selectAllTimeSlots() {
            const checkboxes = document.querySelectorAll('#timeSlotsGrid input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                // Enable capacity input when slot is selected
                const capacityInput = checkbox.closest('.time-slot-option').querySelector('input[type="number"]');
                if (capacityInput) {
                    capacityInput.disabled = false;
                }
            });
        }

        function clearAllTimeSlots() {
            const checkboxes = document.querySelectorAll('#timeSlotsGrid input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                // Disable capacity input when slot is deselected
                const capacityInput = checkbox.closest('.time-slot-option').querySelector('input[type="number"]');
                if (capacityInput) {
                    capacityInput.disabled = true;
                }
            });
        }

        function selectAllEditTimeSlots() {
            const checkboxes = document.querySelectorAll('#editTimeSlotsGrid input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                // Enable capacity input when slot is selected
                const capacityInput = checkbox.closest('.time-slot-option').querySelector('input[type="number"]');
                if (capacityInput) {
                    capacityInput.disabled = false;
                }
            });
        }

        function clearAllEditTimeSlots() {
            const checkboxes = document.querySelectorAll('#editTimeSlotsGrid input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                // Disable capacity input when slot is deselected
                const capacityInput = checkbox.closest('.time-slot-option').querySelector('input[type="number"]');
                if (capacityInput) {
                    capacityInput.disabled = true;
                }
            });
        }

        // Function to populate time slots in edit form
        function populateEditTimeSlots(timeSlots) {
            if (!timeSlots) return;
            
            let slots = {};
            if (typeof timeSlots === 'string') {
                try {
                    slots = JSON.parse(timeSlots);
                } catch (e) {
                    console.error('Error parsing time slots:', e);
                    return;
                }
            } else if (typeof timeSlots === 'object') {
                slots = timeSlots;
            }
            
            // Clear all checkboxes first
            clearAllEditTimeSlots();
            
            // Check the appropriate slots and set capacities
            Object.keys(slots).forEach(timeSlot => {
                const checkbox = document.querySelector(`#editTimeSlotsGrid input[value="${timeSlot}"]`);
                const capacityInput = document.querySelector(`#editTimeSlotsGrid input[name="slot_capacity[${timeSlot}]"]`);
                
                if (checkbox && capacityInput) {
                    checkbox.checked = true;
                    capacityInput.value = slots[timeSlot] || 2;
                    capacityInput.disabled = false;
                }
            });
        }

        // Add event listeners for checkbox changes to enable/disable capacity inputs
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners for Add Service form
            const addCheckboxes = document.querySelectorAll('#timeSlotsGrid input[type="checkbox"]');
            addCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const capacityInput = this.closest('.time-slot-option').querySelector('input[type="number"]');
                    if (capacityInput) {
                        capacityInput.disabled = !this.checked;
                    }
                });
            });

            // Add event listeners for Edit Service form
            const editCheckboxes = document.querySelectorAll('#editTimeSlotsGrid input[type="checkbox"]');
            editCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const capacityInput = this.closest('.time-slot-option').querySelector('input[type="number"]');
                    if (capacityInput) {
                        capacityInput.disabled = !this.checked;
                    }
                });
            });
        });

        // Show Edit Service Modal
        async function editService(serviceId) {
            try {
                const response = await fetch(`pet_services.php?action=get&id=${serviceId}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const service = result.data;
                    
                    // Populate basic fields
                    document.getElementById('editServiceId').value = service.id;
                    document.getElementById('editServiceName').value = service.service_name || '';
                    
                    // Populate multiple prices if available
                    if (service.price_data) {
                        let priceData = service.price_data;
                        
                        // Parse JSON string if needed
                        if (typeof priceData === 'string') {
                            try {
                                priceData = JSON.parse(priceData);
                            } catch (e) {
                                console.error('Error parsing price_data:', e);
                                priceData = [{ category: 'general', price: service.price || 0, weight: null }];
                            }
                        }
                        
                        // Ensure it's an array
                        if (Array.isArray(priceData)) {
                            populateEditPrices(priceData);
                        } else {
                            populateEditPrices([{ category: 'general', price: service.price || 0, weight: null }]);
                        }
                    } else {
                        // Fallback to single price for backward compatibility
                        populateEditPrices([{ category: 'general', price: service.price || 0, weight: null }]);
                    }
                    
                    // Populate category fields
                    document.getElementById('editServiceCategory').value = service.service_category || '';
                    document.getElementById('editCatHotelCategory').value = service.cat_hotel_category || '';
                    
                    // Populate notes fields
                    document.getElementById('editBreedNotes').value = service.breed_notes || '';
                    document.getElementById('editServiceNotes').value = service.notes || '';
                    
                    // Populate time slots
                    populateEditTimeSlots(service.available_time_slots);
                    
                    // Handle duration unit conversion FIRST
                    if (service.duration_minutes) {
                        // Use the stored duration_unit if available, otherwise determine best unit
                        let displayUnit = service.duration_unit || 'minutes';
                        let displayValue = service.duration_minutes;
                        
                        // If no stored unit, determine the best unit to display
                        if (!service.duration_unit) {
                            const minutes = service.duration_minutes;
                            
                            if (minutes >= 1440) {
                                // If it's exactly divisible by 1440, show as days/nights
                                if (minutes % 1440 === 0) {
                                    displayUnit = 'days'; // Default to days, admin can change to nights if needed
                                    displayValue = minutes / 1440;
                                } else {
                                    displayUnit = 'minutes';
                                    displayValue = minutes;
                                }
                            } else if (minutes >= 60) {
                                if (minutes % 60 === 0) {
                                    displayUnit = 'hours';
                                    displayValue = minutes / 60;
                                } else {
                                    displayUnit = 'minutes';
                                    displayValue = minutes;
                                }
                            }
                        } else {
                            // Use stored unit and convert value accordingly
                            switch(service.duration_unit) {
                                case 'hours':
                                    displayValue = service.duration_minutes / 60;
                                    break;
                                case 'days':
                                case 'nights':
                                    displayValue = service.duration_minutes / 1440;
                                    break;
                                default:
                                    displayValue = service.duration_minutes;
                            }
                        }
                        
                        document.getElementById('editDurationUnit').value = displayUnit;
                        document.getElementById('editServiceDuration').value = displayValue;
                    } else {
                        // No duration set
                        document.getElementById('editServiceDuration').value = '';
                        document.getElementById('editDurationUnit').value = 'minutes';
                    }
                    
                    // Handle current image display
                    if (service.image_url) {
                        document.getElementById('editServiceCurrentImg').src = service.image_url;
                        document.getElementById('editServiceCurrentImage').style.display = 'block';
                        document.getElementById('editImageUploadArea').style.display = 'none';
                    } else {
                        document.getElementById('editServiceCurrentImage').style.display = 'none';
                        document.getElementById('editImageUploadArea').style.display = 'block';
                    }
                    
                    // Reset preview
                    document.getElementById('editServiceImagePreview').style.display = 'none';
                    document.getElementById('editServiceImage').value = '';
                    
                    // Clear all error states
                    document.querySelectorAll('.field-error').forEach(error => {
                        error.classList.remove('show');
                        error.textContent = '';
                    });
                    document.querySelectorAll('.error').forEach(field => {
                        field.classList.remove('error');
                    });
                    
                    // Setup edit image upload functionality
                    setupEditImageUpload();
                    
                    // Add body scroll lock
                    document.body.classList.add('modal-open');
                    
                    document.getElementById('editServiceModal').style.display = 'flex';
                } else {
                    alert('Failed to load service details');
                }
            } catch (error) {
                console.error('Error loading service:', error);
                alert('Error loading service details');
            }
        }

        // Hide Edit Service Modal
        function hideEditServiceModal() {
            // Remove body scroll lock
            document.body.classList.remove('modal-open');
            
            document.getElementById('editServiceModal').style.display = 'none';
        }

        // Image upload and preview functions
        function previewServiceImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('servicePreviewImg').src = e.target.result;
                    document.getElementById('serviceImagePreview').style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function removeServiceImage() {
            document.getElementById('serviceImage').value = '';
            document.getElementById('serviceImagePreview').style.display = 'none';
        }

        function removeEditServiceImage() {
            document.getElementById('editServiceImage').value = '';
            document.getElementById('editServiceImagePreview').style.display = 'none';
            document.getElementById('editImageUploadArea').style.display = 'block';
            document.getElementById('editServiceImageError').classList.remove('show');
            // Show current image again if it exists
            const currentImage = document.getElementById('editServiceCurrentImage');
            if (currentImage && currentImage.querySelector('img').src) {
                currentImage.style.display = 'block';
            }
        }

        function removeCurrentImage() {
            document.getElementById('editServiceCurrentImage').style.display = 'none';
            document.getElementById('editImageUploadArea').style.display = 'block';
            // Add a hidden input to indicate image should be removed
            let removeInput = document.getElementById('removeCurrentImage');
            if (!removeInput) {
                removeInput = document.createElement('input');
                removeInput.type = 'hidden';
                removeInput.id = 'removeCurrentImage';
                removeInput.name = 'remove_image';
                removeInput.value = '1';
                document.getElementById('editServiceForm').appendChild(removeInput);
            }
        }

        function changeEditServiceImage() {
            document.getElementById('editServiceImage').click();
        }

        // Delete Service
        async function deleteService(serviceId) {
            if (confirm('Are you sure you want to delete this service?')) {
                try {
                    const formData = new FormData();
                    formData.append('action', 'delete');
                    formData.append('id', serviceId);
                    
                    const response = await fetch('pet_services.php', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('Service deleted successfully');
                        loadServices(); // Reload the services list
                    } else {
                        alert('Failed to delete service: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error deleting service:', error);
                    alert('Error deleting service');
                }
            }
        }

        // Handle Add Service Form Submission
        document.getElementById('addServiceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form elements
            const submitBtn = document.querySelector('.enhanced-save');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoading = submitBtn.querySelector('.btn-loading');
            
            // Validate all fields
            const formFields = [
                { id: 'serviceName', rules: { required: true, minLength: 2, maxLength: 100 } },
                { id: 'serviceCategory', rules: { required: true } },
                { id: 'serviceDuration', rules: { required: false, type: 'number', min: 1, max: 1440 } },
                { id: 'catHotelCategory', rules: { required: false } },
                { id: 'breedNotes', rules: { required: false, maxLength: 1000 } },
                { id: 'serviceNotes', rules: { required: false, maxLength: 1000 } }
            ];

            // Validate multiple prices
            const priceValidation = validateMultiplePrices();
            if (!priceValidation.isValid) {
                showFieldError('servicePricesError', priceValidation.message);
                return;
            }

            let isFormValid = true;
            formFields.forEach(field => {
                const element = document.getElementById(field.id);
                const isValid = validateField(field.id, element.value, field.rules);
                if (!isValid) isFormValid = false;
            });

            if (!isFormValid) {
                return;
            }

            // Show loading state
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            btnLoading.style.display = 'flex';
            
            try {
                const formData = new FormData(this);
                formData.append('action', 'create');
                
                // Convert duration to minutes if needed
                const durationValue = parseFloat(document.getElementById('serviceDuration').value);
                const durationUnit = document.getElementById('durationUnit').value;
                const durationInMinutes = convertDurationToMinutes(durationValue, durationUnit);
                formData.set('duration_minutes', durationInMinutes);
                formData.set('duration_unit', durationUnit);
                
                // Process multiple prices
                const priceData = processMultiplePrices();
                formData.append('price_data', JSON.stringify(priceData));
                
                // Handle image upload if present
                const imageFile = document.getElementById('serviceImage').files[0];
                if (imageFile) {
                    // Upload image first
                    const uploadFormData = new FormData();
                    uploadFormData.append('image', imageFile);
                    
                    const uploadResponse = await fetch('upload_service_image.php', {
                        method: 'POST',
                        body: uploadFormData
                    });
                    
                    const uploadResult = await uploadResponse.json();
                    
                    if (uploadResult.success) {
                        formData.append('image_url', uploadResult.file_path);
                    } else {
                        showFieldError('serviceImageError', 'Image upload failed: ' + uploadResult.message);
                        return;
                    }
                }
                
                const response = await fetch('pet_services.php', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show success message
                    alert('Service added successfully!');
                    hideAddServiceModal();
                    loadServices(); // Reload the services list
                } else {
                    alert('Failed to add service: ' + result.message);
                }
            } catch (error) {
                console.error('Error adding service:', error);
                alert('Error adding service. Please try again.');
            } finally {
                // Hide loading state
                submitBtn.disabled = false;
                btnText.style.display = 'flex';
                btnLoading.style.display = 'none';
            }
        });

        // Handle Edit Service Form Submission
        document.getElementById('editServiceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form elements
            const submitBtn = document.querySelector('#editServiceForm .enhanced-save');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoading = submitBtn.querySelector('.btn-loading');
            
            // Validate all fields
            const formFields = [
                { id: 'editServiceName', rules: { required: true, minLength: 2, maxLength: 100 } },
                { id: 'editServiceCategory', rules: { required: true } },
                { id: 'editServiceDuration', rules: { required: false, type: 'number', min: 1, max: 1440 } },
                { id: 'editCatHotelCategory', rules: { required: false } },
                { id: 'editBreedNotes', rules: { required: false, maxLength: 1000 } },
                { id: 'editServiceNotes', rules: { required: false, maxLength: 1000 } }
            ];

            // Validate multiple prices
            const priceValidation = validateEditMultiplePrices();
            if (!priceValidation.isValid) {
                showFieldError('editServicePricesError', priceValidation.message);
                return;
            }

            let isFormValid = true;
            formFields.forEach(field => {
                const element = document.getElementById(field.id);
                const isValid = validateField(field.id, element.value, field.rules);
                if (!isValid) isFormValid = false;
            });

            if (!isFormValid) {
                return;
            }

            // Show loading state
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            btnLoading.style.display = 'flex';
            
            try {
                const formData = new FormData(this);
                formData.append('action', 'update');
                
                // Convert duration to minutes if needed
                const durationValue = parseFloat(document.getElementById('editServiceDuration').value);
                const durationUnit = document.getElementById('editDurationUnit').value;
                const durationInMinutes = convertDurationToMinutes(durationValue, durationUnit);
                formData.set('duration_minutes', durationInMinutes);
                formData.set('duration_unit', durationUnit);
                
                // Process multiple prices
                const priceData = processEditMultiplePrices();
                formData.append('price_data', JSON.stringify(priceData));
                
                // Handle image upload if present
                const imageFile = document.getElementById('editServiceImage').files[0];
                if (imageFile) {
                    // Upload image first
                    const uploadFormData = new FormData();
                    uploadFormData.append('image', imageFile);
                    
                    const uploadResponse = await fetch('upload_service_image.php', {
                        method: 'POST',
                        body: uploadFormData
                    });
                    
                    const uploadResult = await uploadResponse.json();
                    
                    if (uploadResult.success) {
                        formData.append('image_url', uploadResult.file_path);
                    } else {
                        alert('Image upload failed: ' + uploadResult.message);
                        return;
                    }
                } else {
                    // Check if current image should be removed
                    const removeCurrentImage = document.getElementById('removeCurrentImage');
                    if (removeCurrentImage && removeCurrentImage.value === '1') {
                        formData.append('image_url', ''); // Remove image
                    }
                    // If no new image and no removal flag, keep current image (don't send image_url)
                }
                
                const response = await fetch('pet_services.php', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Service updated successfully');
                    hideEditServiceModal();
                    loadServices(); // Reload the services list
                } else {
                    alert('Failed to update service: ' + result.message);
                }
            } catch (error) {
                console.error('Error updating service:', error);
                alert('Error updating service');
            } finally {
                // Hide loading state
                submitBtn.disabled = false;
                btnText.style.display = 'flex';
                btnLoading.style.display = 'none';
            }
        });

        // Enhanced Form Validation
        function validateField(fieldId, value, rules) {
            const field = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId + 'Error');
            let isValid = true;
            let errorMessage = '';

            // Clear previous error state
            field.classList.remove('error');
            errorElement.classList.remove('show');

            // Required validation
            if (rules.required && (!value || value.trim() === '')) {
                isValid = false;
                errorMessage = 'This field is required';
            }

            // Min length validation
            if (isValid && rules.minLength && value.length < rules.minLength) {
                isValid = false;
                errorMessage = `Minimum ${rules.minLength} characters required`;
            }

            // Max length validation
            if (isValid && rules.maxLength && value.length > rules.maxLength) {
                isValid = false;
                errorMessage = `Maximum ${rules.maxLength} characters allowed`;
            }

            // Number validation
            if (isValid && rules.type === 'number') {
                const numValue = parseFloat(value);
                if (isNaN(numValue)) {
                    isValid = false;
                    errorMessage = 'Please enter a valid number';
                } else if (rules.min && numValue < rules.min) {
                    isValid = false;
                    errorMessage = `Minimum value is ${rules.min}`;
                } else if (rules.max && numValue > rules.max) {
                    isValid = false;
                    errorMessage = `Maximum value is ${rules.max}`;
                }
            }

            // Show error if invalid
            if (!isValid) {
                field.classList.add('error');
                errorElement.textContent = errorMessage;
                errorElement.classList.add('show');
            }

            return isValid;
        }

        // Enhanced Image Upload Setup
        function setupImageUpload() {
            const uploadArea = document.getElementById('imageUploadArea');
            const fileInput = document.getElementById('serviceImage');
            const uploadLink = uploadArea.querySelector('.upload-link');

            // Only handle click on the "browse files" span
            if (uploadLink) {
                // Remove any existing event listeners
                uploadLink.onclick = null;
                uploadLink.addEventListener('click', (e) => {
                    e.preventDefault();
                fileInput.click();
            });
            }

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleImageFile(files[0]);
                }
            });

            // File input change
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleImageFile(e.target.files[0]);
                }
            });
        }

        // Enhanced Edit Image Upload Setup
        function setupEditImageUpload() {
            const uploadArea = document.getElementById('editImageUploadArea');
            const fileInput = document.getElementById('editServiceImage');
            const uploadLink = uploadArea.querySelector('.upload-link');

            // Only handle click on the "browse files" span
            if (uploadLink) {
                // Remove any existing event listeners
                uploadLink.onclick = null;
                uploadLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    fileInput.click();
                });
            }

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleEditImageFile(files[0]);
                }
            });

            // File input change
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleEditImageFile(e.target.files[0]);
                }
            });
        }

        // Handle image file
        function handleImageFile(file) {
            const errorElement = document.getElementById('serviceImageError');
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showFieldError('serviceImageError', 'Please select a valid image file');
                return;
            }

            // Validate file size (5MB)
            if (file.size > 5 * 1024 * 1024) {
                showFieldError('serviceImageError', 'File size must be less than 5MB');
                return;
            }

            // Clear error
            errorElement.classList.remove('show');

            // Preview image
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('servicePreviewImg').src = e.target.result;
                document.getElementById('imageFileName').textContent = file.name;
                document.getElementById('imageFileSize').textContent = formatFileSize(file.size);
                
                document.getElementById('imageUploadArea').style.display = 'none';
                document.getElementById('serviceImagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        // Handle edit image file
        function handleEditImageFile(file) {
            const errorElement = document.getElementById('editServiceImageError');
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showFieldError('editServiceImageError', 'Please select a valid image file');
                return;
            }

            // Validate file size (5MB)
            if (file.size > 5 * 1024 * 1024) {
                showFieldError('editServiceImageError', 'File size must be less than 5MB');
                return;
            }

            // Clear error
            errorElement.classList.remove('show');

            // Preview image
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('editServicePreviewImg').src = e.target.result;
                document.getElementById('editImageFileName').textContent = file.name;
                document.getElementById('editImageFileSize').textContent = formatFileSize(file.size);
                
                document.getElementById('editImageUploadArea').style.display = 'none';
                document.getElementById('editServiceImagePreview').style.display = 'block';
                // Don't hide current image yet - only hide it when form is saved
            };
            reader.readAsDataURL(file);
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Show field error
        function showFieldError(errorId, message) {
            const errorElement = document.getElementById(errorId);
            errorElement.textContent = message;
            errorElement.classList.add('show');
        }

        // Change service image
        function changeServiceImage() {
            document.getElementById('serviceImage').click();
        }

        // Remove service image
        function removeServiceImage() {
            document.getElementById('serviceImage').value = '';
            document.getElementById('serviceImagePreview').style.display = 'none';
            document.getElementById('imageUploadArea').style.display = 'block';
            document.getElementById('serviceImageError').classList.remove('show');
        }

        // Duration unit conversion
        function convertDurationToMinutes(value, unit) {
            switch(unit) {
                case 'hours':
                    return value * 60;
                case 'days':
                    return value * 1440; // 24 * 60
                case 'nights':
                    return value * 1440; // 24 * 60 (same as days)
                default:
                    return value;
            }
        }

        // Multiple Price Functions
        let priceIndex = 0;

        function addPriceRow() {
            priceIndex++;
            const container = document.getElementById('priceContainer');
            const newPriceItem = document.createElement('div');
            newPriceItem.className = 'price-item';
            newPriceItem.setAttribute('data-price-index', priceIndex);
            
            newPriceItem.innerHTML = `
                <div class="price-row">
                    <div class="price-category">
                        <label>Pet Category</label>
                        <select name="price_categories[]" required>
                            <option value="">Select Category</option>
                            <option value="GENERAL">General</option>
                            <option value="KITTEN ">Kitten</option>
                            <option value="ADULT SHORT HAIR">Adult Short Hair</option>
                            <option value="ADULT LONG HAIR">Adult Long Hair</option>
                        </select>
                    </div>
                    <div class="price-weight">
                        <label>Weight Range (KG) <span class="optional">(Optional)</span></label>
                        <input type="text" name="price_weights[]" placeholder="e.g., 0-2, 2-4, 4-6, 6-8, 8-10, 10+" pattern="[0-9+\-\.\s]*" title="Only numbers, ranges (e.g., 0-2), and + symbol allowed">
                    </div>
                    <div class="price-amount">
                        <label>Price (RM)</label>
                        <input type="number" name="prices[]" step="0.01" min="0" placeholder="0.00" required>
                    </div>
                    <div class="price-actions">
                        <button type="button" class="add-price-btn" onclick="addPriceRow()" title="Add Price">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button type="button" class="remove-price-btn" onclick="removePriceRow(${priceIndex})" title="Remove Price">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="custom-category" style="display: none;">
                    <input type="text" name="custom_categories[]" placeholder="Enter custom category name">
                </div>
            `;
            
            container.appendChild(newPriceItem);
            
            // Add event listener for custom category
            const select = newPriceItem.querySelector('select');
            const customInput = newPriceItem.querySelector('.custom-category');
            
            select.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customInput.style.display = 'block';
                    customInput.querySelector('input').required = true;
                } else {
                    customInput.style.display = 'none';
                    customInput.querySelector('input').required = false;
                }
            });
            
            // Setup weight input validation for the new row
            const weightInput = newPriceItem.querySelector('input[name="price_weights[]"]');
            if (weightInput) {
                weightInput.addEventListener('input', function() {
                    this.value = this.value.replace(/[^0-9+\-\.\s]/g, '');
                });
                
                weightInput.addEventListener('keypress', function(e) {
                    const allowedChars = /[0-9+\-\.\s]/;
                    if (!allowedChars.test(e.key) && !['Backspace', 'Delete', 'Tab', 'Enter', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                        e.preventDefault();
                    }
                });
            }
        }

        function addEditPriceRow() {
            priceIndex++;
            const container = document.getElementById('editPriceContainer');
            const newPriceItem = document.createElement('div');
            newPriceItem.className = 'price-item';
            newPriceItem.setAttribute('data-price-index', priceIndex);
            
            newPriceItem.innerHTML = `
                <div class="price-row">
                    <div class="price-category">
                        <label>Pet Category</label>
                        <select name="price_categories[]" required>
                            <option value="">Select Category</option>
                            <option value="GENERAL">General</option>
                            <option value="KITTEN ">Kitten</option>
                            <option value="ADULT SHORT HAIR">Adult Short Hair</option>
                            <option value="ADULT LONG HAIR">Adult Long Hair</option>
                        </select>
                    </div>
                    <div class="price-weight">
                        <label>Weight Range (KG) <span class="optional">(Optional)</span></label>
                        <input type="text" name="price_weights[]" placeholder="e.g., 0-2, 2-4, 4-6, 6-8, 8-10, 10+" pattern="[0-9+\-\.\s]*" title="Only numbers, ranges (e.g., 0-2), and + symbol allowed">
                    </div>
                    <div class="price-amount">
                        <label>Price (RM)</label>
                        <input type="number" name="prices[]" step="0.01" min="0" placeholder="0.00" required>
                    </div>
                    <div class="price-actions">
                        <button type="button" class="add-price-btn" onclick="addEditPriceRow()" title="Add Price">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button type="button" class="remove-price-btn" onclick="removeEditPriceRow(${priceIndex})" title="Remove Price">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="custom-category" style="display: none;">
                    <input type="text" name="custom_categories[]" placeholder="Enter custom category name">
                </div>
            `;
            
            container.appendChild(newPriceItem);
            
            // Add event listener for custom category
            const select = newPriceItem.querySelector('select');
            const customInput = newPriceItem.querySelector('.custom-category');
            
            select.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customInput.style.display = 'block';
                    customInput.querySelector('input').required = true;
                } else {
                    customInput.style.display = 'none';
                    customInput.querySelector('input').required = false;
                }
            });
            
            // Setup weight input validation for the new row
            const weightInput = newPriceItem.querySelector('input[name="price_weights[]"]');
            if (weightInput) {
                weightInput.addEventListener('input', function() {
                    this.value = this.value.replace(/[^0-9+\-\.\s]/g, '');
                });
                
                weightInput.addEventListener('keypress', function(e) {
                    const allowedChars = /[0-9+\-\.\s]/;
                    if (!allowedChars.test(e.key) && !['Backspace', 'Delete', 'Tab', 'Enter', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                        e.preventDefault();
                    }
                });
            }
        }

        function removePriceRow(index) {
            const priceItem = document.querySelector(`[data-price-index="${index}"]`);
            if (priceItem) {
                priceItem.remove();
            }
        }

        function removeEditPriceRow(index) {
            const priceItem = document.querySelector(`[data-price-index="${index}"]`);
            if (priceItem) {
                priceItem.remove();
            }
        }

        function setupPriceRowEvents() {
            // Add event listeners for existing price rows
            document.querySelectorAll('#priceContainer .price-item select').forEach(select => {
                select.addEventListener('change', function() {
                    const customInput = this.closest('.price-item').querySelector('.custom-category');
                    if (this.value === 'custom') {
                        customInput.style.display = 'block';
                        customInput.querySelector('input').required = true;
                    } else {
                        customInput.style.display = 'none';
                        customInput.querySelector('input').required = false;
                    }
                });
            });

            document.querySelectorAll('#editPriceContainer .price-item select').forEach(select => {
                select.addEventListener('change', function() {
                    const customInput = this.closest('.price-item').querySelector('.custom-category');
                    if (this.value === 'custom') {
                        customInput.style.display = 'block';
                        customInput.querySelector('input').required = true;
                    } else {
                        customInput.style.display = 'none';
                        customInput.querySelector('input').required = false;
                    }
                });
            });

            // Setup weight input validation for both containers
            setupWeightInputValidation('#priceContainer');
            setupWeightInputValidation('#editPriceContainer');
        }

        // Setup weight input validation
        function setupWeightInputValidation(containerId) {
            document.querySelectorAll(`${containerId} input[name="price_weights[]"]`).forEach(input => {
                input.addEventListener('input', function() {
                    // Allow only numbers, hyphens, plus signs, spaces, and dots
                    this.value = this.value.replace(/[^0-9+\-\.\s]/g, '');
                });
                
                input.addEventListener('keypress', function(e) {
                    // Allow only specific characters
                    const allowedChars = /[0-9+\-\.\s]/;
                    if (!allowedChars.test(e.key) && !['Backspace', 'Delete', 'Tab', 'Enter', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                        e.preventDefault();
                    }
                });
            });
        }

        // Multiple Price Validation Functions
        function validateMultiplePrices() {
            const priceItems = document.querySelectorAll('#priceContainer .price-item');
            
            if (priceItems.length === 0) {
                return { isValid: false, message: 'At least one price is required' };
            }

            const categories = new Set();
            const prices = [];

            for (let i = 0; i < priceItems.length; i++) {
                const item = priceItems[i];
                const categorySelect = item.querySelector('select[name="price_categories[]"]');
                const weightInput = item.querySelector('input[name="price_weights[]"]');
                const priceInput = item.querySelector('input[name="prices[]"]');
                const customInput = item.querySelector('input[name="custom_categories[]"]');

                // Validate category
                if (!categorySelect.value) {
                    return { isValid: false, message: `Pet category is required for price ${i + 1}` };
                }

                // Validate weight (optional)
                const weightValue = weightInput.value.trim();
                // Weight is optional, so no validation needed

                // Check for duplicate categories
                let categoryValue = categorySelect.value;
                if (categoryValue === 'custom') {
                    if (!customInput.value.trim()) {
                        return { isValid: false, message: `Custom category name is required for price ${i + 1}` };
                    }
                    categoryValue = customInput.value.trim();
                }

                // Check for duplicate category-weight combinations (weight is optional)
                const categoryWeightKey = weightValue ? `${categoryValue}-${weightValue}` : categoryValue;
                if (categories.has(categoryWeightKey)) {
                    const weightText = weightValue ? ` (${weightValue})` : '';
                    return { isValid: false, message: `Duplicate category-weight combination: ${categoryValue}${weightText}` };
                }
                categories.add(categoryWeightKey);

                // Validate price
                const price = parseFloat(priceInput.value);
                if (isNaN(price) || price <= 0) {
                    return { isValid: false, message: `Valid price is required for price ${i + 1}` };
                }
                if (price > 10000) {
                    return { isValid: false, message: `Price cannot exceed RM10,000 for price ${i + 1}` };
                }
                prices.push(price);
            }

            return { isValid: true, message: '' };
        }

        function validateEditMultiplePrices() {
            const priceItems = document.querySelectorAll('#editPriceContainer .price-item');
            
            if (priceItems.length === 0) {
                return { isValid: false, message: 'At least one price is required' };
            }

            const categories = new Set();
            const prices = [];

            for (let i = 0; i < priceItems.length; i++) {
                const item = priceItems[i];
                const categorySelect = item.querySelector('select[name="price_categories[]"]');
                const weightInput = item.querySelector('input[name="price_weights[]"]');
                const priceInput = item.querySelector('input[name="prices[]"]');
                const customInput = item.querySelector('input[name="custom_categories[]"]');

                // Validate category
                if (!categorySelect.value) {
                    return { isValid: false, message: `Pet category is required for price ${i + 1}` };
                }

                // Validate weight (optional)
                const weightValue = weightInput.value.trim();
                // Weight is optional, so no validation needed

                // Check for duplicate categories
                let categoryValue = categorySelect.value;
                if (categoryValue === 'custom') {
                    if (!customInput.value.trim()) {
                        return { isValid: false, message: `Custom category name is required for price ${i + 1}` };
                    }
                    categoryValue = customInput.value.trim();
                }

                // Check for duplicate category-weight combinations (weight is optional)
                const categoryWeightKey = weightValue ? `${categoryValue}-${weightValue}` : categoryValue;
                if (categories.has(categoryWeightKey)) {
                    const weightText = weightValue ? ` (${weightValue})` : '';
                    return { isValid: false, message: `Duplicate category-weight combination: ${categoryValue}${weightText}` };
                }
                categories.add(categoryWeightKey);

                // Validate price
                const price = parseFloat(priceInput.value);
                if (isNaN(price) || price <= 0) {
                    return { isValid: false, message: `Valid price is required for price ${i + 1}` };
                }
                if (price > 10000) {
                    return { isValid: false, message: `Price cannot exceed RM10,000 for price ${i + 1}` };
                }
                prices.push(price);
            }

            return { isValid: true, message: '' };
        }

        // Process Multiple Prices Functions
        function processMultiplePrices() {
            const priceItems = document.querySelectorAll('#priceContainer .price-item');
            const priceData = [];

            for (let i = 0; i < priceItems.length; i++) {
                const item = priceItems[i];
                const categorySelect = item.querySelector('select[name="price_categories[]"]');
                const weightInput = item.querySelector('input[name="price_weights[]"]');
                const priceInput = item.querySelector('input[name="prices[]"]');
                const customInput = item.querySelector('input[name="custom_categories[]"]');

                let categoryValue = categorySelect.value;
                if (categoryValue === 'custom') {
                    categoryValue = customInput.value.trim();
                }

                priceData.push({
                    category: categoryValue,
                    weight: weightInput.value.trim() || null,
                    price: parseFloat(priceInput.value)
                });
            }

            return priceData;
        }

        function processEditMultiplePrices() {
            const priceItems = document.querySelectorAll('#editPriceContainer .price-item');
            const priceData = [];

            for (let i = 0; i < priceItems.length; i++) {
                const item = priceItems[i];
                const categorySelect = item.querySelector('select[name="price_categories[]"]');
                const weightInput = item.querySelector('input[name="price_weights[]"]');
                const priceInput = item.querySelector('input[name="prices[]"]');
                const customInput = item.querySelector('input[name="custom_categories[]"]');

                let categoryValue = categorySelect.value;
                if (categoryValue === 'custom') {
                    categoryValue = customInput.value.trim();
                }

                priceData.push({
                    category: categoryValue,
                    weight: weightInput.value.trim() || null,
                    price: parseFloat(priceInput.value)
                });
            }

            return priceData;
        }

        // Populate Edit Prices Function
        function populateEditPrices(priceData) {
            const container = document.getElementById('editPriceContainer');
            container.innerHTML = '';
            
            // Handle JSON string from database
            if (typeof priceData === 'string') {
                try {
                    priceData = JSON.parse(priceData);
                } catch (e) {
                    console.error('Error parsing price_data JSON:', e);
                    priceData = [{ category: 'general', price: 0, weight: null }];
                }
            }
            
            // Ensure priceData is an array
            if (!Array.isArray(priceData)) {
                priceData = [{ category: 'general', price: 0, weight: null }];
            }
            
            priceData.forEach((priceItem, index) => {
                const priceElement = document.createElement('div');
                priceElement.className = 'price-item';
                priceElement.setAttribute('data-price-index', index);
                
                const isCustom = !['GENERAL', 'KITTEN ', 'ADULT', 'ADULT SHORT HAIR', 'ADULT LONG HAIR'].includes(priceItem.category);
                
                priceElement.innerHTML = `
                    <div class="price-row">
                        <div class="price-category">
                            <label>Pet Category</label>
                            <select name="price_categories[]" required>
                                <option value="">Select Category</option>
                                <option value="GENERAL" ${priceItem.category === 'GENERAL' ? 'selected' : ''}>General</option>
                                <option value="KITTEN" ${priceItem.category === 'KITTEN' ? 'selected' : ''}>Kitten </option>
                                <option value="ADULT SHORT HAIR" ${priceItem.category === 'ADULT SHORT HAIR' ? 'selected' : ''}>Adult Short Hair</option>
                                <option value="ADULT LONG HAIR" ${priceItem.category === 'ADULT LONG HAIR' ? 'selected' : ''}>Adult Long Hair</option>
                            </select>
                        </div>
                        <div class="price-weight">
                            <label>Weight Range (KG) <span class="optional">(Optional)</span></label>
                            <input type="text" name="price_weights[]" placeholder="e.g., 0-2, 2-4, 4-6, 6-8, 8-10, 10+" value="${priceItem.weight || ''}">
                        </div>
                        <div class="price-amount">
                            <label>Price (RM)</label>
                            <input type="number" name="prices[]" step="0.01" min="0" placeholder="0.00" value="${priceItem.price}" required>
                        </div>
                        <div class="price-actions">
                            <button type="button" class="add-price-btn" onclick="addEditPriceRow()" title="Add Price">
                                <i class="fas fa-plus"></i>
                            </button>
                            ${index > 0 ? `<button type="button" class="remove-price-btn" onclick="removeEditPriceRow(${index})" title="Remove Price">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                        </div>
                    </div>
                    <div class="custom-category" style="display: ${isCustom ? 'block' : 'none'};">
                        <input type="text" name="custom_categories[]" placeholder="Enter custom category name" value="${isCustom ? priceItem.category : ''}" ${isCustom ? 'required' : ''}>
                    </div>
                `;
                
                container.appendChild(priceElement);
            });
            
            // Setup event listeners for the populated prices
            setupPriceRowEvents();
        }

        // Convert minutes back to appropriate unit for display
        function convertMinutesToUnit(minutes) {
            if (minutes < 60) {
                return { value: minutes, unit: 'minutes' };
            } else if (minutes < 1440) {
                const hours = Math.floor(minutes / 60);
                const remainingMinutes = minutes % 60;
                return { value: remainingMinutes > 0 ? `${hours}h ${remainingMinutes}min` : hours, unit: 'hours' };
            } else {
                const days = Math.floor(minutes / 1440);
                return { value: days, unit: 'days' };
            }
        }

        // Add event listeners for enhanced functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Real-time validation
            const formFields = [
                { id: 'serviceName', rules: { required: true, minLength: 2, maxLength: 100 } },
                { id: 'serviceCategory', rules: { required: true } },
                { id: 'serviceDuration', rules: { required: false, type: 'number', min: 1, max: 1440 } },
                { id: 'packageType', rules: { required: false } },
                { id: 'catHotelCategory', rules: { required: false } },
                { id: 'breedNotes', rules: { required: false, maxLength: 1000 } },
                { id: 'serviceNotes', rules: { required: false, maxLength: 1000 } }
            ];

            formFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    element.addEventListener('blur', () => {
                        validateField(field.id, element.value, field.rules);
                    });
                    element.addEventListener('input', () => {
                        // Clear error on input
                        element.classList.remove('error');
                        document.getElementById(field.id + 'Error').classList.remove('show');
                    });
                }
            });

            // Booking search functionality
            const bookingSearchInput = document.getElementById('bookingSearchInput');
            if (bookingSearchInput) {
                bookingSearchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value;
                    searchBookings(searchTerm);
                });
            }

            // Services search functionality
            const servicesSearchInput = document.getElementById('servicesSearchInput');
            const clearServicesIcon = document.getElementById('clearServicesSearchIcon');
            
            if (servicesSearchInput) {
                servicesSearchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value;
                    searchServices(searchTerm);
                    
                    // Show/hide clear button
                    if (clearServicesIcon) {
                        clearServicesIcon.style.display = searchTerm.trim() !== '' ? 'block' : 'none';
                    }
                });

                // Add clear button functionality
                servicesSearchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        clearServicesSearch();
                    }
                });
            }
            
            // Services category filter functionality
            const servicesCategoryFilter = document.getElementById('servicesCategoryFilter');
            if (servicesCategoryFilter) {
                servicesCategoryFilter.addEventListener('change', function() {
                    const searchTerm = servicesSearchInput ? servicesSearchInput.value : '';
                    searchServices(searchTerm);
                });
            }

            // Booking status filter
            const bookingStatusFilter = document.getElementById('bookingStatusFilter');
            if (bookingStatusFilter) {
                bookingStatusFilter.addEventListener('change', function(e) {
                    filterBookingsByStatus(e.target.value);
                });
            }

            // Booking date filter
            const bookingDateFilter = document.getElementById('bookingDateFilter');
            if (bookingDateFilter) {
                bookingDateFilter.addEventListener('change', function(e) {
                    filterBookingsByDate(e.target.value);
                });
            }

            // Hotel slots search and filter
            const hotelSearchInput = document.getElementById('hotelSearchInput');
            if (hotelSearchInput) {
                hotelSearchInput.addEventListener('input', function(e) {
                    searchHotelSlots(e.target.value);
                });
            }
            const hotelTypeFilter = document.getElementById('hotelTypeFilter');
            if (hotelTypeFilter) {
                hotelTypeFilter.addEventListener('change', function(e) {
                    filterHotelByType(e.target.value);
                });
            }
        });

        // Image preview event listeners are now handled in setupImageUpload() and setupEditImageUpload()

        // OLD CHAT FUNCTIONALITY REMOVED - Now handled by Live Chat system below

        // Check admin access on page load
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch('auth.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'action=get_current_user'
                });
                
                const result = await response.json();
                
                if (result.success && result.user) {
                    // Check if user is admin - use explicit is_admin flag or check role
                    // Admin users from admin_users table will have is_admin: true
                    const isAdmin = result.user.is_admin === true || 
                                    result.user.email === 'admin@catswell.com' || 
                                    (result.user.role && result.user.role !== 'customer' && result.user.role !== 'user');
                    
                    if (isAdmin) {
                        // Show dashboard
                        document.getElementById('loading-screen').style.display = 'none';
                        document.getElementById('dashboard-content').style.display = 'flex';
                        
                        // Display logged-in admin email
                        const adminEmailElement = document.getElementById('adminEmail');
                        if (adminEmailElement) {
                            adminEmailElement.textContent = result.user.email || 'admin@catswell.com';
                        }
                        
                        // Load services from database
                        loadServices();
                        
                        // Load bookings from database
                        loadBookings();

                        // Load cat hotel slots
                        loadHotelSlots();
                    } else {
                        // Redirect non-admin users
                        alert('Access denied. Admin privileges required.');
                        window.location.href = 'admin-login.html';
                    }
                } else {
                    // No user logged in, redirect to login
                    alert('Please login first.');
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                // Set fallback email if auth fails
                const adminEmailElement = document.getElementById('adminEmail');
                if (adminEmailElement) {
                    adminEmailElement.textContent = 'admin@catswell.com';
                }
                alert('Authentication error. Redirecting to login.');
                window.location.href = 'index.html';
            }
        });

        // Sign Out Function
        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                // Clear session data
                fetch('auth.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'action=logout'
                }).then(() => {
                    // Redirect to index.html
                    window.location.href = 'admin-login.html';
                }).catch(error => {
                    console.error('Logout error:', error);
                    // Still redirect even if logout request fails
                    window.location.href = 'index.html';
                });
            }
        }

        // Hotel Tab Functions
        function switchHotelTab(tabName) {
            // Update tab buttons
            const tabButtons = document.querySelectorAll('.hotel-tab-btn');
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabName) {
                    btn.style.background = '#3b82f6';
                    btn.style.color = 'white';
                } else {
                    btn.style.background = '#f8f9fa';
                    btn.style.color = '#6c757d';
                }
            });

            // Update tab content
            const tabContents = document.querySelectorAll('.hotel-tab-content');
            tabContents.forEach(content => {
                content.style.display = 'none';
                content.classList.remove('active');
            });

            const activeTab = document.getElementById(`hotel-${tabName}-tab`);
            if (activeTab) {
                activeTab.style.display = 'block';
                activeTab.classList.add('active');
            }

            // Load data for the active tab
            if (tabName === 'bookings') {
                loadHotelBookings();
            }
            
            // Initialize filters when bookings tab is switched to
            if (tabName === 'bookings') {
                // Small delay to ensure elements are visible
                setTimeout(() => {
                    initializeHotelBookingFilters();
                }, 200);
            }
        }

        // Hotel Bookings Functions
        let allHotelBookings = [];
        let filteredHotelBookings = [];

        async function loadHotelBookings() {
            try {
                const response = await fetch('bookings.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'action=get_hotel_bookings'
                });

                const result = await response.json();
                
                if (result.success) {
                    allHotelBookings = result.data || [];
                    filteredHotelBookings = [...allHotelBookings];
                    displayHotelBookings(filteredHotelBookings);
                    
                    // Initialize filter event listeners after bookings are loaded
                    setTimeout(() => {
                        initializeHotelBookingFilters();
                    }, 100);
                } else {
                    showHotelBookingsError(result.message || 'Failed to load hotel bookings');
                }
            } catch (error) {
                console.error('Error loading hotel bookings:', error);
                showHotelBookingsError('Failed to load hotel bookings');
            }
        }

        function displayHotelBookings(bookings) {
            const loading = document.getElementById('hotelBookingsLoading');
            const table = document.getElementById('hotelBookingsTable');
            const tbody = document.getElementById('hotelBookingsTableBody');

            loading.style.display = 'none';
            table.style.display = 'table';

            if (bookings.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="13" style="text-align: center; padding: 2rem; color: #718096;">
                            <i class="fas fa-calendar-times" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p style="margin: 0;">No hotel bookings found</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = bookings.map(booking => `
                <tr>
                    <td>#${booking.id}</td>
                    <td>${booking.booking_reference || 'N/A'}</td>
                    <td>
                        <div>
                            <strong>${booking.customer_name || 'N/A'}</strong><br>
                            <small style="color: #718096;">${booking.customer_email || 'No email'}</small><br>
                            <small style="color: #718096;">${booking.customer_phone || 'No phone'}</small>
                        </div>
                    </td>
                    <td>
                        <div>
                            ${booking.all_pets && booking.all_pets.length > 0 ? 
                                booking.all_pets.map((pet, idx) => 
                                    `<strong style="color: #2d3748; font-size: 0.9rem;">${pet.name || 'N/A'}</strong> <span style="color: #718096; font-size: 0.85rem;">(${pet.breed || 'Unknown breed'})</span>${idx < booking.all_pets.length - 1 ? ', ' : ''}`
                                ).join('') : 
                                `<strong style="color: #2d3748; font-size: 0.9rem;">${booking.pet_name || 'N/A'}</strong> <span style="color: #718096; font-size: 0.85rem;">(${booking.pet_breed || 'Unknown breed'})</span>`
                            }
                        </div>
                    </td>
                    <td>${booking.room_code || 'N/A'}</td>
                    <td>
                        <div>
                            <strong>${formatDate(booking.checkin_date) || 'N/A'}</strong><br>
                            <small style="color: #718096;">${booking.checkin_time ? formatTime(booking.checkin_time) : 'No time'}</small>
                        </div>
                    </td>
                    <td>
                        <div>
                            <strong>${formatDate(booking.checkout_date) || 'N/A'}</strong><br>
                            <small style="color: #718096;">${booking.checkout_time ? formatTime(booking.checkout_time) : 'No time'}</small>
                        </div>
                    </td>
                    <td>${booking.nights_count || 0}</td>
                    <td>${booking.payment_method || 'N/A'}</td>
                    <td><span style="white-space: nowrap;">RM ${parseFloat(booking.total_amount || 0).toFixed(2)}</span></td>
                    <td>
                        <span class="status-badge ${booking.booking_status || 'pending'}">
                            ${(booking.booking_status || 'pending').charAt(0).toUpperCase() + (booking.booking_status || 'pending').slice(1)}
                        </span>
                    </td>
                    <td>${formatDate(booking.created_at)}</td>
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="action-btn edit-btn" onclick="viewHotelBookingDetails(${booking.id})" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                        ${booking.receipt_file_path ? `
                        <button class="action-btn receipt-btn" onclick="downloadHotelReceipt('${booking.receipt_file_path}', '${booking.booking_reference}')" title="Download Receipt">
                            <i class="fas fa-download"></i>
                        </button>
                        ` : ''}
                            <button class="action-btn notes-btn" onclick="openHotelNotesModal(${booking.id})" title="Add Notes">
                                <i class="fas fa-sticky-note"></i>
                            </button>
                            <button class="action-btn edit-btn" onclick="updateHotelBookingStatus(${booking.id})" title="Update Status">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteHotelBooking(${booking.id})" title="Delete Booking">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function showHotelBookingsError(message) {
            const loading = document.getElementById('hotelBookingsLoading');
            const table = document.getElementById('hotelBookingsTable');
            const tbody = document.getElementById('hotelBookingsTableBody');
            
            loading.style.display = 'none';
            table.style.display = 'table';
            tbody.innerHTML = `
                <tr>
                    <td colspan="11" style="text-align: center; padding: 2rem; color: #e53e3e;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p style="margin: 0;">${message}</p>
                        <button onclick="loadHotelBookings()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Try Again
                        </button>
                    </td>
                </tr>
            `;
        }

        function refreshHotelBookings() {
            const loading = document.getElementById('hotelBookingsLoading');
            const table = document.getElementById('hotelBookingsTable');
            
            loading.style.display = 'block';
            table.style.display = 'none';
            loadHotelBookings();
        }

        // Refresh hotel bookings
        function refreshHotelBookings() {
            loadHotelBookings();
        }

        function exportHotelBookings() {
            // Simple CSV export with multiple pets support
            const csvContent = [
                ['Booking ID', 'Booking Reference', 'Customer Name', 'Customer Email', 'Customer Phone', 'Pet Names', 'Pet Breeds', 'Pet Categories', 'Room', 'Check-in Date', 'Check-in Time', 'Check-out Date', 'Check-out Time', 'Nights', 'Payment Method', 'Amount', 'Status', 'Created At'],
                ...filteredHotelBookings.map(booking => {
                    // Format pets for export
                    let petNames = '';
                    let petBreeds = '';
                    let petCategories = '';
                    
                    if (booking.all_pets && booking.all_pets.length > 0) {
                        petNames = booking.all_pets.map(pet => pet.name || 'N/A').join('; ');
                        petBreeds = booking.all_pets.map(pet => pet.breed || 'N/A').join('; ');
                        petCategories = booking.all_pets.map(pet => pet.pet_category || 'N/A').join('; ');
                    } else {
                        petNames = booking.pet_name || 'N/A';
                        petBreeds = booking.pet_breed || 'N/A';
                        petCategories = booking.pet_category || 'N/A';
                    }
                    
                    return [
                        booking.id || '',
                        `"${booking.booking_reference || ''}"`,
                        `"${booking.customer_name || ''}"`,
                        `"${booking.customer_email || ''}"`,
                        `"${booking.customer_phone || ''}"`,
                        `"${petNames}"`,
                        `"${petBreeds}"`,
                        `"${petCategories}"`,
                        booking.room_code || '',
                        booking.checkin_date || '',
                        booking.checkin_time || '',
                        booking.checkout_date || '',
                        booking.checkout_time || '',
                        booking.nights_count || 0,
                        booking.payment_method || '',
                        `RM ${parseFloat(booking.total_amount || 0).toFixed(2)}`,
                        booking.booking_status || '',
                        formatDateForExcel(booking.created_at)
                    ];
                })
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `hotel_bookings_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function clearHotelBookingFilters() {
            const searchInput = document.getElementById('hotelBookingSearchInput');
            const statusFilter = document.getElementById('hotelBookingStatusFilter');
            const roomFilter = document.getElementById('hotelBookingRoomFilter');
            const dateFilter = document.getElementById('hotelBookingDateFilter');
            
            if (searchInput) searchInput.value = '';
            if (statusFilter) statusFilter.value = '';
            if (roomFilter) roomFilter.value = '';
            if (dateFilter) dateFilter.value = '';
            
            filteredHotelBookings = [...allHotelBookings];
            displayHotelBookings(filteredHotelBookings);
        }

        function viewHotelBooking(bookingId) {
            // Implementation for viewing hotel booking details
            console.log('View hotel booking:', bookingId);
            alert('View hotel booking functionality will be implemented');
        }

        // Enhanced hotel booking functions
        async function viewHotelBookingDetails(bookingId) {
            try {
                // Find the booking in the current hotel bookings list
                const booking = allHotelBookings.find(b => b.id == bookingId);
                
                if (booking) {
                    console.log('Found booking:', booking);
                    console.log('Pet ID:', booking.pet_id);
                    
                    // Fetch additional customer details
                    const customerResponse = await fetch(`users.php?action=get&id=${booking.user_id}`);
                    const customerResult = await customerResponse.json();
                    
                    // Fetch additional pet details to get processed vaccine information
                    const petResponse = await fetch(`pets.php?action=get&id=${booking.pet_id}`);
                    const petResult = await petResponse.json();
                    
                    console.log('Pet response:', petResult);
                    
                    // Fetch admin notes
                    const notesResponse = await fetch('booking_notes.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `action=get_notes&booking_id=${bookingId}&booking_type=hotel`
                    });
                    const notesResult = await notesResponse.json();
                    
                    // Enhance booking with processed pet data, customer details, and admin notes
                    const enhancedBooking = {
                        ...booking,
                        customer_details: customerResult.success ? customerResult.data : null,
                        pet_details: petResult.success ? petResult.data : null,
                        admin_notes: notesResult.success ? notesResult.data.notes : null,
                        admin_images: notesResult.success ? notesResult.data.images : []
                    };
                    
                    console.log('Enhanced booking:', enhancedBooking);
                    showHotelBookingDetailsModal(enhancedBooking);
                } else {
                    // Fallback: fetch from API if not found in current list
                    const response = await fetch(`bookings.php?action=get_booking&booking_id=${bookingId}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        // Fetch customer details for the fallback case
                        const customerResponse = await fetch(`users.php?action=get&id=${result.data.user_id}`);
                        const customerResult = await customerResponse.json();
                        
                        // Also fetch pet details for the fallback case
                        const petResponse = await fetch(`pets.php?action=get&id=${result.data.pet_id}`);
                        const petResult = await petResponse.json();
                        
                        const enhancedBooking = {
                            ...result.data,
                            customer_details: customerResult.success ? customerResult.data : null,
                            pet_details: petResult.success ? petResult.data : null
                        };
                        
                        showHotelBookingDetailsModal(enhancedBooking);
                    } else {
                        showNotification('error', 'Error', 'Failed to load booking details');
                    }
                }
            } catch (error) {
                console.error('Error loading booking details:', error);
                showNotification('error', 'Error', 'Failed to load booking details');
            }
        }

        function showHotelBookingDetailsModal(booking) {
            // Debug logging
            console.log('Hotel booking data:', booking);
            console.log('Pet details:', booking.pet_details);
            console.log('Pet vaccine from booking:', booking.pet_vaccine);
            console.log('Pet vaccine from pet_details:', booking.pet_details?.vaccine_name);
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            
            // Helper function to format medical condition
            function formatMedicalCondition(condition) {
                if (!condition) return 'N/A';
                return condition.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            }
            
            // Helper function to format vaccine information
            function formatVaccineInfo(vaccineData) {
                if (!vaccineData) return 'N/A';
                
                // Handle different vaccine data formats
                if (typeof vaccineData === 'string') {
                    // Single vaccine name
                    if (vaccineData.trim() === '' || vaccineData === 'NULL' || vaccineData === 'null') {
                        return 'N/A';
                    }
                    return vaccineData.trim();
                }
                
                // Handle array of vaccines
                if (Array.isArray(vaccineData) && vaccineData.length > 0) {
                    return vaccineData.map(v => {
                        if (typeof v === 'string') return v;
                        if (v.vaccine_name) return v.vaccine_name;
                        return 'Unknown';
                    }).join(', ');
                }
                
                // Handle object with vaccine_name property
                if (vaccineData.vaccine_name) {
                    return vaccineData.vaccine_name;
                }
                
                return 'N/A';
            }
            
            // Helper function to format vaccine information with dates
            function formatVaccineInfoWithDates(vaccineData, vaccineDateData) {
                if (!vaccineData) return 'N/A';
                
                // Handle different vaccine data formats
                if (typeof vaccineData === 'string') {
                    // Single vaccine name
                    if (vaccineData.trim() === '' || vaccineData === 'NULL' || vaccineData === 'null') {
                        return 'N/A';
                    }
                    
                    // Add date if available
                    if (vaccineDateData && vaccineDateData.trim() !== '' && vaccineDateData !== 'NULL' && vaccineDateData !== 'null') {
                        // Format date to DD/MM/YYYY
                        let formattedDate = vaccineDateData.trim();
                        try {
                            const date = new Date(vaccineDateData.trim());
                            if (!isNaN(date.getTime())) {
                                const day = String(date.getDate()).padStart(2, '0');
                                const month = String(date.getMonth() + 1).padStart(2, '0');
                                const year = date.getFullYear();
                                formattedDate = `${day}/${month}/${year}`;
                            }
                        } catch (e) {
                            // Keep original format if parsing fails
                        }
                        return `${vaccineData.trim()} (${formattedDate})`;
                    }
                    return vaccineData.trim();
                }
                
                // Handle array of vaccines
                if (Array.isArray(vaccineData) && vaccineData.length > 0) {
                    return vaccineData.map(v => {
                        if (typeof v === 'string') return v;
                        if (v.vaccine_name) {
                            let formattedDate = '';
                            if (v.vaccination_date) {
                                try {
                                    const date = new Date(v.vaccination_date);
                                    if (!isNaN(date.getTime())) {
                                        const day = String(date.getDate()).padStart(2, '0');
                                        const month = String(date.getMonth() + 1).padStart(2, '0');
                                        const year = date.getFullYear();
                                        formattedDate = ` (${day}/${month}/${year})`;
                                    }
                                } catch (e) {
                                    formattedDate = ` (${v.vaccination_date})`;
                                }
                            }
                            return `${v.vaccine_name}${formattedDate}`;
                        }
                        return 'Unknown';
                    }).join(', ');
                }
                
                // Handle object with vaccine_name property
                if (vaccineData.vaccine_name) {
                    let formattedDate = '';
                    if (vaccineDateData) {
                        try {
                            const date = new Date(vaccineDateData);
                            if (!isNaN(date.getTime())) {
                                const day = String(date.getDate()).padStart(2, '0');
                                const month = String(date.getMonth() + 1).padStart(2, '0');
                                const year = date.getFullYear();
                                formattedDate = ` (${day}/${month}/${year})`;
                            }
                        } catch (e) {
                            formattedDate = ` (${vaccineDateData})`;
                        }
                    }
                    return `${vaccineData.vaccine_name}${formattedDate}`;
                }
                
                return 'N/A';
            }
            
            // Add body scroll lock
            document.body.classList.add('modal-open');
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeHotelBookingDetailsModal()"></div>
                <div class="modal-content" style="max-width: 1000px;">
                    <div class="modal-header">
                        <div class="modal-title">
                            <i class="fas fa-calendar-check"></i>
                            <h3>Hotel Booking Details #${booking.id}</h3>
                        </div>
                        <button class="modal-close" onclick="closeHotelBookingDetailsModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div style="padding: 1.5rem;">
                        <!-- Booking References Section -->
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div>
                                    <strong>Booking ID:</strong> ${booking.id}
                                </div>
                                <div>
                                    <strong>Booking Reference:</strong> ${booking.booking_reference || 'N/A'}
                                </div>
                                <div>
                                    <strong>Created At:</strong> ${formatDate(booking.created_at)} ${formatTime(booking.created_at)}
                                </div>
                                <div>
                                    <strong>Last Updated:</strong> ${booking.updated_at ? formatDate(booking.updated_at) + ' ' + formatTime(booking.updated_at) : 'N/A'}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Customer & Pet Information Row -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                            <!-- Customer Information -->
                            <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem;">
                                <h3 style="margin: 0 0 1rem 0; color: #2d3748; font-size: 1.2rem; display: flex; align-items: center;">
                                    <i class="fas fa-user" style="margin-right: 0.5rem; color: #667eea;"></i>
                                    Customer Information
                                </h3>
                                <div style="space-y: 0.75rem;">
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Full Name</div>
                                        <div style="font-weight: 600; color: #2d3748;">${booking.customer_name || 'N/A'}</div>
                                    </div>
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Email Address</div>
                                        <div style="font-weight: 600; color: #2d3748;">${booking.customer_email || 'N/A'}</div>
                                    </div>
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Phone Number</div>
                                        <div style="font-weight: 600; color: #2d3748;">${booking.customer_phone || 'N/A'}</div>
                                    </div>
                                    ${booking.customer_details ? `
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Address</div>
                                        <div style="font-weight: 600; color: #2d3748;">${booking.customer_details.address || 'N/A'}</div>
                                    </div>
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Account Created</div>
                                        <div style="font-weight: 600; color: #2d3748;">${booking.customer_details.created_at ? formatDate(booking.customer_details.created_at) : 'N/A'}</div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- Pet Information -->
                            <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem;">
                                <h3 style="margin: 0 0 1rem 0; color: #2d3748; font-size: 1.2rem; display: flex; align-items: center;">
                                    <i class="fas fa-paw" style="margin-right: 0.5rem; color: #667eea;"></i>
                                    Pet Information ${booking.all_pets && booking.all_pets.length > 1 ? `<span style="background: #667eea; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; margin-left: 0.5rem;">${booking.all_pets.length} Pets</span>` : ''}
                                </h3>
                                ${booking.all_pets && booking.all_pets.length > 0 ? 
                                    booking.all_pets.map((pet, index) => `
                                        <div style="${index > 0 ? 'margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #e2e8f0;' : ''}">
                                            ${pet.photo_path ? `
                                                <div style="text-align: center; margin-bottom: 1rem;">
                                                    <img src="${pet.photo_path}" alt="Pet Photo" style="width: 120px; height: 120px; object-fit: cover; border-radius: 12px; border: 3px solid #e2e8f0; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                                </div>
                                            ` : `
                                                <div style="text-align: center; margin-bottom: 1rem; background: #f1f5f9; border-radius: 12px; padding: 2rem; border: 2px dashed #cbd5e0;">
                                                    <i class="fas fa-image" style="font-size: 2rem; color: #a0aec0; margin-bottom: 0.5rem;"></i>
                                                    <div style="color: #718096; font-size: 0.875rem;">No Pet Image Available</div>
                                                </div>
                                            `}
                                            <div style="space-y: 0.75rem;">
                                                <div style="margin-bottom: 0.75rem;">
                                                    <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Name</div>
                                                    <div style="font-weight: 600; color: #2d3748;">${pet.name || 'N/A'}</div>
                                                </div>
                                                <div style="margin-bottom: 0.75rem;">
                                                    <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Breed</div>
                                                    <div style="font-weight: 600; color: #2d3748;">${pet.breed || 'N/A'}</div>
                                                </div>
                                                <div style="margin-bottom: 0.75rem;">
                                                    <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Age</div>
                                                    <div style="font-weight: 600; color: #2d3748;">${pet.age || 'N/A'}</div>
                                                </div>
                                                <div style="margin-bottom: 0.75rem;">
                                                    <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Gender</div>
                                                    <div style="font-weight: 600; color: #2d3748;">${pet.gender || 'N/A'}</div>
                                                </div>
                                                <div style="margin-bottom: 0.75rem;">
                                                    <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Weight</div>
                                                    <div style="font-weight: 600; color: #2d3748;">${pet.weight || 'N/A'}</div>
                                                </div>
                                                <div style="margin-bottom: 0.75rem;">
                                                    <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Spayed/Neutered</div>
                                                    <div style="font-weight: 600; color: #2d3748;">${pet.spayed_neutered || 'N/A'}</div>
                                                </div>
                                                <div style="margin-bottom: 0.75rem;">
                                                    <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Medical Type</div>
                                                    <div style="font-weight: 600; color: #2d3748;">${pet.medical_type || 'N/A'}</div>
                                                </div>
                                                <div style="margin-bottom: 0.75rem;">
                                                    <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Medical Condition</div>
                                                    <div style="font-weight: 600; color: #2d3748;">${formatMedicalCondition(pet.medical_condition)}</div>
                                                </div>
                                                <div style="margin-bottom: 0.75rem;">
                                                    <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Special Notes</div>
                                                    <div style="font-weight: 600; color: #2d3748;">${pet.special_notes || 'N/A'}</div>
                                                </div>
                                                <div style="margin-bottom: 0.75rem;">
                                                    <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Vaccine</div>
                                                    <div style="font-weight: 600; color: #2d3748;">${formatVaccineInfoWithDates(pet.vaccine_name, pet.vaccine_date)}</div>
                                                </div>
                                                <div style="margin-bottom: 0.75rem;">
                                                    <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Pet Category</div>
                                                    <div style="font-weight: 600; color: #2d3748;">${pet.pet_category || 'N/A'}</div>
                                                </div>
                                                <div style="margin-bottom: 0.75rem;">
                                                    <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Registration Date</div>
                                                    <div style="font-weight: 600; color: #2d3748;">${pet.created_at ? formatDate(pet.created_at) : 'N/A'}</div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('') : `
                                        ${booking.pet_photo ? `
                                            <div style="text-align: center; margin-bottom: 1rem;">
                                                <img src="${booking.pet_photo}" alt="Pet Photo" style="width: 120px; height: 120px; object-fit: cover; border-radius: 12px; border: 3px solid #e2e8f0; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                            </div>
                                        ` : `
                                            <div style="text-align: center; margin-bottom: 1rem; background: #f1f5f9; border-radius: 12px; padding: 2rem; border: 2px dashed #cbd5e0;">
                                                <i class="fas fa-image" style="font-size: 2rem; color: #a0aec0; margin-bottom: 0.5rem;"></i>
                                                <div style="color: #718096; font-size: 0.875rem;">No Pet Image Available</div>
                                            </div>
                                        `}
                                        <div style="space-y: 0.75rem;">
                                            <div style="margin-bottom: 0.75rem;">
                                                <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Name</div>
                                                <div style="font-weight: 600; color: #2d3748;">${booking.pet_name || 'N/A'}</div>
                                            </div>
                                            <div style="margin-bottom: 0.75rem;">
                                                <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Breed</div>
                                                <div style="font-weight: 600; color: #2d3748;">${booking.pet_breed || 'N/A'}</div>
                                            </div>
                                            <div style="margin-bottom: 0.75rem;">
                                                <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Age</div>
                                                <div style="font-weight: 600; color: #2d3748;">${booking.pet_age || 'N/A'}</div>
                                            </div>
                                            <div style="margin-bottom: 0.75rem;">
                                                <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Gender</div>
                                                <div style="font-weight: 600; color: #2d3748;">${booking.pet_gender || 'N/A'}</div>
                                            </div>
                                            <div style="margin-bottom: 0.75rem;">
                                                <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Weight</div>
                                                <div style="font-weight: 600; color: #2d3748;">${booking.pet_weight || 'N/A'}</div>
                                            </div>
                                            <div style="margin-bottom: 0.75rem;">
                                                <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Spayed/Neutered</div>
                                                <div style="font-weight: 600; color: #2d3748;">${booking.pet_spayed_neutered || 'N/A'}</div>
                                            </div>
                                            <div style="margin-bottom: 0.75rem;">
                                                <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Medical Type</div>
                                                <div style="font-weight: 600; color: #2d3748;">${booking.pet_medical_type || 'N/A'}</div>
                                            </div>
                                            <div style="margin-bottom: 0.75rem;">
                                                <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Medical Condition</div>
                                                <div style="font-weight: 600; color: #2d3748;">${formatMedicalCondition(booking.pet_medical_condition)}</div>
                                            </div>
                                            <div style="margin-bottom: 0.75rem;">
                                                <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Special Notes</div>
                                                <div style="font-weight: 600; color: #2d3748;">${booking.pet_special_notes || 'N/A'}</div>
                                            </div>
                                            <div style="margin-bottom: 0.75rem;">
                                                <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Vaccine</div>
                                                <div style="font-weight: 600; color: #2d3748;">${booking.pet_details ? formatVaccineInfoWithDates(booking.pet_details.vaccine_name, booking.pet_details.vaccine_date) : formatVaccineInfoWithDates(booking.pet_vaccine, booking.pet_vaccine_date)}</div>
                                            </div>
                                            <div>
                                                <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Pet Category</div>
                                                <div style="font-weight: 600; color: #2d3748;">${booking.pet_category || 'N/A'}</div>
                                            </div>
                                        </div>
                                    `}
                            </div>
                        </div>
                        
                        <!-- Hotel Booking & Payment Information Row -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                            <!-- Hotel Booking Information -->
                            <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem;">
                                <h3 style="margin: 0 0 1rem 0; color: #2d3748; font-size: 1.2rem; display: flex; align-items: center;">
                                    <i class="fas fa-bed" style="margin-right: 0.5rem; color: #667eea;"></i>
                                    Hotel Booking Information
                                </h3>
                                <div style="space-y: 0.75rem;">
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Room Code</div>
                                        <div style="font-weight: 600; color: #2d3748; background: #e6fffa; padding: 0.5rem; border-radius: 6px; display: inline-block;">${booking.room_code || 'N/A'}</div>
                                    </div>
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Check-in Date</div>
                                        <div style="font-weight: 600; color: #2d3748;">${booking.checkin_date || 'N/A'}</div>
                                    </div>
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Check-out Date</div>
                                        <div style="font-weight: 600; color: #2d3748;">${booking.checkout_date || 'N/A'}</div>
                                    </div>
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Nights</div>
                                        <div style="font-weight: 600; color: #2d3748;">${booking.nights_count || 0}</div>
                                    </div>
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Service</div>
                                        <div style="font-weight: 600; color: #2d3748;">${booking.service_name || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Service Category</div>
                                        <div style="font-weight: 600; color: #2d3748; background: #fef5e7; padding: 0.5rem; border-radius: 6px; display: inline-block;">${booking.service_category || 'N/A'}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Payment Information -->
                            <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem;">
                                <h3 style="margin: 0 0 1rem 0; color: #2d3748; font-size: 1.2rem; display: flex; align-items: center;">
                                    <i class="fas fa-credit-card" style="margin-right: 0.5rem; color: #667eea;"></i>
                                    Payment Information
                                </h3>
                                <div style="space-y: 0.75rem;">
                                    <div style="margin-bottom: 0.75rem;">
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Payment Method</div>
                                        <div style="font-weight: 600; color: #2d3748; background: #f0fff4; padding: 0.5rem; border-radius: 6px; display: inline-block;">${booking.payment_method || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.875rem; color: #718096; margin-bottom: 0.25rem;">Total Amount</div>
                                        <div style="font-weight: 600; color: #2d3748; background: #e6fffa; padding: 0.5rem; border-radius: 6px; display: inline-block; font-size: 1.1rem;">RM ${parseFloat(booking.total_amount || 0).toFixed(2)}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notes Section -->
                        <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem;">
                            <h3 style="margin: 0 0 1rem 0; color: #2d3748; font-size: 1.2rem; display: flex; align-items: center;">
                                <i class="fas fa-sticky-note" style="margin-right: 0.5rem; color: #667eea;"></i>
                                Notes
                            </h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                                <div style="background: white; padding: 1rem; border-radius: 8px; border-left: 4px solid #48bb78;">
                                    <h4 style="margin: 0 0 0.75rem 0; color: #2d3748; font-size: 1rem;">Customer Notes</h4>
                                    <div style="color: #4a5568; line-height: 1.5;">${booking.additional_notes || 'No customer notes provided'}</div>
                                </div>
                                <div style="background: white; padding: 1rem; border-radius: 8px; border-left: 4px solid #ed8936;">
                                    <h4 style="margin: 0 0 0.75rem 0; color: #2d3748; font-size: 1rem;">Admin Notes</h4>
                                    <div style="color: #4a5568; line-height: 1.5;">${booking.admin_notes || 'No admin notes'}</div>
                                    ${booking.admin_images && booking.admin_images.length > 0 ? `
                                        <div style="margin-top: 1rem;">
                                            <h5 style="margin: 0 0 0.5rem 0; color: #2d3748; font-size: 0.9rem;">Admin Images:</h5>
                                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                                ${booking.admin_images.map(img => `
                                                    <img src="${img.image_path}" alt="Admin Note Image" 
                                                         style="max-width: 100px; max-height: 100px; border-radius: 4px; border: 1px solid #e2e8f0; cursor: pointer;"
                                                         onclick="window.open('${img.image_path}', '_blank')">
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div style="background: #f8fafc; border-top: 1px solid #e2e8f0; padding: 1.5rem 2rem; border-radius: 0 0 16px 16px;">
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button onclick="closeHotelBookingDetailsModal()" style="padding: 0.75rem 2rem; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add click outside to close functionality
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeHotelBookingDetailsModal();
                }
            });
            
            // Add escape key to close functionality
            const escapeHandler = function(e) {
                if (e.key === 'Escape') {
                    closeHotelBookingDetailsModal();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
            
            document.body.appendChild(modal);
            document.body.classList.add('modal-open');
        }

        function closeHotelBookingDetailsModal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.innerHTML.includes('Hotel Booking Details')) {
                    modal.remove();
                }
            });
            document.body.classList.remove('modal-open');
        }

        async function deleteHotelBooking(bookingId) {
            if (!confirm('Are you sure you want to delete this hotel booking? This will hide it from admin view but keep it visible to the customer.')) {
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('action', 'delete');
                formData.append('booking_id', bookingId);
                
                const response = await fetch('bookings.php', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('success', 'Hotel Booking Deleted', 'Hotel booking hidden from admin view successfully');
                    loadHotelBookings(); // Reload hotel bookings
                } else {
                    showNotification('error', 'Delete Failed', 'Failed to delete hotel booking: ' + result.message);
                }
            } catch (error) {
                console.error('Error deleting hotel booking:', error);
                showNotification('error', 'Delete Error', 'Error deleting hotel booking. Please try again.');
            }
        }

        function openHotelNotesModal(bookingId) {
            console.log('Opening hotel notes modal for booking:', bookingId);
            
            // Set the booking ID
            document.getElementById('hotelBookingId').value = bookingId;
            
            // Clear the form
            document.getElementById('hotelNotesText').value = '';
            document.getElementById('hotelNotesImage').value = '';
            
            // Load existing notes
            loadHotelBookingNotes(bookingId);
            
            // Show the modal
            document.getElementById('hotelNotesModal').style.display = 'flex';
            document.body.classList.add('modal-open');
        }

        function hideHotelNotesModal() {
            document.getElementById('hotelNotesModal').style.display = 'none';
            document.body.classList.remove('modal-open');
            
            // Clear form
            document.getElementById('hotelNotesForm').reset();
            document.getElementById('hotelImagePreview').style.display = 'none';
            document.getElementById('hotelExistingImages').innerHTML = '';
        }

        async function loadHotelBookingNotes(bookingId) {
            try {
                const response = await fetch('booking_notes.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `action=get_notes&booking_id=${bookingId}&booking_type=hotel`
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    // Load notes text
                    if (result.data.notes) {
                        document.getElementById('hotelNotesText').value = result.data.notes;
                    }
                    
                    // Load existing images
                    displayHotelExistingImages(result.data.images || []);
                } else {
                    console.log('No hotel booking notes found');
                    document.getElementById('hotelNotesText').value = '';
                    document.getElementById('hotelExistingImages').innerHTML = '<p style="color: #718096; font-style: italic;">No images uploaded yet</p>';
                }
            } catch (error) {
                console.error('Error loading hotel booking notes:', error);
                showNotification('error', 'Load Error', 'Failed to load existing notes');
            }
        }
        
        function displayHotelExistingImages(images) {
            const container = document.getElementById('hotelExistingImages');
            const bookingId = document.getElementById('hotelBookingId').value;
            
            if (images.length === 0) {
                container.innerHTML = '<p style="color: #718096; font-style: italic;">No images uploaded yet</p>';
                return;
            }
            
            container.innerHTML = images.map(image => `
                <div class="existing-image-item">
                    <img src="${image.image_path}" alt="Booking image" onclick="viewImage('${image.image_path}')">
                    <button type="button" class="delete-image-btn" onclick="deleteHotelImageAndReload('${bookingId}', 'hotel')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        async function saveHotelNotes(event) {
            event.preventDefault();
            
            const bookingId = document.getElementById('hotelBookingId').value;
            const notes = document.getElementById('hotelNotesText').value;
            const imageFile = document.getElementById('hotelNotesImage').files[0];
            
            // Show loading state
            const saveBtn = event.target.querySelector('.btn-save');
            const btnText = saveBtn.querySelector('.btn-text');
            const btnLoading = saveBtn.querySelector('.btn-loading');
            
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline-flex';
            saveBtn.disabled = true;
            
            try {
                const formData = new FormData();
                formData.append('action', 'save_notes');
                formData.append('booking_id', bookingId);
                formData.append('booking_type', 'hotel');
                formData.append('notes', notes);
                
                if (imageFile) {
                    formData.append('image', imageFile);
                }
                
                const response = await fetch('booking_notes.php', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Notes saved successfully');
                    hideHotelNotesModal();
                } else {
                    alert('Failed to save notes: ' + result.message);
                }
            } catch (error) {
                console.error('Error saving hotel booking notes:', error);
                alert('Error saving notes');
            } finally {
                // Reset button state
                btnText.style.display = 'inline';
                btnLoading.style.display = 'none';
                saveBtn.disabled = false;
            }
        }

        async function deleteHotelImageAndReload(bookingId, bookingType) {
            if (!confirm('Are you sure you want to delete this image?')) {
                return;
            }
            
            try {
                const response = await fetch('booking_notes.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `action=delete_image&booking_id=${bookingId}&booking_type=${bookingType || 'hotel'}`
                });
                
                const result = await response.json();
                
                if (result.success) {
                    loadHotelBookingNotes(bookingId); // Reload the notes
                } else {
                    alert('Failed to delete image: ' + result.message);
                }
            } catch (error) {
                console.error('Error deleting hotel note image:', error);
                alert('Error deleting image');
            }
        }
        
        async function deleteHotelNoteImage(bookingId) {
            // Legacy function for backward compatibility
            deleteHotelImageAndReload(bookingId, 'hotel');
        }

        // Download hotel booking receipt
        function downloadHotelReceipt(receiptPath, bookingReference) {
            if (!receiptPath) {
                showNotification('error', 'No Receipt', 'No receipt file available for this booking');
                return;
            }
            
            try {
                const link = document.createElement('a');
                link.href = receiptPath;
                link.download = `receipt_${bookingReference}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                // No success message - silent download
            } catch (error) {
                console.error('Error downloading receipt:', error);
                showNotification('error', 'Download Failed', 'Failed to download receipt');
            }
        }

        // Update hotel booking status
        async function updateHotelBookingStatus(bookingId) {
            // Find the booking in the current hotel bookings list
            const booking = allHotelBookings.find(b => b.id == bookingId);
            
            if (booking) {
                showHotelStatusUpdateModal(booking);
            } else {
                // Fallback: fetch from API if not found in current list
                try {
                    const response = await fetch(`bookings.php?action=get_booking&booking_id=${bookingId}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        showHotelStatusUpdateModal(result.data);
                    } else {
                        showNotification('error', 'Error', 'Failed to load booking details');
                    }
                } catch (error) {
                    console.error('Error loading booking details:', error);
                    showNotification('error', 'Error', 'Failed to load booking details');
                }
            }
        }

        // Show hotel booking status update modal
        function showHotelStatusUpdateModal(booking) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeHotelStatusUpdateModal()"></div>
                <div class="modal-content" style="max-width: 500px; background: #ffffff; color: #000000;">
                    <div class="modal-header">
                        <h3>Update Hotel Booking Status</h3>
                        <button class="modal-close" onclick="closeHotelStatusUpdateModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div style="margin-bottom: 1.5rem;">
                            <p style="margin-bottom: 0.5rem; color: #4a5568;"><strong>Booking Reference:</strong> #${booking.booking_reference || booking.id}</p>
                            <p style="margin-bottom: 0.5rem; color: #4a5568;"><strong>Room:</strong> ${booking.room_code ? `${booking.room_code}${booking.room_category ? ' (' + booking.room_category + ')' : ''}` : 'N/A'}</p>
                            <p style="margin-bottom: 0.5rem; color: #4a5568;"><strong>Customer:</strong> ${booking.customer_name || 'N/A'}</p>
                            <p style="margin-bottom: 0.5rem; color: #4a5568;"><strong>Pet${(booking.all_pets && booking.all_pets.length > 1) ? 's (' + booking.all_pets.length + ')' : ''}:</strong> ${(booking.all_pets && booking.all_pets.length > 0) ? booking.all_pets.map(pet => pet.name).join(', ') : (booking.pet_name || 'N/A')}</p>
                            <p style="margin-bottom: 1rem; color: #4a5568;"><strong>Current Status:</strong> <span class="status-badge ${booking.booking_status || 'pending'}">${formatStatus(booking.booking_status || 'pending')}</span></p>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2d3748;">Select New Status:</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                                <button class="hotel-status-btn" data-status="pending" style="padding: 0.75rem; border: 2px solid #f59e0b; background: #fef3c7; color: #92400e; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                    <i class="fas fa-clock" style="margin-right: 0.5rem;"></i>
                                    Pending
                                </button>
                                <button class="hotel-status-btn" data-status="confirmed" style="padding: 0.75rem; border: 2px solid #10b981; background: #d1fae5; color: #065f46; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                    <i class="fas fa-check" style="margin-right: 0.5rem;"></i>
                                    Confirmed
                                </button>
                                <button class="hotel-status-btn" data-status="completed" style="padding: 0.75rem; border: 2px solid #8b5cf6; background: #ede9fe; color: #5b21b6; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                    <i class="fas fa-check-double" style="margin-right: 0.5rem;"></i>
                                    Completed
                                </button>
                                <button class="hotel-status-btn" data-status="cancelled" style="padding: 0.75rem; border: 2px solid #ef4444; background: #fee2e2; color: #991b1b; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                    <i class="fas fa-times" style="margin-right: 0.5rem;"></i>
                                    Cancelled
                                </button>
                            </div>
                        </div>
                        
                        <div style="padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                <button onclick="closeHotelStatusUpdateModal()" style="padding: 0.75rem 1.5rem; background: #f8f9fa; color: #718096; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer;">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add event listeners for status buttons
            modal.querySelectorAll('.hotel-status-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const newStatus = this.getAttribute('data-status');
                    updateHotelBookingStatusConfirm(booking.id, newStatus, booking.booking_type || 'hotel');
                });
            });
            
            document.body.appendChild(modal);
            document.body.classList.add('modal-open');
        }

        function closeHotelStatusUpdateModal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal.innerHTML.includes('Update Hotel Booking Status')) {
                    modal.remove();
                }
            });
            document.body.classList.remove('modal-open');
        }

        async function updateHotelBookingStatusConfirm(bookingId, newStatus, bookingType) {
            try {
                const formData = new FormData();
                formData.append('action', 'update_status');
                formData.append('booking_id', bookingId);
                formData.append('new_status', newStatus);
                formData.append('booking_type', bookingType || 'hotel');
                
                const response = await fetch('bookings.php', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeHotelStatusUpdateModal();
                    showNotification('success', 'Status Updated', `Hotel booking status updated to ${formatStatus(newStatus)} successfully!`);
                    loadHotelBookings(); // Reload hotel bookings
                } else {
                    showNotification('error', 'Update Failed', 'Failed to update hotel booking status: ' + result.message);
                }
            } catch (error) {
                console.error('Error updating hotel booking status:', error);
                showNotification('error', 'Update Error', 'Error updating hotel booking status. Please try again.');
            }
        }


        // Initialize hotel booking filters when DOM is ready
        function initializeHotelBookingFilters() {
            const hotelBookingSearchInput = document.getElementById('hotelBookingSearchInput');
            const hotelBookingStatusFilter = document.getElementById('hotelBookingStatusFilter');
            const hotelBookingRoomFilter = document.getElementById('hotelBookingRoomFilter');
            const hotelBookingDateFilter = document.getElementById('hotelBookingDateFilter');

            // Remove existing listeners to prevent duplicates
            if (hotelBookingSearchInput) {
                const newSearchInput = hotelBookingSearchInput.cloneNode(true);
                hotelBookingSearchInput.parentNode.replaceChild(newSearchInput, hotelBookingSearchInput);
                document.getElementById('hotelBookingSearchInput').addEventListener('input', filterHotelBookings);
            }
            if (hotelBookingStatusFilter) {
                const newStatusFilter = hotelBookingStatusFilter.cloneNode(true);
                hotelBookingStatusFilter.parentNode.replaceChild(newStatusFilter, hotelBookingStatusFilter);
                document.getElementById('hotelBookingStatusFilter').addEventListener('change', filterHotelBookings);
            }
            if (hotelBookingRoomFilter) {
                const newRoomFilter = hotelBookingRoomFilter.cloneNode(true);
                hotelBookingRoomFilter.parentNode.replaceChild(newRoomFilter, hotelBookingRoomFilter);
                document.getElementById('hotelBookingRoomFilter').addEventListener('change', filterHotelBookings);
            }
            if (hotelBookingDateFilter) {
                const newDateFilter = hotelBookingDateFilter.cloneNode(true);
                hotelBookingDateFilter.parentNode.replaceChild(newDateFilter, hotelBookingDateFilter);
                document.getElementById('hotelBookingDateFilter').addEventListener('change', filterHotelBookings);
            }
            
            console.log('Hotel booking filters initialized');
        }

        function filterHotelBookings() {
            // Check if bookings are loaded
            if (!allHotelBookings || allHotelBookings.length === 0) {
                console.log('No hotel bookings loaded yet');
                return;
            }
            
            const searchTerm = document.getElementById('hotelBookingSearchInput')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('hotelBookingStatusFilter')?.value || '';
            const roomFilter = document.getElementById('hotelBookingRoomFilter')?.value || '';
            const dateFilter = document.getElementById('hotelBookingDateFilter')?.value || '';

            // Map dropdown values to display names
            const roomCategoryMap = {
                'classic_suite': 'Classic Suite',
                'deluxe_suite': 'Deluxe Suite',
                'executive_suite': 'Executive Suite',
                'day_care': 'Studio Suite'
            };

            filteredHotelBookings = allHotelBookings.filter(booking => {
                const matchesSearch = !searchTerm || 
                    (booking.customer_name && booking.customer_name.toLowerCase().includes(searchTerm)) ||
                    (booking.pet_name && booking.pet_name.toLowerCase().includes(searchTerm)) ||
                    (booking.room_code && booking.room_code.toLowerCase().includes(searchTerm));
                
                const matchesStatus = !statusFilter || booking.booking_status === statusFilter;
                
                // Filter by room category - match against room_category field
                let matchesRoom = true;
                if (roomFilter) {
                    const categoryName = roomCategoryMap[roomFilter];
                    matchesRoom = booking.room_category === categoryName;
                }
                
                const matchesDate = !dateFilter || 
                    booking.checkin_date === dateFilter || 
                    booking.checkout_date === dateFilter;

                return matchesSearch && matchesStatus && matchesRoom && matchesDate;
            });

            displayHotelBookings(filteredHotelBookings);
        }

        // Notification System Functions
        let notifications = [];
        let unreadCount = 0;

        // Initialize notification system
        document.addEventListener('DOMContentLoaded', function() {
            loadNotifications();
            // Check for new notifications every 10 seconds (more frequent for chat)
            setInterval(checkForNewNotifications, 10000);
        });

        // Toggle notification dropdown
        function toggleNotificationDropdown() {
            const dropdown = document.getElementById('notificationDropdown');
            
            if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                dropdown.style.display = 'block';
                loadNotifications();
            } else {
                dropdown.style.display = 'none';
            }
        }

        // Load notifications from server
        async function loadNotifications() {
            try {
                const response = await fetch('notifications.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'action=get_notifications'
                });

                const result = await response.json();
                
                if (result.success) {
                    notifications = result.data || [];
                    updateNotificationDisplay();
                } else {
                    showNotificationError(result.message || 'Failed to load notifications');
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
                showNotificationError('Failed to load notifications');
            }
        }

        // Update notification display
        function updateNotificationDisplay() {
            const notificationList = document.getElementById('notificationList');
            const notificationBadge = document.getElementById('notificationBadge');
            
            // Count unread notifications (handle both string and integer values)
            unreadCount = notifications.filter(n => {
                const isRead = n.is_read === 1 || n.is_read === true || n.is_read === '1';
                return !isRead;
            }).length;
            
            // Update badge
            if (unreadCount > 0) {
                notificationBadge.textContent = unreadCount;
                notificationBadge.style.display = 'flex';
            } else {
                notificationBadge.style.display = 'none';
            }

            // Update notification list
            if (notifications.length === 0) {
                notificationList.innerHTML = `
                    <div class="notification-item empty">
                        <i class="fas fa-bell-slash"></i>
                        <span>No notifications yet</span>
                    </div>
                `;
                return;
            }

                notificationList.innerHTML = notifications.map(notification => {
                    const isRead = notification.is_read === 1 || notification.is_read === true || notification.is_read === '1';
                    return `
                <div class="notification-item ${isRead ? '' : 'unread'}" onclick="handleNotificationClick(${notification.id}, '${notification.notification_type}', ${notification.conversation_id || 'null'})">
                    <div class="notification-content">
                        <div class="notification-type ${notification.notification_type === 'chat' ? 'chat' : notification.booking_type}">
                            ${notification.notification_type === 'chat' ? ' Chat Message' : 
                              (notification.booking_type === 'service' ? 'Service Booking' : 'Hotel Booking')}
                        </div>
                        <div class="notification-title">${notification.display_title || notification.title}</div>
                        <div class="notification-message">${notification.display_message || notification.message}</div>
                        <div class="notification-time">${formatNotificationTime(notification.created_at)}</div>
                    </div>
                </div>
            `;
                }).join('');
        }

        // Handle notification click (booking or chat)
        async function handleNotificationClick(notificationId, notificationType, conversationId) {
            if (notificationType === 'chat' && conversationId) {
                // For chat notifications, switch to Live Chat tab and open the conversation
                switchToTab('live-chat');
                setTimeout(() => {
                    if (typeof selectConversation === 'function') {
                        selectConversation(conversationId);
                    }
                }, 100);
            } else {
                // For booking notifications, mark as read and stay in current tab
                await markNotificationAsRead(notificationId);
            }
        }

        // Mark notification as read
        async function markNotificationAsRead(notificationId) {
            try {
                const response = await fetch('notifications.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `action=mark_as_read&notification_id=${notificationId}`
                });

                const result = await response.json();
                
                if (result.success) {
                    // Update local notification
                    const notification = notifications.find(n => n.id === notificationId);
                    if (notification) {
                        notification.is_read = true;
                        updateNotificationDisplay();
                    }
                    // Reload notifications from server to ensure consistency
                    await loadNotifications();
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        // Mark all notifications as read - Make it globally accessible
        window.markAllAsRead = async function markAllAsRead() {
            try {
                console.log('Marking all notifications as read...');
                
                // Check if there are any unread notifications (handle both string and integer values)
                const unreadNotifications = notifications.filter(n => {
                    const isRead = n.is_read === 1 || n.is_read === true || n.is_read === '1';
                    return !isRead;
                });
                console.log('Unread notifications count:', unreadNotifications.length);
                if (unreadNotifications.length === 0) {
                    console.log('No unread notifications to mark');
                    alert('All notifications are already read');
                    return;
                }
                
                // Disable button during processing
                const markAllBtn = document.querySelector('.mark-all-read-btn');
                if (markAllBtn) {
                    markAllBtn.disabled = true;
                    markAllBtn.textContent = 'Processing...';
                }
                
                const response = await fetch('notifications.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'action=mark_all_as_read'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('Mark all as read response:', result);
                
                if (result.success) {
                    // Update all notifications as read locally
                    notifications.forEach(notification => {
                        notification.is_read = true;
                    });
                    updateNotificationDisplay();
                    // Reload notifications from server to ensure consistency
                    await loadNotifications();
                    console.log('All notifications marked as read successfully');
                } else {
                    console.error('Failed to mark all as read:', result.message);
                    alert('Failed to mark all notifications as read: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error marking all notifications as read:', error);
                alert('Error marking all notifications as read. Please check the console for details.');
            } finally {
                // Re-enable button
                const markAllBtn = document.querySelector('.mark-all-read-btn');
                if (markAllBtn) {
                    markAllBtn.disabled = false;
                    markAllBtn.textContent = 'Mark all as read';
                }
            }
        };

        // Clear all notifications - Make it globally accessible
        window.clearAllNotifications = async function clearAllNotifications() {
            try {
                // Confirm before clearing
                const confirmed = confirm('Are you sure you want to clear ALL notifications? This action cannot be undone.');
                if (!confirmed) {
                    return;
                }

                console.log('Clearing all notifications...');
                
                // Disable button during processing
                const clearBtn = document.querySelector('.clear-notifications-btn');
                if (clearBtn) {
                    clearBtn.disabled = true;
                    clearBtn.textContent = 'Clearing...';
                }
                
                const response = await fetch('notifications.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'action=clear_all_notifications'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('Clear all notifications response:', result);
                
                if (result.success) {
                    // Clear local notifications array
                    notifications = [];
                    updateNotificationDisplay();
                    // Reload notifications from server to ensure consistency
                    await loadNotifications();
                    console.log('All notifications cleared successfully');
                    alert('All notifications have been cleared.');
                } else {
                    console.error('Failed to clear all notifications:', result.message);
                    alert('Failed to clear all notifications: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error clearing all notifications:', error);
                alert('Error clearing all notifications. Please check the console for details.');
            } finally {
                // Re-enable button
                const clearBtn = document.querySelector('.clear-notifications-btn');
                if (clearBtn) {
                    clearBtn.disabled = false;
                    clearBtn.textContent = 'Clear';
                }
            }
        };

        // Check for new notifications
        async function checkForNewNotifications() {
            try {
                const response = await fetch('notifications.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'action=check_new_notifications'
                });

                const result = await response.json();
                
                if (result.success && result.has_new) {
                    // Reload notifications if there are new ones
                    loadNotifications();
                }
            } catch (error) {
                console.error('Error checking for new notifications:', error);
            }
        }

        // Format notification time
        function formatNotificationTime(timestamp) {
            const now = new Date();
            const notificationTime = new Date(timestamp);
            const diffInMinutes = Math.floor((now - notificationTime) / (1000 * 60));

            if (diffInMinutes < 1) {
                return 'Just now';
            } else if (diffInMinutes < 60) {
                return `${diffInMinutes} minutes ago`;
            } else if (diffInMinutes < 1440) {
                const hours = Math.floor(diffInMinutes / 60);
                return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            } else {
                const days = Math.floor(diffInMinutes / 1440);
                return `${days} day${days > 1 ? 's' : ''} ago`;
            }
        }

        // Show notification error
        function showNotificationError(message) {
            const notificationList = document.getElementById('notificationList');
            notificationList.innerHTML = `
                <div class="notification-item empty">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>${message}</span>
                </div>
            `;
        }

        // Admin Profile Sidebar Functions
        window.openAdminProfileSidebar = () => {
            const sidebar = document.getElementById('admin-profile-sidebar');
            const overlay = document.getElementById('admin-profile-sidebar-overlay');
            
            if (!sidebar || !overlay) {
                console.error('Admin profile sidebar elements not found');
                return;
            }
            
            // Lock body scroll
            document.body.style.overflow = 'hidden';
            
            // Use CSS classes for proper animation
            overlay.style.display = 'block';
            sidebar.setAttribute('aria-hidden', 'false');
            
            // Add active classes for animation
            setTimeout(() => {
                overlay.classList.add('active');
                sidebar.classList.add('active');
            }, 10);
            
            // Load admin data when opening profile sidebar
            loadAdminProfileData();
        };

        window.closeAdminProfileSidebar = () => {
            const sidebar = document.getElementById('admin-profile-sidebar');
            const overlay = document.getElementById('admin-profile-sidebar-overlay');
            
            if (!sidebar || !overlay) return;
            
            // Unlock body scroll
            document.body.style.overflow = '';
            
            // Remove active classes for animation
            overlay.classList.remove('active');
            sidebar.classList.remove('active');
            sidebar.setAttribute('aria-hidden', 'true');
            
            // Hide overlay after animation
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 300);
        };

        // Load admin profile data
        async function loadAdminProfileData() {
            try {
                const response = await fetch('auth.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'action=get_current_user'
                });
                
                const result = await response.json();
                
                if (result.success && result.user) {
                    const userData = result.user;
                    
                    // Update profile fields
                    const emailEl = document.getElementById('admin-profile-email');
                    const firstnameEl = document.getElementById('admin-profile-firstname');
                    const lastnameEl = document.getElementById('admin-profile-lastname');
                    const phoneEl = document.getElementById('admin-profile-phone');
                    const addressEl = document.getElementById('admin-profile-address');
                    const roleEl = document.getElementById('admin-profile-role');
                    
                    if (emailEl) {
                        if (emailEl.tagName === 'INPUT') emailEl.value = userData.email || 'admin@catswell.com';
                        else emailEl.textContent = userData.email || 'admin@catswell.com';
                    }
                    if (firstnameEl) {
                        if (firstnameEl.tagName === 'INPUT') firstnameEl.value = userData.first_name || '';
                        else firstnameEl.textContent = userData.first_name || 'Not provided';
                    }
                    if (lastnameEl) {
                        if (lastnameEl.tagName === 'INPUT') lastnameEl.value = userData.last_name || '';
                        else lastnameEl.textContent = userData.last_name || 'Not provided';
                    }
                    if (phoneEl) {
                        if (phoneEl.tagName === 'INPUT') phoneEl.value = userData.phone_number || '';
                        else phoneEl.textContent = userData.phone_number || 'Not provided';
                    }
                    if (addressEl) {
                        const addressValue = userData.address || '';
                        if (addressEl.tagName === 'INPUT') {
                            addressEl.value = addressValue;
                        } else {
                            addressEl.textContent = addressValue || 'Not provided';
                        }
                    }
                    if (roleEl) {
                        const roleValue = userData.role || 'admin';
                        if (roleEl.tagName === 'INPUT') roleEl.value = roleValue;
                        else roleEl.textContent = roleValue;
                    }
                    
                    // Update profile photo if available
                    const profilePhotoEl = document.getElementById('admin-profile-photo');
                    if (profilePhotoEl && userData.profile_photo && !userData.profile_photo.includes('data:image/svg+xml')) {
                        profilePhotoEl.src = userData.profile_photo;
                    }
                } else {
                    // Show default values
                    const emailEl = document.getElementById('admin-profile-email');
                    if (emailEl) emailEl.textContent = 'admin@catswell.com';
                }
            } catch (error) {
                console.error('Error loading admin profile data:', error);
                
                // Show default values on error
                const emailEl = document.getElementById('admin-profile-email');
                if (emailEl) emailEl.textContent = 'admin@catswell.com';
            }
        }

        // Admin Profile Editing Functions
        window.editAdminProfile = () => {
            // Toggle edit mode
            const isEditing = document.querySelector('#admin-profile-sidebar-body .profile-field input');
            
            if (isEditing) {
                // Currently editing - save changes
                saveAdminProfileChanges();
            } else {
                // Not editing - enter edit mode
                enterAdminEditMode();
            }
        };

        window.enterAdminEditMode = () => {
            // Convert all profile fields to input fields (except status which is read-only)
            const fields = ['admin-profile-email', 'admin-profile-firstname', 'admin-profile-lastname', 'admin-profile-phone', 'admin-profile-address', 'admin-profile-role'];
            
            fields.forEach(fieldId => {
                const span = document.getElementById(fieldId);
                if (span) {
                    let value = span.textContent;
                    // Handle special cases for different fields
                    if (value === 'Not provided') {
                        value = '';
                    } else if (fieldId === 'admin-profile-role' && !value) {
                        value = 'admin'; // Default role if empty
                    }
                    const input = document.createElement('input');
                    const fieldName = fieldId.replace('admin-profile-', '');
                    
                    // Set input type based on field
                    if (fieldName === 'email') {
                        input.type = 'email';
                    } else if (fieldName === 'phone') {
                        input.type = 'tel';
                    } else {
                        input.type = 'text';
                    }
                    
                    input.value = value;
                    input.style.cssText = 'width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;';
                    input.name = fieldName;
                    
                    // Set appropriate autocomplete values
                    switch(fieldName) {
                        case 'firstname':
                            input.autocomplete = 'given-name';
                            break;
                        case 'lastname':
                            input.autocomplete = 'family-name';
                            break;
                        case 'email':
                            input.autocomplete = 'email';
                            break;
                        case 'phone':
                            input.autocomplete = 'tel';
                            // Add number-only validation for phone field
                            input.addEventListener('input', function(e) {
                                let value = e.target.value;
                                if (value.startsWith('+')) {
                                    value = '+' + value.slice(1).replace(/[^0-9]/g, '');
                                } else {
                                    value = value.replace(/[^0-9]/g, '');
                                }
                                e.target.value = value;
                            });
                            break;
                        case 'address':
                            input.autocomplete = 'street-address';
                            break;
                        default:
                            input.autocomplete = 'off';
                    }
                    
                    span.parentNode.replaceChild(input, span);
                    input.id = fieldId;
                }
            });

            // Update button text and show cancel button
            const editBtn = document.getElementById('admin-btn-edit-profile');
            const cancelBtn = document.getElementById('admin-btn-cancel-edit');
            const photoActions = document.getElementById('admin-profile-photo-actions');
            
            if (editBtn) {
                editBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
            }
            if (cancelBtn) {
                cancelBtn.style.display = 'flex';
            }
            if (photoActions) {
                photoActions.style.display = 'flex';
            }
        };

        window.saveAdminProfileChanges = async () => {
            try {
                // Get values from input fields
                const emailEl = document.getElementById('admin-profile-email');
                const firstnameEl = document.getElementById('admin-profile-firstname');
                const lastnameEl = document.getElementById('admin-profile-lastname');
                const phoneEl = document.getElementById('admin-profile-phone');
                const addressEl = document.getElementById('admin-profile-address');
                const roleEl = document.getElementById('admin-profile-role');
                
                const email = emailEl ? (emailEl.tagName === 'INPUT' ? emailEl.value : emailEl.textContent) : '';
                const firstName = firstnameEl ? (firstnameEl.tagName === 'INPUT' ? firstnameEl.value : firstnameEl.textContent) : '';
                const lastName = lastnameEl ? (lastnameEl.tagName === 'INPUT' ? lastnameEl.value : lastnameEl.textContent) : '';
                const phone = phoneEl ? (phoneEl.tagName === 'INPUT' ? phoneEl.value : phoneEl.textContent) : '';
                const address = addressEl ? (addressEl.tagName === 'INPUT' ? addressEl.value : addressEl.textContent) : '';
                let role = '';
                if (roleEl) {
                    if (roleEl.tagName === 'INPUT') {
                        role = roleEl.value.trim();
                    } else {
                        role = roleEl.textContent.trim();
                    }
                }
                
                // If role is empty, default to 'admin'
                if (!role) {
                    role = 'admin';
                    console.warn('Role was empty, defaulting to "admin"');
                }

                // Debug logging
                console.log('Saving profile with data:', {
                    email,
                    firstName,
                    lastName,
                    phone,
                    address,
                    role,
                    roleElement: roleEl ? { tagName: roleEl.tagName, value: roleEl.value, textContent: roleEl.textContent } : 'not found'
                });

                // Save to database
                const formData = new FormData();
                formData.append('action', 'update_profile');
                formData.append('email', email);
                formData.append('first_name', firstName);
                formData.append('last_name', lastName);
                formData.append('phone', phone);
                formData.append('address', address);
                formData.append('role', role);

                const response = await fetch('auth.php', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                console.log('Update profile response:', result);

                if (result.success) {
                    // Exit edit mode first
                    exitAdminEditMode();
                    
                    // Wait a bit for DOM to update
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    // Reload profile data to show updated values
                    await loadAdminProfileData();
                    
                    // Force a refresh of the displayed values immediately
                    const roleEl = document.getElementById('admin-profile-role');
                    const addressEl = document.getElementById('admin-profile-address');
                    const phoneEl = document.getElementById('admin-profile-phone');
                    
                    console.log('Updating display with:', {
                        updated_role: result.updated_role,
                        updated_address: result.updated_address,
                        updated_phone: result.updated_phone
                    });
                    
                    if (roleEl) {
                        // Prioritize the sent role value since we know what we tried to save
                        let roleValue = role; // Use the role we sent
                        
                        // If server returned a different value, prefer that (it's what's actually in the database)
                        if (result.updated_role && result.updated_role !== '' && result.updated_role !== 'admin') {
                            roleValue = result.updated_role;
                        } else if (result.sent_role && result.sent_role !== 'admin') {
                            roleValue = result.sent_role;
                        } else if (result.updated_role && result.updated_role !== '') {
                            roleValue = result.updated_role;
                        }
                        
                        // Only default to 'admin' if we have absolutely no value
                        if (!roleValue || roleValue.trim() === '') {
                            roleValue = 'admin';
                        }
                        
                        roleEl.textContent = roleValue.trim();
                        console.log('Role display update:', {
                            sent: role,
                            server_updated_role: result.updated_role,
                            server_sent_role: result.sent_role,
                            final_display: roleValue
                        });
                    }
                    if (addressEl) {
                        const addressValue = result.updated_address !== undefined ? result.updated_address : result.address || '';
                        addressEl.textContent = addressValue || 'Not provided';
                        console.log('Address updated to:', addressValue || 'Not provided');
                    }
                    if (phoneEl && result.updated_phone !== undefined) {
                        phoneEl.textContent = result.updated_phone || 'Not provided';
                    }

                    alert(' Profile updated successfully!');
                } else {
                    alert(' Error updating profile: ' + result.message);
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                alert(' Error updating profile. Please try again.');
            }
        };

        window.exitAdminEditMode = () => {
            // Convert all input fields back to span elements
            const fields = ['admin-profile-email', 'admin-profile-firstname', 'admin-profile-lastname', 'admin-profile-phone', 'admin-profile-address', 'admin-profile-role'];
            
            fields.forEach(fieldId => {
                const input = document.getElementById(fieldId);
                if (input && input.tagName === 'INPUT') {
                    let value = input.value;
                    // Handle special cases
                    if (!value) {
                        if (fieldId === 'admin-profile-role') {
                            value = 'admin'; // Default role
                        } else {
                            value = 'Not provided';
                        }
                    }
                    const span = document.createElement('span');
                    span.textContent = value;
                    span.id = fieldId;
                    input.parentNode.replaceChild(span, input);
                }
            });

            // Update button text and hide cancel button
            const editBtn = document.getElementById('admin-btn-edit-profile');
            const cancelBtn = document.getElementById('admin-btn-cancel-edit');
            const photoActions = document.getElementById('admin-profile-photo-actions');
            
            if (editBtn) {
                editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit Profile';
            }
            if (cancelBtn) {
                cancelBtn.style.display = 'none';
            }
            if (photoActions) {
                photoActions.style.display = 'none';
            }
            
            // Reload profile data to restore original values from server
            loadAdminProfileData();
        };

        window.cancelAdminEdit = () => {
            // Exit edit mode without saving
            exitAdminEditMode();
        };

        // Admin Profile Photo Upload Function
        window.uploadAdminProfilePhoto = async () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        

                        const formData = new FormData();
                        formData.append('action', 'upload_profile_photo');
                        formData.append('photo', file);

                        const response = await fetch('upload.php', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const responseText = await response.text();
                        let result;
                        try {
                            result = JSON.parse(responseText);
                        } catch (e) {
                            console.error('JSON Parse Error:', responseText);
                            alert(' Server error: Invalid response format');
                            return;
                        }

                        if (result.success) {
                            // Update profile photo display
                            const profilePhotoEl = document.getElementById('admin-profile-photo');
                            if (profilePhotoEl) {
                                profilePhotoEl.src = result.url;
                            }

                            alert(' Profile photo updated successfully!');
                        } else {
                            alert(' Error uploading photo: ' + result.message);
                        }
                    } catch (error) {
                        console.error('Error uploading photo:', error);
                        alert(' Error uploading photo. Please try again.');
                    }
                }
            };
            input.click();
        };

        // Admin Profile Photo Delete Function
        window.deleteAdminProfilePhoto = async () => {
            try {
                // Get current user data to check if there's a profile photo
                const userResponse = await fetch('auth.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'action=get_current_user'
                });
                
                const userResult = await userResponse.json();
                
                if (!userResult.success || !userResult.user) {
                    alert(' Please log in to manage your profile photo.');
                    return;
                }
                
                const currentPhoto = userResult.user.profile_photo;
                
                // Check if user has a profile photo
                if (!currentPhoto || currentPhoto.includes('data:image/svg+xml')) {
                    alert(' No profile photo to delete.');
                    return;
                }
                
                // Extract filename from the full path
                const filename = currentPhoto.split('/').pop();
                
                // Send delete request with just the filename
                const response = await fetch('upload.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'action=delete_file&filepath=' + encodeURIComponent(filename)
                });
                
                const result = await response.json();

                if (result.success) {
                    // Update profile photo display to default
                    const profilePhotoEl = document.getElementById('admin-profile-photo');
                    if (profilePhotoEl) {
                        profilePhotoEl.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMzIiIGZpbGw9IiNGM0Y0RjYiLz4KPHBhdGggZD0iTTMyIDIwQzM2LjQxODMgMjAgNDAgMjMuNTgxNyA0MCAyOEM0MCAzMi40MTgzIDM2LjQxODMgMzYgMzIgMzZDMjcuNTgxNyAzNiAyNCAzMi40MTgzIDI0IDI4QzI0IDIzLjU4MTcgMjcuNTgxNyAyMCAzMiAyMFoiIGZpbGw9IiM5Q0EzQUYiLz4KPHBhdGggZD0iTTE2IDQ4QzE2IDQwLjI2ODcgMjIuMjY4NyAzNCAzMCAzNEgzNEM0MS43MzEzIDM0IDQ4IDQwLjI2ODcgNDggNDhWNDhIMTZaIiBmaWxsPSIjOUNBM0FGIi8+Cjwvc3ZnPgo=';
                    }

                    alert(' Profile photo deleted successfully!');
                } else {
                    alert(' Error deleting photo: ' + result.message);
                }
            } catch (error) {
                console.error('Error deleting photo:', error);
                alert(' Error deleting photo. Please try again.');
            }
        };

        // Admin sign out function
        window.adminSignOut = () => {
            if (confirm('Are you sure you want to sign out?')) {
                // Clear session data
                fetch('auth.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'action=logout'
                }).then(response => {
                    return response.json();
                }).then(data => {
                    // Clear sessionStorage
                    sessionStorage.clear();
                    
                    // Clear any localStorage if needed
                    localStorage.removeItem('user_data');
                    localStorage.removeItem('login_status');
                    
                    // Redirect to admin login page
                    window.location.href = 'admin-login.html';
                }).catch(error => {
                    console.error('Logout error:', error);
                    // Still redirect even if logout request fails
                    sessionStorage.clear();
                    localStorage.removeItem('user_data');
                    localStorage.removeItem('login_status');
                    window.location.href = 'admin-login.html';
                });
            }
        };

        // Close sidebar when clicking overlay or close button
        document.addEventListener('DOMContentLoaded', () => {
            const overlay = document.getElementById('admin-profile-sidebar-overlay');
            const closeBtn = document.getElementById('admin-profile-sidebar-close');
            if (overlay) overlay.addEventListener('click', closeAdminProfileSidebar);
            if (closeBtn) closeBtn.addEventListener('click', closeAdminProfileSidebar);
        });

        // Close notification dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('notificationDropdown');
            const icon = document.querySelector('.notification-icon');
            
            if (dropdown && !dropdown.contains(event.target) && !icon.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });
        
        // Live Chat Functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Chat elements
            const conversationItems = document.querySelectorAll('.conversation-item');
            const chatMessages = document.querySelector('.chat-messages');
            const messageInput = document.querySelector('.message-input');
            const sendBtn = document.querySelector('.send-btn');
            const chatHeader = document.querySelector('.chat-header h3');
            const searchInput = document.querySelector('.standard-search-input');
            
            // Current conversation data
            let currentConversation = null;
            let conversations = [];
            let pollInterval = null;
            let justSentMessage = false;
            
            // Initialize chat
            async function initChat() {
                // Load conversations from server
                await loadConversations();
                
                // Add event listeners
                if (sendBtn) {
                    sendBtn.addEventListener('click', sendMessage);
                }
                if (messageInput) {
                    messageInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            sendMessage();
                        }
                    });
                }
                
                // Search functionality
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        filterConversations(e.target.value);
                    });
                }
                
                // Start polling for new messages
                startPolling();
            }
            
            // Load conversations from server
            async function loadConversations() {
                try {
                    const response = await fetch('chat_api.php?action=get_conversations');
                    const result = await response.json();
                    
                    if (result.success) {
                        conversations = result.conversations;
                        renderConversationList();
                        
                        // Select first conversation if available
                        if (conversations.length > 0) {
                            selectConversation(0);
                        } else {
                            // No conversations - show empty state
                            showEmptyState();
                        }
                    } else {
                        console.error('Failed to load conversations:', result.message);
                        showEmptyState();
                    }
                } catch (error) {
                    console.error('Error loading conversations:', error);
                }
            }
            
            // Render conversation list
            function renderConversationList() {
                const conversationsList = document.querySelector('.conversations-list');
                conversationsList.innerHTML = '';
                
                if (conversations.length === 0) {
                    conversationsList.innerHTML = `
                        <div class="no-conversations" style="text-align: center; padding: 2rem; color: #718096;">
                            <i class="fas fa-comments" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p>No conversations yet</p>
                            <p style="font-size: 0.8rem;">Messages from users will appear here</p>
                        </div>
                    `;
                    return;
                }
                
                conversations.forEach((conversation, index) => {
                    const conversationDiv = document.createElement('div');
                    conversationDiv.className = 'conversation-item';
                    if (index === 0) {
                        conversationDiv.classList.add('active');
                        // Apply active styles immediately for first item
                        conversationDiv.style.transform = 'translateX(2px)';
                        conversationDiv.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.15)';
                    }
                    
                    conversationDiv.innerHTML = `
                        <div class="conversation-info">
                            <h4>${conversation.user_name} <span style="color: #718096; font-size: 0.8em;">#${conversation.id}</span></h4>
                            <p>${conversation.last_message || 'No messages yet'}</p>
                        </div>
                        <div class="conversation-meta">
                            <span class="time">${conversation.last_message_time || ''}</span>
                            ${conversation.unread_count > 0 ? `<span class="unread-badge">${conversation.unread_count}</span>` : ''}
                        </div>
                        <div class="conversation-actions">
                            <button class="action-btn delete-btn" onclick="event.stopPropagation(); deleteConversation(${conversation.id})" title="Delete This Chat">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    conversationDiv.addEventListener('click', () => {
                        selectConversation(index);
                    });
                    
                    conversationsList.appendChild(conversationDiv);
                });
            }
            
            // Select conversation
            async function selectConversation(index) {
                // Remove active class from all items
                document.querySelectorAll('.conversation-item').forEach(item => {
                    item.classList.remove('active');
                    // Reset any hover effects
                    item.style.transform = '';
                    item.style.boxShadow = '';
                });
                
                // Add active class to selected item
                const selectedItem = document.querySelectorAll('.conversation-item')[index];
                if (selectedItem) {
                    selectedItem.classList.add('active');
                    // Force the active styles to be applied
                    selectedItem.style.transform = 'translateX(2px)';
                    selectedItem.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.15)';
                }
                
                // Load conversation
                currentConversation = conversations[index];
                await loadConversationMessages(currentConversation.id);
                
                // Mark messages as read
                await markMessagesAsRead(currentConversation.id);
                
                // Mark chat notifications as read
                await markChatNotificationsAsRead(currentConversation.id);
                
                // Enable input
                messageInput.disabled = false;
                sendBtn.disabled = false;
                messageInput.placeholder = 'Type your message...';
                
                // Update chat header to show selected conversation
                if (currentConversation) {
                    chatHeader.textContent = currentConversation.user_name;
                }
            }
            
            // Show empty state when no conversations
            function showEmptyState() {
                chatHeader.textContent = 'No conversations';
                chatMessages.innerHTML = `
                    <div class="no-messages" style="text-align: center; padding: 2rem; color: #718096;">
                        <i class="fas fa-comment" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>No conversations yet</p>
                        <p style="font-size: 0.8rem;">Messages from users will appear here</p>
                    </div>
                `;
                
                // Disable input
                messageInput.disabled = true;
                sendBtn.disabled = true;
                messageInput.placeholder = 'No conversation selected';
            }
            
            // Load conversation messages from server
            async function loadConversationMessages(conversationId) {
                try {
                    const response = await fetch(`chat_api.php?action=get_messages&conversation_id=${conversationId}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        chatHeader.textContent = `${currentConversation.user_name} #${currentConversation.id}`;
                        chatMessages.innerHTML = '';
                        
                        if (result.messages.length === 0) {
                            chatMessages.innerHTML = `
                                <div class="no-messages" style="text-align: center; padding: 2rem; color: #718096;">
                                    <i class="fas fa-comment" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                    <p>No messages yet</p>
                                    <p style="font-size: 0.8rem;">Start the conversation!</p>
                                </div>
                            `;
                        } else {
                            result.messages.forEach(message => {
                                // message.created_at is already formatted by PHP, so use it directly
                                addMessageToChat(message.message_text, message.sender_type, message.created_at);
                            });
                        }
                        
                        // Scroll to bottom
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    } else {
                        console.error('Failed to load messages:', result.message);
                    }
                } catch (error) {
                    console.error('Error loading messages:', error);
                }
            }
            
            // Mark messages as read
            async function markMessagesAsRead(conversationId) {
                try {
                    const formData = new FormData();
                    formData.append('action', 'mark_as_read');
                    formData.append('conversation_id', conversationId);
                    formData.append('sender_type', 'user');
                    
                    await fetch('chat_api.php', {
                        method: 'POST',
                        body: formData
                    });
                    
                    // Update local data
                    if (currentConversation) {
                        currentConversation.unread_count = 0;
                        renderConversationList();
                    }
                } catch (error) {
                    console.error('Error marking messages as read:', error);
                }
            }
            
            // Mark chat notifications as read
            async function markChatNotificationsAsRead(conversationId) {
                try {
                    const formData = new FormData();
                    formData.append('action', 'mark_chat_notifications_as_read');
                    formData.append('conversation_id', conversationId);
                    
                    await fetch('notifications.php', {
                        method: 'POST',
                        body: formData
                    });
                    
                    // Refresh notifications to update the badge count
                    loadNotifications();
                } catch (error) {
                    console.error('Error marking chat notifications as read:', error);
                }
            }
            
            // Add message to chat
            function addMessageToChat(text, type, time) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}-message`;
                
                messageDiv.innerHTML = `
                    <p>${text}</p>
                    <span class="message-time">${time}</span>
                `;
                
                // Add click functionality to focus input
                messageDiv.addEventListener('click', () => {
                    if (messageInput && !messageInput.disabled) {
                        messageInput.focus();
                        // Add a subtle highlight to show the input is ready
                        messageInput.style.borderColor = '#4299e1';
                        setTimeout(() => {
                            messageInput.style.borderColor = '#e2e8f0';
                        }, 1000);
                    }
                });
                
                chatMessages.appendChild(messageDiv);
            }
            
            // Send message
            async function sendMessage() {
                const messageText = messageInput.value.trim();
                
                if (!messageText) {
                    alert('Please enter a message');
                    return;
                }
                
                if (!currentConversation) {
                    if (conversations.length === 0) {
                        alert('No conversations available. Please refresh the page or wait for users to start chatting.');
                    } else {
                        alert('Please select a conversation first by clicking on it in the left panel.');
                    }
                    return;
                }
                
                // Set flag to prevent message reload
                justSentMessage = true;
                
                // Add message to chat display immediately
                const now = new Date();
                const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                addMessageToChat(messageText, 'admin', timeString);
                
                // Clear input
                messageInput.value = '';
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Send message to server
                try {
                    const formData = new FormData();
                    formData.append('action', 'send_message');
                    formData.append('conversation_id', currentConversation.id);
                    formData.append('sender_type', 'admin');
                    formData.append('message_text', messageText);
                    formData.append('sender_id', 1); // Admin user ID
                    
                    const response = await fetch('chat_api.php', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const responseText = await response.text();
                    
                    let result;
                    try {
                        result = JSON.parse(responseText);
                    } catch (parseError) {
                        throw new Error('Invalid JSON response from server');
                    }
                    
                    if (!result.success) {
                        alert('Failed to send message: ' + result.message);
                        return;
                    }
                } catch (error) {
                    alert('Error sending message: ' + error.message);
                }
            }
            
            // Start polling for new messages
            function startPolling() {
                pollInterval = setInterval(async () => {
                    // Only check for new messages in current conversation and update unread counts
                    await checkForNewMessages();
                }, 3000); // Poll every 3 seconds
            }
            
            // Check for new messages without reloading entire conversation list
            async function checkForNewMessages() {
                try {
                    // Get updated conversation list to check for new conversations and unread counts
                    const response = await fetch('chat_api.php?action=get_conversations');
                    const result = await response.json();
                    
                    if (result.success) {
                        const newConversations = result.conversations;
                        const oldConversationCount = conversations.length;
                        
                        // Check if there are new conversations
                        if (newConversations.length > oldConversationCount) {
                            // New conversation added - reload the list
                            conversations = newConversations;
                            renderConversationList();
                        } else {
                            // No new conversations, just update unread counts and last messages
                            updateConversationData(newConversations);
                        }
                        
                        // If we have a current conversation, check for new messages
                        if (currentConversation && !justSentMessage) {
                            await loadMessagesForCurrentConversation();
                        }
                        
                        // Reset the flag
                        justSentMessage = false;
                    }
                } catch (error) {
                    console.error('Error checking for new messages:', error);
                }
            }
            
            // Update conversation data without re-rendering the entire list
            function updateConversationData(newConversations) {
                let hasChanges = false;
                
                conversations.forEach((oldConv, index) => {
                    const newConv = newConversations.find(c => c.id === oldConv.id);
                    if (newConv) {
                        // Check if unread count or last message changed
                        if (oldConv.unread_count !== newConv.unread_count || 
                            oldConv.last_message !== newConv.last_message ||
                            oldConv.last_message_time !== newConv.last_message_time) {
                            
                            // Update the conversation data
                            conversations[index] = newConv;
                            hasChanges = true;
                            
                            // Update the visual indicator in the list
                            updateConversationItem(newConv);
                        }
                    }
                });
            }
            
            // Update a single conversation item in the list
            function updateConversationItem(conversation) {
                const conversationItem = document.querySelector(`[data-conversation-id="${conversation.id}"]`);
                if (conversationItem) {
                    // Update unread count badge
                    const unreadBadge = conversationItem.querySelector('.unread-count');
                    if (conversation.unread_count > 0) {
                        if (unreadBadge) {
                            unreadBadge.textContent = conversation.unread_count;
                        } else {
                            // Add unread badge if it doesn't exist
                            const badge = document.createElement('span');
                            badge.className = 'unread-count';
                            badge.textContent = conversation.unread_count;
                            conversationItem.appendChild(badge);
                        }
                    } else if (unreadBadge) {
                        unreadBadge.remove();
                    }
                    
                    // Update last message preview
                    const lastMessageEl = conversationItem.querySelector('.last-message');
                    if (lastMessageEl && conversation.last_message) {
                        lastMessageEl.textContent = conversation.last_message;
                    }
                    
                    // Update timestamp
                    const timeEl = conversationItem.querySelector('.conversation-time');
                    if (timeEl && conversation.last_message_time) {
                        timeEl.textContent = formatTime(conversation.last_message_time);
                    }
                }
            }
            
            // Load messages for current conversation only
            async function loadMessagesForCurrentConversation() {
                if (!currentConversation) return;
                
                try {
                    const response = await fetch(`chat_api.php?action=get_messages&conversation_id=${currentConversation.id}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        const currentMessageCount = document.querySelectorAll('.message').length;
                        
                        // Only add new messages if there are more than what we currently have
                        if (result.messages.length > currentMessageCount) {
                            const newMessages = result.messages.slice(currentMessageCount);
                            
                            newMessages.forEach(msg => {
                                // msg.created_at is already formatted by PHP, so use it directly
                                addMessageToChat(msg.message_text, msg.sender_type, msg.created_at);
                            });
                            
                            // Scroll to bottom
                            const chatMessages = document.querySelector('.chat-messages');
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }
                    }
                } catch (error) {
                    console.error('Error loading messages for current conversation:', error);
                }
            }
            
            // Stop polling
            function stopPolling() {
                if (pollInterval) {
                    clearInterval(pollInterval);
                    pollInterval = null;
                }
            }
            
            // Filter conversations
            function filterConversations(searchTerm) {
                const term = searchTerm.toLowerCase();
                
                document.querySelectorAll('.conversation-item').forEach((item, index) => {
                    if (index < conversations.length) {
                        const conversation = conversations[index];
                        const name = conversation.user_name.toLowerCase();
                        const lastMessage = (conversation.last_message || '').toLowerCase();
                        
                        if (name.includes(term) || lastMessage.includes(term)) {
                            item.style.display = 'block';
                        } else {
                            item.style.display = 'none';
                        }
                    }
                });
            }
            
            // Initialize chat when page loads
            initChat();
        });

        // Global chat functions (accessible from HTML onclick handlers)
        async function deleteConversation(conversationId) {
            if (!confirm('Are you sure you want to delete this specific chat conversation?\n\nThis will permanently remove:\n This conversation\n All messages in this conversation\n Related notifications\n\nThis action cannot be undone.')) {
                return;
            }

            try {
                const formData = new FormData();
                formData.append('action', 'delete_conversation');
                formData.append('conversation_id', conversationId);

                const response = await fetch('chat_api.php', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('success', 'Chat Deleted', 'This chat conversation has been deleted successfully');
                    // Store the current tab state and reload
                    localStorage.setItem('adminActiveTab', 'chat');
                    window.location.reload();
                } else {
                    showNotification('error', 'Delete Failed', result.message || 'Failed to delete conversation');
                }
            } catch (error) {
                console.error('Error deleting conversation:', error);
                showNotification('error', 'Delete Error', 'Error deleting conversation. Please try again.');
            }
        }

        async function clearAllConversations() {
            if (!confirm(' WARNING: This will delete ALL chat conversations permanently!\n\nThis action cannot be undone and will remove:\n All conversations\n All messages\n All chat notifications\n\nAre you absolutely sure you want to proceed?')) {
                return;
            }

            // Double confirmation for safety
            if (!confirm(' FINAL CONFIRMATION \n\nYou are about to delete ALL chat conversations!\n\nThis is your last chance to cancel.\n\nClick OK to proceed with deletion.')) {
                return;
            }

            try {
                const formData = new FormData();
                formData.append('action', 'delete_all_conversations');

                const response = await fetch('chat_api.php', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('success', 'All Chats Deleted', 'All chat conversations have been deleted successfully');
                    // Store the current tab state and reload
                    localStorage.setItem('adminActiveTab', 'chat');
                    window.location.reload();
                } else {
                    showNotification('error', 'Delete All Failed', result.message || 'Failed to delete all conversations');
                }
            } catch (error) {
                console.error('Error deleting all conversations:', error);
                showNotification('error', 'Delete All Error', 'Error deleting all conversations. Please try again.');
            }
        }

        // Fix switchToTab function reference
        function switchToTab(tabId) {
            // Find the tab element and click it
            const tabElement = document.querySelector(`[onclick*="switchToTab('${tabId}')"]`);
            if (tabElement) {
                tabElement.click();
            } else {
                // Fallback: try to find by data attribute or class
                const fallbackTab = document.querySelector(`[data-tab="${tabId}"]`) || 
                                  document.querySelector(`#${tabId}`) ||
                                  document.querySelector(`.${tabId}`);
                if (fallbackTab) {
                    fallbackTab.click();
                }
            }
        }
    </script>
</body>
</html>